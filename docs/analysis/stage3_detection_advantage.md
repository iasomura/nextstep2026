# Stage3 検知優位性分析

## 概要

全件評価（11,952件）に基づく、Stage3（LLM + Rule Engine）のStage1（XGBoost）に対する検知優位性を分析した結果をまとめる。

- **評価ID**: eval_20260205_230157
- **RUN_ID**: 2026-02-02_224105
- **総ドメイン数**: 11,952件（ハンドオフ候補全件）
- **GPU**: 3台並列（Port 8000, 8001, 8002）
- **分析日**: 2026-02-06

---

## 1. 全件評価結果

### 1.1 Stage3 vs Stage1 性能比較

| 指標 | Stage3 | Stage1 | 差分 |
|------|--------|--------|------|
| TP | 1,686 | 1,399 | +287 |
| FP | 532 | 319 | +213 |
| FN | 759 | 1,046 | -287 |
| TN | 8,975 | 9,188 | -213 |
| **Precision** | **76.01%** | **81.43%** | **-5.42pp** |
| **Recall** | **68.96%** | **57.22%** | **+11.74pp** |
| **F1** | **72.31%** | **67.21%** | **+5.10pp** |

### 1.2 要約

- F1スコアで **+5.10pp** の改善を達成
- Recallが **+11.74pp** 向上し、見逃し（FN）を287件削減
- Precisionは **-5.42pp** 低下（FPが213件増加）したが、F1全体では改善

---

## 2. Stage3だけが検知できたPhishing: 327件

Stage1がBenign（FN）と判定し、Stage3がPhishing（TP）と正しく判定した327件を分析した。

### 2.1 MLスコア分布

| MLスコア範囲 | 件数 | 割合 | 意味 |
|-------------|------|------|------|
| ML < 0.3 | 175 | 54% | Stage1が明確にBenignと判定する領域 |
| ML 0.3 - 0.5 | 152 | 46% | Stage1のBenign境界域 |

327件の過半数（54%）が ML < 0.3 であり、Stage1の閾値（0.5）から大きく離れている。これらはMLスコアのみでは原理的に検知が困難なドメインである。

---

## 3. 検知パターン分析

### 3.1 DV/Free CA証明書問題（295件）

MLモデルは証明書品質（DV証明書、無料CA）を十分に重視しない。Stage3のルールエンジンは証明書情報を独立した判定軸として評価し、MLスコアが低くても証明書品質の問題を検出できる。

### 3.2 危険TLD検出（223件）

MLスコアが低い場合、危険TLDであっても Stage1 は見逃す。Stage3 は TLD を独立したリスク要因として評価する。

**TLD分布**:

| TLD | 件数 |
|-----|------|
| cn | 58 |
| top | 53 |
| lat | 23 |
| icu | 16 |
| xyz | 16 |
| cc | 15 |
| com | 14 |
| online | 8 |

### 3.3 ML Paradox（98件）

MLスコアが低いにもかかわらず、コンテキストスコアが高いケース。MLスコアのみで判断するStage1では検知不可能である。

**代表例**:

| ドメイン | MLスコア |
|---------|---------|
| bceseomvsr.icu | 0.045 |
| ifwdzanz.top | 0.108 |
| resonaak.com | 0.167 |

### 3.4 ブランド偽装 + 低品質証明書（78件）

ブランド偽装はドメイン名の文字列類似性だけでは捉えきれず、証明書情報との複合判定が必要となる。XGBoostの個別特徴量ベースの判定では、この組み合わせ条件を十分に表現できない。

**代表例**:

| ドメイン | MLスコア |
|---------|---------|
| ulys-support.com | 0.167 |
| mercarig.com | 0.395 |
| resonaak.com | 0.167 |

---

## 4. ルール発動ランキング

Stage3だけがTPとした327件におけるルール発動状況。

### 4.1 発動ルール（判定に寄与したルール）

| ルール | 発動件数 |
|--------|---------|
| policy_r4 | 142 |
| policy_r2 | 100 |
| soft_ctx_trigger | 87 |
| policy_r5 | 79 |
| policy_r1 | 77 |
| policy_r6 | 64 |
| brand_cert_high | 52 |
| policy_r3 | 42 |
| hard_ctx_trigger | 16 |
| high_ml_ctx_rescue | 6 |

### 4.2 リスク要因ランキング

| リスク要因 | 検出件数 |
|-----------|---------|
| policy_r4 | 279 |
| policy_r5 | 213 |
| free_ca_no_org | 167 |
| policy_r2 | 165 |
| dangerous_tld | 158 |
| dv_weak_identity | 145 |
| policy_r6 | 127 |
| policy_r1 | 106 |
| benign_cert_gate_skip | 100 |
| soft_ctx_trigger | 87 |
| short_term | 85 |
| policy_r3 | 81 |
| brand_cert_high | 78 |
| ml_paradox | 71 |
| dangerous_tld_combo | 54 |

---

## 5. 本質的な違い（論文記載用）

### 5.1 Stage1（XGBoost）の判定構造

```
f(特徴量ベクトル) → 1つのスコア → 閾値判定 (>= 0.5)
```

- 特徴量の重み付き加算（ツリーアンサンブル）による判定
- 個別特徴量の複雑な組み合わせ条件を表現しにくい
- MLスコアが閾値未満であれば、他にどのようなリスク要因があっても検知できない

### 5.2 Stage3（LLM + Rule Engine）の判定構造

```
LLM(特徴量 + ツール結果 + 文脈推論)
  + ルールエンジン(ML × cert × ctx × brand × TLD の複合条件)
  → 多角的判定
```

- 「MLスコアが低くても、DV証明書 + 危険TLD + ブランド偽装があればPhishing」という**条件付き推論**が可能
- これはXGBoostの線形/ツリー構造では捉えにくい**非線形な組み合わせ条件**
- ルールエンジンにより、ドメイン知識を明示的に組み込める

### 5.3 検知優位性の本質

Stage3の検知優位性は、以下の3点に集約される:

1. **多軸判定**: MLスコア単独ではなく、証明書・TLD・ブランド・コンテキストを独立した判定軸として評価
2. **条件付き推論**: 複数のリスク要因の組み合わせによる判定（ML低 + DV証明書 + 危険TLD → Phishing）
3. **ドメイン知識の明示的統合**: ルールエンジンにより、セキュリティ専門家の知見をルールとして直接組み込み

---

## 6. brand_cert_high ML閾値追加の効果

### 6.1 変更内容

BrandCertHighRule に `ml_threshold=0.12` を追加し、ML < 0.12 の場合に brand_cert_high ルールの発動を抑制する。

### 6.2 効果

| 指標 | 結果 |
|------|------|
| ML < 0.12 + brand_cert_high 発動 | 0件（抑制成功） |
| brand_cert_high 全体発動数 | 311件 |
| brand_cert_high Precision | 80.4% |

ML閾値の追加により、極端に低いMLスコアでの誤検知を防ぎつつ、brand_cert_high ルール全体の精度を維持している。

---

## 7. まとめ

| 観点 | Stage1 | Stage3 | 改善効果 |
|------|--------|--------|---------|
| F1 | 67.21% | 72.31% | +5.10pp |
| Recall | 57.22% | 68.96% | +11.74pp |
| Precision | 81.43% | 76.01% | -5.42pp |
| FN（見逃し） | 1,046 | 759 | -287件 |
| Stage3固有検知 | - | 327件 | ML < 0.3が54% |

Stage3は、MLスコアだけでは検知できないフィッシングドメイン327件を追加で検知し、Recallを11.74pp改善した。Precisionの低下（5.42pp）はあるものの、F1スコアで5.10ppの改善を達成しており、ルールエンジンによる多角的判定の有効性が確認された。

---

## 8. Stage3の存在意義

### 8.1 3段階パイプラインにおける処理対象

全127,222件のドメインに対する各Stageの処理分担：

| Stage | 処理件数 | 割合 | 役割 |
|-------|---------|------|------|
| Stage1確定 | 69,231 | 54.4% | ML高確信で自動判定（auto_phishing / auto_benign） |
| Stage2フィルタ | 46,039 | 36.2% | 証明書ベースでBenign確定（drop_to_auto） |
| **Stage3** | **11,952** | **9.4%** | **判断困難な境界域を精査** |

Stage3は全体のわずか **9.4%** の判断困難ドメインのみを処理する。Stage1・Stage2で確信を持って判定できないドメインが対象であり、これらはMLスコアが閾値付近にあるため、単純な閾値判定では正確な分類が困難である。

### 8.2 Stage3対象ドメインのラベル分布

| ラベル | 件数 | 割合 |
|--------|------|------|
| Phishing | 2,445 | 20.5% |
| Benign | 9,507 | 79.5% |

Stage3がなければ、handoff対象11,952件は全てBenignとして処理される。その場合、**2,445件のPhishingが見逃される**。

### 8.3 Stage3の救済効果

| 指標 | 値 |
|------|-----|
| Stage3対象のPhishing | 2,445件 |
| Stage3が正しく検知（TP） | 1,686件 |
| Stage3が見逃し（FN） | 759件 |
| **救済率** | **69.0%** |

ソース別の検知率：

| ソース | 検知率 | 件数 |
|--------|--------|------|
| certificates | 79.7% | 550/690 |
| jpcert | 67.0% | 786/1,173 |
| phishtank | 60.1% | 350/582 |

---

## 9. システム全体性能: Stage1+2 vs Stage1+2+3

### 9.1 Stage1+Stage2のみ（Stage3なし）

| 指標 | Baseline | 現在 | 差分 |
|------|----------|------|------|
| Precision | 100.00% | 100.00% | +0.00pp |
| Recall | 94.89% | 95.53% | +0.64pp |
| F1 | 97.38% | 97.71% | +0.33pp |
| FN | 3,265 | 2,846 | -419 |
| FP | 2 | 2 | +0 |

### 9.2 Stage1+Stage2+Stage3（フルシステム）

| 指標 | Baseline | 現在 | 差分 |
|------|----------|------|------|
| **Precision** | 98.19% | **99.15%** | **+0.96pp** |
| **Recall** | 97.77% | **98.18%** | **+0.41pp** |
| **F1** | 97.98% | **98.66%** | **+0.68pp** |
| FP | 1,150 | 534 | **-616** |
| FN | 1,425 | 1,160 | **-265** |

### 9.3 Stage3追加による効果

| 指標 | Baseline時 | 現在 |
|------|-----------|------|
| F1向上 | +0.60pp | **+0.95pp** |
| Recall向上 | +2.88pp | +2.65pp |
| FN削減 | -1,840件 | -1,686件 |

---

## 10. FP/FNトレードオフの分析

### 10.1 Stage3追加によるトレードオフ（現在）

| 項目 | 値 |
|------|-----|
| FN削減（Phishing検知） | -1,686件 |
| FP増加（誤検知） | +532件 |
| **FN:FP比** | **1:0.32** |

**1件のPhishing見逃しを防ぐために、0.32件の誤検知を許容する。**

フィッシング被害のコスト（金銭被害、個人情報漏洩）は誤検知の確認コスト（手動レビュー）を大幅に上回るため、このトレードオフは合理的である。

### 10.2 Baseline → 現在の改善

| 指標 | Baseline | 現在 | 改善 |
|------|----------|------|------|
| Stage3のFP | 1,148 | 532 | **-616件 (-53.7%)** |
| Stage3のFN | 899 | 759 | -140件 (-15.6%) |
| FN:FP比 | 1:0.62 | **1:0.32** | トレードオフ改善 |

BaselineではFN 1件あたり0.62件のFPを伴っていたが、現在は0.32件に改善。Precision向上の主因はルール閾値調整とブランド誤検知対策である。

---

## 11. Stage3の定性的意義

### 11.1 説明可能性

| 項目 | Stage1+2 | Stage1+2+3 |
|------|----------|------------|
| 判定根拠 | MLスコアのみ | 平均6.5個のリスク要因 + 判定文（平均952文字） |
| ブランド偽装検出 | なし | 273/1,686件（16.2%）で検出 |
| 監査対応 | 困難 | risk_factors + reasoning で説明可能 |

Stage3は各判定に対して具体的なリスク要因と自然言語による判定根拠を提供する。これにより、誤検知時の原因特定や、セキュリティ監査への対応が可能となる。

### 11.2 俊敏性

| 観点 | Stage1（ML） | Stage3（ルールエンジン） |
|------|------------|----------------------|
| 新種フィッシング対応 | 再学習が必要（データ収集→学習→評価→デプロイ） | ルール追加で即時対応可能 |
| 閾値調整 | 全体に影響 | ルール単位で個別調整可能 |
| 有効化/無効化 | 不可 | ルール単位で切り替え可能 |

### 11.3 MLが検知不可能な領域

ML < 0.1 でPhishingとして検知: **62件**

これらのドメインはStage1の閾値（0.5）から大きく離れており、MLモデルの再学習なしには原理的に検知不可能である。Stage3のルールエンジンによる条件付き推論（危険TLD + DV証明書 + コンテキストスコア）がこれを補完する。

具体例：

| ドメイン | MLスコア | Stage3検知確信度 | 検知根拠 |
|---------|---------|----------------|---------|
| bceseomvsr.icu | 0.045 | 0.92 | 危険TLD + ランダム文字列 + DV証明書 |
| robiox.pk | 0.033 | 0.75 | ブランド偽装 + 低品質証明書 |
| xiakwtyixdoj.xyz | 0.055 | 0.55 | 危険TLD + 高エントロピー |

---

## 12. 総合まとめ

### 12.1 Stage3の存在意義（論文記載用）

Stage3（LLM + Rule Engine）の存在意義は、以下の4点に集約される：

1. **境界域の精査**: 全ドメインの9.4%のML判断困難ドメインに対し、救済率69.0%でPhishingを検知
2. **FN大幅削減**: Stage3追加により1,686件のFNを削減し、システム全体のRecallを2.65pp向上
3. **説明可能性**: 各判定に平均6.5個のリスク要因と自然言語の判定根拠を付与
4. **俊敏な対応**: ルール単位の追加・調整により、ML再学習なしで新種フィッシングに即時対応可能

### 12.2 性能改善の推移

| 構成 | Precision | Recall | F1 |
|------|-----------|--------|-----|
| Stage1+2のみ（Baseline） | 100.00% | 94.89% | 97.38% |
| Stage1+2のみ（現在） | 100.00% | 95.53% | 97.71% |
| Stage1+2+3（Baseline） | 98.19% | 97.77% | 97.98% |
| **Stage1+2+3（現在）** | **99.15%** | **98.18%** | **98.66%** |

### 12.3 合理的なトレードオフ

Stage3の追加はFPを532件増加させるが、FNを1,686件削減する（FN:FP比 = 1:0.32）。フィッシング検知においては見逃し（FN）のコストが誤検知（FP）のコストを大幅に上回るため、Stage3の追加は合理的な判断である。
