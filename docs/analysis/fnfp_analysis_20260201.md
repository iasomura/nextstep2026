# FN/FP分析レポート

**評価日**: 2026年2月1日
**対象データ**: handoff候補 15,630件（Stage3評価結果）

---

## 1. 概要

| 指標 | 件数 | 割合 |
|------|------|------|
| Total FN (見逃し) | 945 | 6.0% |
| Total FP (誤検出) | 665 | 4.3% |

---

## 2. FN分析（945件 - フィッシング見逃し）

### 2.1 カテゴリ分類

| カテゴリ | 件数 | 割合 | 評価 |
|----------|------|------|------|
| 極低シグナル (ML<0.1, CTX<0.15) | 361 | 38.2% | **回避困難** |
| POST_LLM_FLIP_GATE による抑制 | 111 | 11.7% | チューニング可能 |
| 中程度CTX (>=0.4) | 225 | 23.8% | 要調査 |
| その他 | 248 | 26.2% | 混在 |

### 2.2 カテゴリ別詳細

#### (A) 極低シグナル（361件, 38%）- **回避困難**

**特徴**:
- ML確率: 0.03-0.09（XGBoostがbenignと高確信）
- CTXスコア: 0.05-0.15（文脈的リスク指標なし）
- ブランド検出: なし
- ルール発火: なし

**代表例**:
| ドメイン | ML | CTX | 説明 |
|----------|-----|-----|------|
| therapyaoyama.com | 0.033 | 0.061 | 正規のセラピーサイトに見える |
| rsacouriers.com | 0.036 | 0.051 | 宅配サービスに見える |
| capitalprowealthonline.com | 0.041 | 0.053 | 金融サービスに見える |
| marwawater.com | 0.061 | 0.062 | 水関連ビジネスに見える |

**考察**:
- これらは**完全に正規サイトに偽装したフィッシング**
- ドメイン名、証明書、サイト構造すべてが正規に見える
- 外部脅威インテリジェンス（ブラックリスト、レピュテーション）なしでは検出不可能
- **許容すべき限界**: 証明書情報のみでの検出は原理的に困難

#### (B) POST_LLM_FLIP_GATE による抑制（111件, 12%）- **チューニング可能**

**特徴**:
- CTXスコア: 0.43-0.57（中程度のリスク指標あり）
- LLMが "medium-high" と判定したが、GATEで抑制
- ML確率は低い（0.01-0.26）

**代表例**:
| ドメイン | ML | CTX | リスクレベル |
|----------|-----|-----|------------|
| contcomexcontabilidade.com.br | 0.041 | 0.497 | medium-high |
| jhxlcc.com | 0.175 | 0.500 | medium-high |
| report-livraison.com | 0.264 | 0.497 | medium-high |

**考察**:
- LLMは正しく "medium-high" と判定している
- POST_LLM_FLIP_GATE の閾値（0.30）が保守的すぎる可能性
- **改善可能**: GATE閾値の調整で一部救済可能（ただしFP増加リスクあり）

#### (C) 中程度CTX（225件, 24%）- **要調査**

**特徴**:
- CTXスコア >= 0.4 だがPOST_LLM_FLIP_GATEは発火せず
- LLMが "low" または "medium" と判定

**考察**:
- CTXスコアが高いのにLLMが低リスクと判定するミスマッチ
- LLMの判断ロジックの改善余地あり

---

## 3. FP分析（665件 - 誤検出）

### 3.1 カテゴリ分類

| カテゴリ | 件数 | 割合 | 評価 |
|----------|------|------|------|
| ブランド誤検出 | 220 | 33.1% | **チューニング可能** |
| 高MLスコア (>=0.7) | 104 | 15.6% | モデル限界 |
| その他（TLD・ポリシー起因） | 341 | 51.3% | 混在 |

### 3.2 カテゴリ別詳細

#### (A) ブランド誤検出（220件, 33%）- **チューニング可能**

**マッチタイプ別内訳**:
| マッチタイプ | 件数 | 問題 |
|-------------|------|------|
| fuzzy | 107 | 類似文字列の過剰マッチ |
| fuzzy2 | 92 | 2文字以上の差異許容 |
| compound | 60 | 複合語の誤マッチ |
| substring | 50 | 部分文字列の誤マッチ |

**代表的な誤検出パターン**:
| ドメイン | 検出ブランド | 問題 |
|----------|------------|------|
| dance-forums.com | danske (fuzzy2) | "dance" と "danske" の誤マッチ |
| jaymeshop.com | eshop (substring) | "shop" を含むドメイン全般 |
| globalciti-zen.com | citi (compound) | "citizen" の一部 |
| india-e-visas.com | visa (substring) | ビザ関連正規サービス |
| target.com.au | target | オーストラリアのTarget（正規） |

**改善案**:
1. fuzzy/fuzzy2 マッチの閾値厳格化
2. ホワイトリスト追加（正規ショップドメインなど）
3. ブランド検出後の追加検証ロジック

#### (B) 高MLスコア（104件, 16%）- **モデル限界**

**特徴**:
- ML確率 >= 0.7 でXGBoostがフィッシングと判定
- 実際は正規サイト

**代表例**:
| ドメイン | ML | 説明 |
|----------|-----|------|
| sophos.com | 0.817 | セキュリティ企業（正規） |
| slackhq.com | 0.709 | Slack公式（正規） |
| hubspot.com | 0.891 | マーケティングツール（正規） |
| gov.scot | 0.953 | スコットランド政府（正規） |
| envato.com | 0.896 | デザインマーケット（正規） |

**考察**:
- XGBoostモデルの学習データに含まれていない新しいパターン
- 短いドメイン、特殊TLD、新しいサービスが誤判定されやすい
- **モデル再学習**または**ホワイトリスト**で対応可能

#### (C) TLD・ポリシー起因（341件, 51%）- **混在**

**主な発火ルール**:
| ルール | 発火数 | 説明 |
|--------|--------|------|
| policy_r4 | 237 | CTX 0.35-0.50 での判定 |
| policy_r5 | 209 | CTX + 追加条件 |
| ml_no_mitigation_gate | 90 | ML高スコア + 緩和なし |
| soft_ctx_trigger | 58 | CTX >= 0.50 |

**代表的なTLD**:
- `.online`, `.xyz`, `.top`, `.icu`, `.buzz`, `.cyou`, `.live`, `.shop`
- これらのTLDは正規サービスでも使用されるが、フィッシングでも多用

**代表例**:
| ドメイン | ML | CTX | TLD | 実態 |
|----------|-----|-----|-----|------|
| datasydney.icu | 0.013 | 0.453 | icu | ギャンブル系？ |
| cheapflights.com | 0.392 | 0.450 | com | 正規の航空券比較サイト |
| xhtml.com | 0.436 | 0.500 | com | Web技術情報サイト |

---

## 4. 総合評価

### 4.1 改善可能な領域

| 領域 | 対象件数 | 改善方法 | 期待効果 |
|------|---------|---------|---------|
| ブランド誤検出 | 220 FP | fuzzy閾値厳格化 | FP -100〜150件 |
| POST_LLM_FLIP_GATE | 111 FN | 閾値調整 | FN -50〜80件 |
| 高MLホワイトリスト | 104 FP | 既知サービス除外 | FP -50〜80件 |

### 4.2 許容すべき限界

| 領域 | 対象件数 | 理由 |
|------|---------|------|
| 極低シグナルFN | 361 | 外部インテリジェンスなしでは検出不可能 |
| TLD起因FP | 100〜150 | 正規/フィッシング両方で使用されるTLD |

### 4.3 結論

**現状の精度（F1: 68.87%）は以下の理由で妥当**:

1. **FNの38%（361件）は原理的に検出困難**
   - 証明書情報のみでは、完全偽装サイトの検出は不可能
   - 外部脅威インテリジェンスの導入が必要

2. **FPの33%（220件）はチューニングで改善可能**
   - ブランド検出ロジックの精度向上余地あり
   - 短期的な改善ターゲット

3. **ルールチューニングで10-15%の改善余地**
   - POST_LLM_FLIP_GATE、ブランドマッチ閾値の調整
   - ホワイトリスト追加

---

## 5. 推奨アクション

### 短期（〜2週間）

1. **ブランド検出閾値の調整**
   - fuzzy/fuzzy2 の類似度閾値を厳格化
   - substring マッチのホワイトリスト追加

2. **POST_LLM_FLIP_GATE の閾値検討**
   - 現状: 0.30
   - 候補: 0.35〜0.40（FP増加リスクとのトレードオフ）

### 中期（〜1ヶ月）

3. **高MLスコア正規サイトのホワイトリスト**
   - 既知の大手サービスを除外リストに追加

4. **TLD別ポリシーの精緻化**
   - `.online`, `.shop` 等のTLD別閾値調整

---

## 6. TP/TN分析（トレードオフ評価）

### 6.1 全カテゴリの特性比較

| Category | Count | ML Mean | ML >= 0.5 | CTX Mean | CTX >= 0.4 |
|----------|-------|---------|-----------|----------|------------|
| **TP** | 1,781 | 0.719 | 81.0% | 0.512 | 95.1% |
| **FP** | 665 | 0.314 | 30.4% | 0.435 | 60.2% |
| **TN** | 12,239 | 0.085 | 0.9% | 0.131 | 13.9% |
| **FN** | 945 | 0.191 | 7.4% | 0.256 | 35.6% |

**考察**:
- TP: ML高スコア + CTX高スコアの組み合わせ
- FP: ML低〜中だがCTXがやや高い（誤検出の原因）
- TN: ML低 + CTX低で正しくbenign判定
- FN: ML低 + CTX低〜中で見逃し

### 6.2 ルール別TP/FP比較

| Rule | TP発火 | FP発火 | TP/FP比 | 評価 |
|------|--------|--------|---------|------|
| very_high_ml_override | 804 | 37 | **21.7** | 優良 |
| high_ml_override | 852 | 61 | **14.0** | 優良 |
| ml_no_mitigation_gate | 1,384 | 199 | **7.0** | 優良 |
| soft_ctx_trigger | 292 | 106 | 2.8 | 良好 |
| hard_ctx_trigger | 19 | 16 | 1.2 | 要注意 |
| policy_r5 | 234 | 217 | 1.1 | 要注意 |
| brand_cert_high | 228 | 218 | **1.0** | 要注意 |
| benign_cert_gate_skip | 228 | 219 | **1.0** | 要注意 |
| policy_r4 | 304 | 432 | **0.7** | 問題あり |

### 6.3 ブランドマッチタイプ別分析

| Match Type | TP | FP | TP/FP比 | 評価 |
|------------|-----|-----|---------|------|
| substring | 90 | 50 | **1.80** | 許容 |
| compound | 68 | 60 | 1.13 | 許容 |
| fuzzy | 72 | 107 | **0.67** | 問題 |
| fuzzy2 | 42 | 92 | **0.46** | 問題 |

**重要な発見**: fuzzy/fuzzy2 マッチは FP > TP であり、削減対象として適切

### 6.4 POST_LLM_FLIP_GATE の役割

| Category | GATE発火数 | 割合 |
|----------|-----------|------|
| TP | 0 | 0.0% |
| FP | 0 | 0.0% |
| **TN** | **1,003** | **8.2%** |
| FN | 111 | 11.7% |

**考察**:
- GATEはTPを阻害していない（TP発火0件）
- GATEは1,003件のTNを保護している
- GATE緩和はFN救済（+111）よりFP増加リスク（+1,003）が大きい

---

## 7. トレードオフシミュレーション

### 7.1 シナリオ1: fuzzy/fuzzy2 ブランドマッチ無効化

| 指標 | 現状 | 変更後 | 差分 |
|------|------|--------|------|
| TP | 1,781 | 1,746 | -35 |
| FP | 665 | 558 | **-107** |
| Precision | 72.81% | 75.78% | **+2.97pp** |
| Recall | 65.33% | 64.05% | -1.28pp |
| F1 | 68.87% | 69.42% | **+0.55pp** |

**評価**: ✅ 推奨
- Precision向上、F1微増
- TP損失は限定的（72件中37件は他ルールで救済可能）

### 7.2 シナリオ2: POST_LLM_FLIP_GATE 緩和

| 指標 | 現状 | 変更後(最悪) | 差分 |
|------|------|-------------|------|
| TP | 1,781 | 1,892 | +111 |
| FP | 665 | 1,668 | **+1,003** |
| Precision | 72.81% | 53.1% | **-19.7pp** |
| Recall | 65.33% | 69.4% | +4.1pp |

**評価**: ❌ 非推奨
- FN救済111件に対し、FP増加リスク1,003件
- CTX分布が重複しており、精密な閾値調整は困難

### 7.3 シナリオ3: policy_r4 無効化

| 指標 | 現状 | 変更後(最悪) | 差分 |
|------|------|-------------|------|
| TP | 1,781 | 1,477 | **-304** |
| FP | 665 | 233 | -432 |
| Precision | 72.81% | 86.4% | +13.6pp |
| Recall | 65.33% | 54.2% | **-11.1pp** |

**評価**: ❌ 非推奨
- TP損失が大きすぎる（-304件）
- Recall大幅悪化

---

## 8. 結論と推奨事項

### 8.1 チューニング可能な領域（推奨）

| 対策 | FP削減 | TP損失 | 純効果 |
|------|--------|--------|--------|
| fuzzy/fuzzy2 無効化 | -107 | -35 | **F1 +0.55pp** |

### 8.2 許容すべき限界

| 領域 | 件数 | 理由 |
|------|------|------|
| 極低シグナルFN | 361 | 証明書情報のみでは原理的に検出不可能 |
| 高ML正規サイトFP | 108 | XGBoostモデルの学習限界 |
| GATE保護TN | 1,003 | 緩和するとFP急増 |

### 8.3 最終評価

現状のF1スコア **68.87%** は以下の理由で妥当:

1. **FNの38%（361件）は原理的に検出困難** - 外部脅威インテリジェンスなしでは不可能
2. **GATEがTN 1,003件を保護** - 緩和すると精度大幅悪化
3. **fuzzy/fuzzy2 調整で+0.55pp改善可能** - 短期的な改善余地あり

**チューニングによる改善見込み**: F1 68.87% → **69.4%** (+0.5pp)
**外部インテリジェンス導入時の上限**: Recall 65% → **最大78%**（361件救済時）

---

## 付録

### A. 決定境界分析

| 条件 | TP | FP | TN | FN | Precision |
|------|-----|-----|-----|-----|-----------|
| ML >= 0.7 | 1,193 | 108 | 1 | 0 | 91.7% |
| CTX >= 0.50 | 1,289 | 143 | 242 | 179 | 90.0% |
| ML >= 0.5 AND CTX >= 0.4 | 1,384 | 83 | 0 | 0 | **94.3%** |

→ ML + CTX の組み合わせが最も精度の高い決定境界

### B. データファイル

- FN詳細: `/tmp/fn_analysis.csv`
- FP詳細: `/tmp/fp_analysis.csv`
