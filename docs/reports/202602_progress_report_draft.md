# RAPIDS 研究進捗報告書

**報告日**: 2026年2月
**前回打ち合わせ**: 2025年12月25日
**対象論文**: 「3段カスケード型フィッシング検出における投入制御とルール統合の効果分析」

---

## 1. 本報告の位置づけ

2025年12月25日の打ち合わせで合意した「確信度駆動の二層連携設計」を**3段カスケードとして実装・評価**し、論文としてまとめる段階にある。本報告では、評価結果と論文の構成・主張を報告する。

### 前回打ち合わせでの合意事項と対応状況

| # | 合意事項 | 対応状況 |
|---|---------|---------|
| 1 | グレー判定を許容する設計 | ✅ Stage1の三値ルーティング（auto_phishing / auto_benign / handoff）として実装 |
| 2 | 高確信度誤判定の削減 | ✅ Stage2の証明書ゲート + LR誤り確率推定で対応。SHAP分析により特徴量重要度を可視化（付録C） |
| 3 | XGBoostに固執しない | ✅ LightGBM/RandomForestとの比較を実施（F1差0.08pt以内、付録表A） |
| 4 | 実分布（正規多数）での評価 | ✅ prior shift analysis で比率別Precisionを推定（§5.2 表8） |
| 5 | LLM支援環境の整備 | ✅ Claude Code導入、3GPU並列評価基盤構築 |

---

## 2. 主要な成果（3つの知見）

### 知見1: 全体性能の向上

3段カスケード全体として、Stage1+2のみ（ベースライン）に比べシステム性能を改善:

| 指標 | Stage1+2のみ | 全段（提案） | 変化 |
|------|-------------|------------|------|
| **F1** | 98.60% | **98.67%** | **+0.07pt** |
| **Recall** | 97.73% | **98.18%** | **+0.45pt** |
| FNR | 2.27% | 1.82% | -0.45pt |
| FPR | 0.51% | 0.84% | +0.33pt |
| FN件数 | 1,444 | **1,158** | **-286件** |

### 知見2: 投入率・運用コストの制御

Stage2（LR + 証明書ゲート）により、Stage3投入を大幅に圧縮:

| 指標 | 値 |
|------|-----|
| Stage1 handoff | 57,991件（45.6%） |
| **Stage3投入（call rate）** | **11,952件（9.4%）** |
| 自動判定 | 115,270件（90.6%） |
| **自動判定誤り率** | **0.348%**（401件） |

τスイープ分析（τ=0.0〜1.0、51点）により、τ=0.3〜0.5で誤り396〜427件（変動±7.5%）と安定域を確認。

### 知見3: グレーゾーン救済 + 説明可能性

difficult subset（n=11,952）でのアブレーション:

| 構成 | Precision | Recall | F1 |
|------|-----------|--------|-----|
| LLMのみ | 87.69% | 55.34% | 67.85% |
| **LLM+ルール** | 76.11% | **68.92%** | **72.33%** |
| 差分 | -11.58pt | **+13.58pt** | +4.48pt |

- 811件（6.79%）がルールにより判定変更（flip）
- `risk_factors` + `rules_fired` により監査可能な根拠と再現性を付与

---

## 3. システム全体像

### 3.1 3段カスケード

```
[証明書データ: 127,222件テスト]
     ↓
┌─────────────────────────────────────────────────────┐
│ Stage1: XGBoost（三値ルーティング）                    │
│  42特徴量、t_high=0.957, t_low=0.001                  │
│  → auto_phishing: 60,767件（47.8%）                  │
│  → auto_benign:    8,464件（ 6.7%）                  │
│  → handoff:       57,991件（45.6%）→ Stage2          │
└─────────────────────────────────────────────────────┘
     ↓
┌─────────────────────────────────────────────────────┐
│ Stage2: LR誤り確率推定 + 証明書ハードゲート            │
│  cert gate: +12,992件safe化 / override: 1,718件強制投入 │
│  → drop_to_auto: 46,039件（36.2%）                   │
│  → Stage3投入:   11,952件（ 9.4%）                   │
└─────────────────────────────────────────────────────┘
     ↓
┌─────────────────────────────────────────────────────┐
│ Stage3: LLMエージェント + ドメイン知識ルール            │
│  Qwen3-4B-Thinking GPTQ-Int8 + 26ルールモジュール      │
│  → TP: 1,685 / FP: 529 / TN: 8,978 / FN: 760       │
└─────────────────────────────────────────────────────┘
```

### 3.2 システム全体性能

| 項目 | 値 |
|------|-----|
| TP | 62,453 |
| FP | 532 |
| TN | 63,079 |
| FN | 1,158 |
| **Precision** | **99.16%** |
| **Recall** | **98.18%** |
| **F1** | **98.67%** |
| FPR | 0.84% |
| FNR | 1.82% |
| 自動判定率 | 90.6% |
| Stage3投入率 | 9.4% |

---

## 4. 議論で取り上げる論点

### 4.1 投入制御のトレードオフ（§5.2）

- Stage3追加で FNR -0.45pt 改善、FPR +0.33pt 増加
- auto-decision error rate 0.348% の運用上の許容性

### 4.2 クラス不均衡下の性能推定（§5.2、表8）— MTG指摘対応

前回打ち合わせで「実分布（正規多数、フィッシング少数）での評価」を指摘いただいた件への対応。

TPR/FPRは入力分布に依存しない（prior shift仮定）ため、ベイズ式で異なる比率でのPrecisionを推定:

$$PPV(p) = \frac{TPR \cdot p}{TPR \cdot p + FPR \cdot (1-p)}$$

| 正規:フィッシング | Precision | Recall | F1 |
|---|---|---|---|
| 1:1（本評価） | 99.16% | 98.18% | 98.67% |
| 10:1 | 92.15% | 98.18% | 95.07% |
| 100:1（CTログ想定） | 54.00% | 98.18% | 69.68% |

**運用成立条件の逆算（2方向）**:

(a) **必要ベースレート**: Precision≥90%には実効比率≤13:1が必要（$p \geq 0.071$）

(b) **必要FPR**: 所与のベースレートで目標Precisionを達成するために検知器に求められるFPR上限

$$FPR \leq \frac{TPR \cdot p \cdot (1-PPV^*)}{PPV^* \cdot (1-p)}$$

| ベースレート p | 正規:フィッシング | PPV≥90%に必要なFPR |
|---|---|---|
| 0.01 | 100:1 | ≤ 0.110% |
| 0.001 | 1000:1 | ≤ 0.0109% |

本システムのFPR=0.84%はバランス評価では十分低いが、CTログ規模（100:1〜1000:1）では必要水準に対して1桁以上不足する。**これは本システム固有の弱点ではなく、FPRが有限である任意の検知器に共通する数学的制約**（base-rate fallacy）である。

**結論**:
- 本方式は監視パイプラインに組み込む「判定器」として設計されている
- 表8は上流の候補生成フィルタが満たすべきベースレート条件を定量化したもの
- 候補フィルタにより実効比率を13:1以下にすれば、Precision≥90%での運用が成立する
- 候補生成フィルタの設計は今後の課題

> 注: prior shift仮定であり、CTログの正規ドメイン分布がテストセットと異なる場合（covariate shift）はFPR自体が変わりうる。実環境データでの追検証が今後の課題。

### 4.3 妥当性への脅威（§5.3）— T1〜T9

| 脅威 | 要約 |
|------|------|
| T1. 観測バイアス | 証明書保有率の非対称性（フィッシング37〜56% vs 正規81%） |
| T2. 時間的妥当性 | (a)収集遅延 (b)攻撃手口の経時変化（concept drift） |
| T3. HTTPS未使用 | HTTP-onlyサイトは対象外（jpcert NOT_HTTPS 18.7%） |
| T4. ラベルノイズ | 手動検証なし（3ソース統合で偏りを抑制） |
| T5. 投入制御閾値 | τ=0.3〜0.5で安定（変動±7.5%） |
| T6. ルール閾値 | flip精度49.57%（過補正リスクあり） |
| T7. 分類器選択 | 3モデル比較でF1差0.08pt以内 |
| T8. 処理遅延 | p50=8.31s、投入率9.4%で影響限定的 |
| **T9. FN不可観測性** | **実運用ではFNに気づけない → 外部フィードとの定期照合が不可欠** |

### 4.4 今後の課題（§5.5）

1. **特徴量の拡張**: DNS/WHOIS/Passive DNS/IP・ASNレピュテーション等のインフラ情報を統合
2. **2段階検証フロー**: 証明書段階の事前検知 → サイト稼働後のコンテンツ検査
3. **継続的な傾向分析**: 外部フィード照合によるFNR推定、特徴量drift検知、定期再学習

---

## 5. 論文の構成と進捗

### 5.1 論文構成（8ページ目安）

| セクション | ページ | 状態 |
|----------|-------|------|
| 1. はじめに（RQ2本 + 知見3本） | 0.8 | outline完了 |
| 2. 関連研究 | 1.0 | outline完了 |
| 3. 手法（設計原則 + 擬似コード） | 1.4 | outline完了 |
| 4. 評価実験（RQ1, RQ2） | 3.1 | outline完了、データ整合済 |
| 5. 議論（T1-T9 + base-rate + 今後の課題） | 1.4 | outline完了 |
| 6. まとめ | 0.3 | outline完了 |

### 5.2 図表（計13点）

| 番号 | 内容 | データ検証 |
|------|------|----------|
| 図1 | 3段カスケードアーキテクチャ | ✅ CSV駆動 |
| 図2 | Stage遷移の件数推移 | ✅ CSV駆動 |
| 図3 | 閾値スイープ（call rate vs auto-decision errors） | ✅ CSV駆動 |
| 図4 | Stage3処理遅延CDF | ✅ CSV駆動 |
| 図5 | 誤り分析（FN/FP Stage別分布） | ✅ CSV駆動 |
| 表1 | データセット構築内訳 | ✅ |
| 表2 | 証明書可用性・ステータス分布 | ✅ |
| 表3 | システム全体性能（ヘッドライン） | ✅ |
| 表4 | Stage2投入制御効果 | ✅ |
| 表5 | Stage3性能（difficult subset） | ✅ |
| 表6 | Stage3アブレーション | ✅ |
| 表7 | Threats to Validity要約 | ✅ |
| 表8 | クラス比率別性能推定 | ✅ |
| 付録表A | Stage1分類器ベースライン比較 | ✅ |

### 5.3 データ整合性

- `python scripts/generate_paper_data.py --verify` ✅ パス
- `python scripts/generate_paper_figures.py --verify` ✅ パス
- `docs/paper/number_source_map.md` で全主要数値の出典を追跡可能

---

## 6. 次のステップ

| タスク | 優先度 | 状態 |
|--------|-------|------|
| P0-6: LaTeX原稿作成・図表流し込み | P0 | 未着手 |
| P0-7: 提出前整合性ゲート | P0 | 未着手 |
| P1-1: Abstract | P1 | 未着手 |
| P1-2: 関連研究の差分強化 | P1 | 未着手 |
| P1-3: Ethics/Data availability | P1 | 未着手 |

---

## 付録

### A. 参考資料

| 資料 | パス |
|-----|------|
| 論文アウトライン | `docs/paper/paper_outline.md` |
| 数値出典対応表 | `docs/paper/number_source_map.md` |
| 図ファイル対応表 | `docs/paper/images/FIGURE_MAP.md` |
| スタイルガイド | `docs/paper/STYLE_GUIDE.md` |
| 前回打ち合わせ記録 | `docs/mtg/202512/20251228.txt` |
| base-rate数学解説 | `docs/reports/base_rate_math_explanation.md` |
| base-rateメモ(LaTeX) | `docs/reports/base_rate_sensitivity_memo.tex` |
| SHAP分析レポート | `docs/reports/shap_analysis_report.md` |
| SHAP重要度図 | `docs/paper/images/shap_global_importance.png` |
| SHAP Beeswarm図 | `docs/paper/images/shap_beeswarm.png` |

### B. 用語集

| 用語 | 定義 |
|-----|------|
| Auto-decision（自動判定） | Stage1/Stage2が後段に送らず確定した判定 |
| Handoff（投入） | 当該Stageで判定を確定せず後段へ送ること |
| Gray zone（低確信度領域） | Stage1出力確率がt_low < p₁ < t_highの領域 |
| Difficult subset（困難集合） | Stage1・Stage2で自動判定されずStage3に到達した集合（n=11,952） |
| Call rate（投入率） | テスト全体に対するStage3投入件数の割合（9.4%） |
| Auto-decision error | 自動判定された集合における誤分類（401件、0.348%） |
| Prior shift | クラス比率（事前確率）のみが変化し、特徴量分布は不変という仮定 |
| Base-rate fallacy | 低頻度イベントの検知でFPRが小さくてもFPが大量に出る現象 |

### C. SHAP特徴量重要度分析（MTG合意事項#2対応）

Stage1 XGBoost（42特徴量）のSHAP TreeExplainerによる特徴量重要度分析。テスト全127,222件で計算。

#### Top-10 特徴量

| 順位 | 特徴量 | 種別 | Mean |SHAP| |
|------|--------|------|------------|
| 1 | dot_count | Domain | 2.617 |
| 2 | domain_length | Domain | 1.797 |
| 3 | tld_length | Domain | 1.559 |
| 4 | cert_has_crl_dp | Cert | 1.448 |
| 5 | cert_validity_days | Cert | 1.427 |
| 6 | cert_issuer_length | Cert | 1.376 |
| 7 | max_consonant_length | Domain | 0.989 |
| 8 | cert_is_le_r3 | Cert | 0.884 |
| 9 | cert_is_lets_encrypt | Cert | 0.748 |
| 10 | entropy | Domain | 0.404 |

Top-20内訳: ドメイン特徴量8個、証明書特徴量12個。上位3つはドメイン構造特徴量が占め、4位以降は証明書メタ特徴量が交互に並ぶ。

#### 高確信度誤判定の分析

| 種別 | 件数 | 特徴 |
|------|------|------|
| Auto-phishing FP（p₁≥0.957, y=0） | 4件 | dot_count, domain_length が強くphishing方向に押し、cert特徴量のbenign方向補正を上回った |
| Auto-benign FN（p₁≤0.001, y=1） | 2件 | cert_validity_days, cert_is_lets_encrypt, cert_issuer_length が強くbenign方向。**正規に見える証明書を持つフィッシング**が原因 |

高確信度誤判定は合計6件（127,222件中 0.005%）であり、閾値設計（t_high=0.957, t_low=0.001）が適切に機能していることを示す。

#### Gray zone の特徴

Gray zone（handoff領域）では cert_is_lets_encrypt の重要度が全体比 **1.32倍** に上昇。Let's Encrypt証明書がフィッシング/正規の判別を困難にしている主因であることを示唆する。

図: `docs/paper/images/shap_global_importance.png`, `docs/paper/images/shap_beeswarm.png`
詳細: `docs/reports/shap_analysis_report.md`
