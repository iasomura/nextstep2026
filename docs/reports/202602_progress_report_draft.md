# RAPIDS 研究進捗報告書

**報告日**: 2026年2月
**前回打ち合わせ**: 2025年12月25日

---

## 1. 本報告の位置づけ

本報告は、2025年12月25日の打ち合わせで議論した「確信度駆動の二層連携設計」に基づく**実装・評価の進捗報告**である。

### 前回打ち合わせでの合意事項（振り返り）

| 決定事項 | 概要 |
|---------|------|
| グレー判定の許容 | 確信度不足のケースを第2層に委譲 |
| 高確信度誤判定の削減 | 「自信を持って間違える」ケースの特定・対応 |
| XGBoostに固執しない | 三値分類等の代替手法を検討 |

---

## 2. 主要な成果

### 2.1 フィッシング見逃し率（FNR）14%削減

打ち合わせで議論した「確信度駆動設計」により、**Stage1（XGBoost）単体と比較して**フィッシング見逃し率を改善：

| 指標 | Stage1単体 | 3段階システム | 改善率 |
|------|-----------|-------------|--------|
| FNR | 2.70% | 2.32% | **-14%** |
| 見逃し件数 | 1,723件 | 1,484件 | -239件 |

※ Stage1単体はML予測(stage1_pred)ベース、3段階システムは全件評価による実測値

**FN発生箇所の内訳**（全phishing 63,877件中）:

| 発生箇所 | FN件数 | 説明 |
|---------|--------|------|
| Stage1 auto_benign | 8件 | ML確信度でbenign確定 |
| Stage2 フィルタ | 518件 | 証明書ルールでbenign判定 |
| Stage3 見逃し | 958件 | AI Agentで検出できず |
| **合計** | **1,484件** | FNR 2.32% |

**CSS2025論文との比較**（参考）:

| システム | FNR | Recall | 備考 |
|---------|-----|--------|------|
| CSS2025 ハイブリッド | 1.00% | 99.00% | 論文発表時（サンプル評価） |
| **現3段階システム** | **2.32%** | **97.68%** | 今回全件評価 |

※ CSS2025とはAI Agentの構成・パラメータおよび評価データセットが異なるため直接比較は困難

### 2.2 効率的な3段階設計

Stage2（Gate/ルール）の導入により、高コストなAI Agent処理を大幅に圧縮：

```
Stage1 handoff: 60,974件
      ↓ Stage2で74%フィルタ
Stage3 入力:    15,670件（約1/4に圧縮）
```

→ **計算コストを削減（トレードオフとしてStage2でphishing 518件を見逃し）**

### 2.3 「自信を持って間違える」問題への対応

打ち合わせで指摘された「高確信度誤判定」に対し、Stage2 Gate ルールで対応：

- **OV/EV証明書ルール**: 組織検証済み証明書を持つドメインを保護
- **ML Guard**: ML高スコア時の過剰検出を抑制
- **Cert Gate (B1-B4)**: 正規証明書の特徴に基づくbenign判定

### 2.4 マルチGPU並列処理基盤の構築

Stage3（AI Agent）の評価を3GPU並列で実行し、処理速度を向上：

| 項目 | 値 |
|------|-----|
| 使用GPU | 3台（ローカル×1 + リモート×2） |
| 実処理時間 | 12.9時間 |
| 単一GPU推定時間 | 37.2時間 |
| **高速化率** | **2.9倍** |

→ 大規模評価の実行可能性を確保

---

## 3. システム全体像

### 3.1 アーキテクチャの変更

打ち合わせ時点の2層構成から、**3段階パイプライン**に拡張した：

```
【打ち合わせ時点（2層構成）】
  Stage1: XGBoost → 0/1判定
  Stage2: AI Agent → FN救済

【現在のシステム（3段階構成）】
  Stage1: XGBoost → 確信度に基づく振り分け
  Stage2: Gate/ルール → 高確信度誤判定の救済（新規追加）
  Stage3: AI Agent → グレー領域の精査
```

### 3.2 3段階パイプライン詳細

```
[証明書データ]
     ↓
┌─────────────────────────────────────────────┐
│ Stage1: XGBoost ML分類                      │
│ ・31特徴量による確率予測                      │
│ ・振り分け:                                  │
│   - p >= 0.5 → auto_phishing               │
│   - p < 0.5  → handoff（グレー領域）        │
└─────────────────────────────────────────────┘
     ↓ handoff候補
┌─────────────────────────────────────────────┐
│ Stage2: Gate/ルールベース【新規追加】         │
│ ・OV/EV証明書による benign 強制判定          │
│ ・低シグナルフィッシング検出                  │
│ ・「自信を持って間違える」ケースの救済        │
└─────────────────────────────────────────────┘
     ↓ 判断困難なケース
┌─────────────────────────────────────────────┐
│ Stage3: AI Agent (LLM)                      │
│ ・4種類の分析ツール実行                      │
│ ・35種類のポリシールール適用                  │
│ ・最終判定                                   │
└─────────────────────────────────────────────┘
     ↓
[phishing / benign 最終判定]
```

### 3.3 AI Agent の構成

| コンポーネント | 役割 |
|--------------|------|
| LangGraph | エージェントのグラフ構造・状態管理 |
| Qwen3-4B (vLLM) | 推論エンジン（FP8量子化） |
| 分析ツール（4種類） | ブランド偽装、証明書、コンテキスト、短ドメイン分析 |
| ポリシールール（35種類） | 最終判定の調整 |

---

## 4. システム全体の性能

### 4.1 入力データ（artifacts/00-firststep）

| 項目 | 件数 | 備考 |
|------|------|------|
| 総件数 | 127,754 | バランスデータ |
| Phishing | 63,877 | 50% |
| Benign | 63,877 | 50% |

### 4.2 Stage1: XGBoost ML分類

**役割**: 全ドメインを高速スクリーニングし、確信度に基づき振り分け

| 判定 | 件数 | 内訳 |
|------|------|------|
| auto_phishing (p ≥ 0.5) | 60,614 | TP: 60,612 / FP: 2 |
| auto_benign (p < threshold) | 6,166 | TN: 6,158 / FN: 8 |
| handoff_to_agent | 60,974 | → Stage2へ |

**handoff_to_agent内訳**：
- Phishing: 3,257件（Stage2/3で救済対象）
- Benign: 57,717件

**Stage1単体性能**（ML予測 stage1_pred ベース）:

| 指標 | 値 |
|------|-----|
| Accuracy | 98.40% |
| Precision | 99.49% |
| Recall | 97.30% |
| FNR | 2.70% |

※ stage1_decision（auto_phishing/auto_benign/handoff）ベースでは FNR 5.11%（3,265件）

### 4.3 Stage2: Gate/ルールベースフィルタリング

**役割**: 証明書ルールにより安全なbenignをフィルタし、Stage3の負荷を軽減

**入力**: 60,974件（Stage1 handoff_to_agent）

| ルール | 件数 | 説明 |
|-------|------|------|
| CRL配布点あり | 42,409 | 正規CA証明書の指標 |
| OV/EV証明書 | 1,271 | 組織検証済み |
| ワイルドカード証明書 | 3,062 | 正規運用の指標 |
| 長期有効証明書 | 6,617 | 1年以上有効 |

**フィルタ結果**:

| 判定 | 件数 | 内訳 |
|------|------|------|
| safe_benign（確定） | 45,304 | benign: 44,786 / **phishing: 518** |
| handoff → Stage3 | 15,670 | benign: 12,931 / phishing: 2,739 |

⚠️ **注意**: Stage2フィルタでphishing 518件がbenignと誤判定されている（Stage2 FN）

### 4.4 Stage3: AI Agent (LLM)

**役割**: 判断困難なケースをLLMで精査し、最終判定

**入力**: 15,630件（Stage2 handoff、タイムアウト40件除く）

| ラベル | 件数 |
|-------|------|
| Phishing | 2,726 |
| Benign | 12,904 |

**混同行列**：
```
              Predicted
            Benign  Phishing
Actual  Benign   12,239    665 (FP)
       Phishing    945  1,781 (TP)
```

**Stage3性能**:

| 指標 | 値 |
|------|-----|
| Accuracy | 89.70% |
| Precision | 72.81% |
| Recall | 65.33% |
| F1 Score | 68.87% |

### 4.5 処理フロー全体像

```
Stage1 入力:        127,754件 (phishing:63,877 / benign:63,877)
  ├─ auto_phishing: 60,614件 (TP:60,612 / FP:2)
  ├─ auto_benign:    6,166件 (TN:6,158 / FN:8)
  └─ handoff:       60,974件 (phishing:3,257 / benign:57,717) → Stage2

Stage2 入力:        60,974件
  ├─ safe_benign:   45,304件 (TN:44,786 / FN:518)
  └─ handoff:       15,670件 (phishing:2,739 / benign:12,931) → Stage3

Stage3 入力:        15,670件 (タイムアウト40件含む)
  ├─ phishing判定:  2,446件 (TP:1,781 / FP:665)
  └─ benign判定:    13,224件 (TN:12,266 / FN:958)
```

**システム全体のFN**: 8 + 518 + 958 = **1,484件** (FNR 2.32%)

### 4.6 3段階システム全体性能（実測）

**システム全体の混同行列**：

```
                      Predicted
                   Benign    Phishing
Actual  Benign     63,210       667 (FP)
       Phishing     1,484    62,393 (TP)
```

**システム全体の性能指標**：

| 指標 | 値 |
|------|-----|
| **Accuracy** | 98.32% |
| **Precision** | 98.94% |
| **Recall** | 97.68% |
| **F1 Score** | 98.31% |
| FNR (見逃し率) | 2.32% |
| FPR (誤検出率) | 1.04% |

**Stage1単体との比較**：

| 指標 | Stage1単体 | 3段階システム | 変化 |
|------|-----------|-------------|------|
| Accuracy | 98.40% | 98.32% | -0.09pp |
| Precision | 99.49% | 98.94% | -0.55pp |
| Recall | 97.30% | 97.68% | **+0.37pp** |
| F1 Score | 98.39% | 98.31% | -0.08pp |
| FNR | 2.70% | 2.32% | **-0.37pp** |
| FPR | 0.50% | 1.04% | +0.55pp |
| FN件数 | 1,723 | 1,484 | **-239件** |
| FP件数 | 317 | 667 | +350件 |

**TP/FP/TN/FN内訳**：

| 項目 | 件数 | 内訳 |
|------|------|------|
| TP | 62,393 | Stage1: 60,612 + Stage3: 1,781 |
| FP | 667 | Stage1: 2 + Stage3: 665 |
| TN | 63,210 | Stage1: 6,158 + Stage2: 44,786 + Stage3: 12,266 |
| FN | 1,484 | Stage1: 8 + Stage2: 518 + Stage3: 958 |

**考察**：

1. **改善点**
   - FN（見逃し）を239件削減（1,723→1,484）
   - Recall（検出率）が+0.37pp向上

2. **トレードオフ**
   - FP（誤検出）が350件増加（317→667）
   - Precisionが-0.55pp低下
   - Stage3がFPを増やしている（665件）

3. **システム特性**
   - Stage2で45,304件をフィルタし、Stage3の負荷を約74%削減
   - ただしStage2フィルタで518件のphishingを見逃し
   - Stage3で2,739件中1,781件を検出（救済率65.02%）

4. **結論**
   - 3段階システムは「フィッシングの見逃しを減らす」目的に対しては効果的
   - FP削減がシステム全体の精度向上に向けた課題

---

## 5. 打ち合わせ後の追加実装

### 5.1 Stage2 Gate/ルールの追加

打ち合わせでの「高確信度誤判定の削減」を実現するため、Stage2を新設：

| ルールカテゴリ | ルール数 | 目的 |
|--------------|---------|------|
| ML Guard | 5 | ML高スコア時の強制判定 |
| Cert Gate (B1-B4) | 4 | OV/EV証明書によるbenign判定 |
| Low Signal Gate (P1-P4) | 4 | 低シグナルフィッシング検出 |
| Policy (R1-R6) | 6 | コンテキストスコアベース判定 |
| CTX Trigger | 2 | 高ctxスコア時の強制判定 |
| その他 | 14 | ブランド、TLD組み合わせ等 |

### 5.2 改善施策と効果

| 施策 | 実施日 | 効果 |
|-----|--------|------|
| ml_paradox条件厳格化 | 2026-01-31 | FP -320件見込み |
| critical_brand_minimum ML閾値追加 | 2026-01-31 | FP -22件 |
| ブランドキーワード拡充 | 2026-01-29 | FN削減 |

---

## 6. handoff候補の詳細評価（✅ 完了）

### 6.1 評価概要

CSS2025論文とは別に、**handoff候補のみを対象とした詳細評価**を実施した。

**目的**：Stage2/Stage3単体の性能を検証

| 項目 | 値 |
|------|-----|
| 評価対象 | 15,670件 |
| 有効件数 | 15,630件 |
| タイムアウト | 40件（0.26%） |
| 総処理時間 | 36.1時間 |
| 平均処理時間 | 8.31秒/件 |

### 6.2 評価結果

**混同行列**：

```
              Predicted
            Benign  Phishing
Actual  Benign   12,239    665 (FP)
       Phishing    945  1,781 (TP)
```

**性能指標**：

| 指標 | 値 | 備考 |
|------|-----|------|
| Accuracy | 89.70% | - |
| Precision | 72.81% | FP削減が課題 |
| Recall | 65.33% | FN削減が課題 |
| F1 Score | 68.87% | 改善の余地あり |

**ラベル分布**：

| ラベル | 件数 | 割合 |
|-------|------|------|
| Benign | 12,904 | 82.6% |
| Phishing | 2,726 | 17.4% |

**注記**：この評価はhandoff候補（MLで判断困難なケース）のみを対象としており、システム全体の性能（4節）とは異なる。

### 6.3 評価基盤（マルチGPU並列処理）

| 項目 | 値 |
|------|-----|
| Worker数 | 3（GPU 1台/Worker） |
| GPU構成 | ローカル×1 + リモート×2 |
| 並列化方式 | ドメイン分割による独立処理 |
| チェックポイント | 10件ごとに自動保存 |

**処理時間の詳細**:

| Worker | 処理件数 | 処理時間 | 平均処理時間 |
|--------|---------|---------|-------------|
| Worker 0 | 5,715件 | 12.9h | 8.15秒/件 |
| Worker 1 | 6,361件 | 12.5h | 7.09秒/件 |
| Worker 2 | 3,554件 | 11.7h | 11.89秒/件 |

**高速化効果**:
- 実処理時間: **12.9時間**（最長Workerの完了時間）
- 単一GPU推定: 37.2時間
- 高速化率: **2.9倍**

評価完了日: 2026年2月1日

---

## 7. 打ち合わせ決定事項の対応状況

| # | 決定事項 | 状況 | 詳細 |
|---|---------|------|------|
| 1 | グレー判定を許容 | ✅ 完了 | handoff機構 + Stage2 Gate |
| 2 | 高確信度誤判定の対応 | ✅ 完了 | Cert Gate, ML Guard で救済 |
| 3 | handoff候補の詳細評価 | ✅ 完了 | 15,630件評価完了（F1: 68.87%） |
| 4 | XGBoostに固執しない | △ 検討中 | 現時点では継続使用 |
| 5 | LLM支援環境の整備 | ✅ 完了 | Claude Code導入 |

---

## 8. 課題と今後の検討事項

### 8.1 評価結果からの課題

| 課題 | 詳細 | 打ち合わせとの関連 |
|-----|------|----------------|
| **システム全体FP削減** | FP: 667件（Stage3で+665件増加） | ルール調整 |
| **Stage3 FN削減** | Stage3 FN: 958件（Recall 65.02%） | 検出ロジック強化 |
| **Stage2 FN削減** | Stage2フィルタでFN: 518件 | 証明書ルール見直し |
| 中間確信度領域 | p = 0.2-0.5 での検出率が不安定 | 三値分類の検討 |

### 8.2 打ち合わせでの問いへの現時点の回答

| 質問 | 回答 |
|-----|------|
| XGBoostを採用し続けるべきか | 現時点では有効。三値分類への拡張は今後検討 |
| チューニングすべきか | 閾値調整（0.5）で一定の効果 |
| 別モデルで実現可能か | 三値分類（確信0/確信1/グレー）は今後の課題 |

---

## 9. 今後の予定

### 短期（〜2月中旬）

- [x] ~~handoff評価完了~~（2026-02-01 完了）
- [ ] FP/FN詳細分析
- [ ] ml_paradox条件厳格化の効果検証

### 中期（〜3月）

- [ ] 三値分類モデルの試作・評価
- [ ] ルールモジュールの単体テスト追加
- [ ] handoff F1スコア改善（目標: 75%以上、現状: 68.87%）

---

## 10. まとめ

### システム変更

- 2層構成 → **3段階パイプライン**に拡張
- Stage2（Gate/ルール）を新設し、高確信度誤判定を救済

### 全体性能（127,754件）

**システム全体の主要指標**:

| 指標 | 値 |
|------|-----|
| Accuracy | 98.32% |
| Precision | 98.94% |
| Recall | 97.68% |
| F1 Score | 98.31% |

**Stage1単体との比較**:

| 指標 | Stage1単体 | 3段階システム | 変化 |
|------|-----------|-------------|------|
| Recall | 97.30% | 97.68% | **+0.37pp** |
| FNR | 2.70% | 2.32% | **-0.37pp** |
| FN件数 | 1,723件 | 1,484件 | **-239件** |
| Precision | 99.49% | 98.94% | -0.55pp |
| FP件数 | 317件 | 667件 | +350件 |

**トレードオフ**: FNを239件削減した一方、FPが350件増加

### handoff候補評価（15,630件）✅ 完了

| 指標 | 値 |
|------|-----|
| Accuracy | 89.70% |
| Precision | 72.81% |
| Recall | 65.33% |
| F1 Score | 68.87% |

### 今後の課題

- FP削減（3段階システムFP: 667件 = Stage1 2件 + Stage3 665件）
- Stage2フィルタのFN削減（現状518件のphishingが見逃されている）
- handoff評価のRecall向上（65.02% → 目標: 75%以上）
- 三値分類モデルの検討（打ち合わせでの提案）

---

## 付録

### A. 参考資料

| 資料 | パス |
|-----|------|
| 前回打ち合わせ記録 | `docs/mtg/202512/20251228.txt` |
| CSS2025論文 | `docs/CSS2025.pdf` |

### B. 用語集

| 用語 | 説明 |
|-----|------|
| handoff | Stage1で確信度不足と判断され、Stage2/3に委譲されるケース |
| グレー領域 | p < 0.5 の確信度不足領域 |
| ml_paradox | MLスコア低いがフィッシング特徴を持つケース |
