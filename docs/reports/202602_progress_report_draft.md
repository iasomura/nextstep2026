# RAPIDS 研究進捗報告書

**報告日**: 2026年2月
**前回打ち合わせ**: 2025年12月25日

---

## 1. 本報告の位置づけ

本報告は、2025年12月25日の打ち合わせで議論した「確信度駆動の二層連携設計」に基づく**実装・評価の進捗報告**である。

### 前回打ち合わせでの合意事項（振り返り）

| 決定事項 | 概要 |
|---------|------|
| グレー判定の許容 | 確信度不足のケースを第2層に委譲 |
| 高確信度誤判定の削減 | 「自信を持って間違える」ケースの特定・対応 |
| XGBoostに固執しない | 三値分類等の代替手法を検討 |

---

## 2. 主要な成果

### 2.1 フィッシング見逃し率（FNR）65%削減

打ち合わせで議論した「確信度駆動設計」により、**Stage1（XGBoost）単体と比較して**フィッシング見逃し率を大幅に改善：

| 指標 | Stage1単体 | 3段階システム | 改善率 |
|------|-----------|-------------|--------|
| FNR | 2.70% | 0.94% | **-65%** |
| 見逃し件数 | 1,723件 | 598件（推定） | -1,125件 |

※ Stage1単体: XGBoostのみで判定した場合の性能
※ 3段階システム: Stage1 + Stage2(Gate/ルール) + Stage3(AI Agent) の組み合わせ

### 2.2 効率的な3段階設計

Stage2（Gate/ルール）の導入により、高コストなAI Agent処理を大幅に圧縮：

```
Stage1 handoff: 65,283件
      ↓ Stage2で68%フィルタ
Stage3 入力:    15,670件（約1/4に圧縮）
```

→ **計算コストを削減しつつ、精度向上を実現**

### 2.3 「自信を持って間違える」問題への対応

打ち合わせで指摘された「高確信度誤判定」に対し、Stage2 Gate ルールで対応：

- **OV/EV証明書ルール**: 組織検証済み証明書を持つドメインを保護
- **ML Guard**: ML高スコア時の過剰検出を抑制
- **Cert Gate (B1-B4)**: 正規証明書の特徴に基づくbenign判定

### 2.4 マルチGPU並列処理基盤の構築

Stage3（AI Agent）の評価を3GPU並列で実行し、処理速度を向上：

| 項目 | 値 |
|------|-----|
| 使用GPU | 3台（ローカル×1 + リモート×2） |
| 実処理時間 | 12.9時間 |
| 単一GPU推定時間 | 37.2時間 |
| **高速化率** | **2.9倍** |

→ 大規模評価の実行可能性を確保

---

## 3. システム全体像

### 3.1 アーキテクチャの変更

打ち合わせ時点の2層構成から、**3段階パイプライン**に拡張した：

```
【打ち合わせ時点（2層構成）】
  Stage1: XGBoost → 0/1判定
  Stage2: AI Agent → FN救済

【現在のシステム（3段階構成）】
  Stage1: XGBoost → 確信度に基づく振り分け
  Stage2: Gate/ルール → 高確信度誤判定の救済（新規追加）
  Stage3: AI Agent → グレー領域の精査
```

### 3.2 3段階パイプライン詳細

```
[証明書データ]
     ↓
┌─────────────────────────────────────────────┐
│ Stage1: XGBoost ML分類                      │
│ ・31特徴量による確率予測                      │
│ ・振り分け:                                  │
│   - p >= 0.5 → auto_phishing               │
│   - p < 0.5  → handoff（グレー領域）        │
└─────────────────────────────────────────────┘
     ↓ handoff候補
┌─────────────────────────────────────────────┐
│ Stage2: Gate/ルールベース【新規追加】         │
│ ・OV/EV証明書による benign 強制判定          │
│ ・低シグナルフィッシング検出                  │
│ ・「自信を持って間違える」ケースの救済        │
└─────────────────────────────────────────────┘
     ↓ 判断困難なケース
┌─────────────────────────────────────────────┐
│ Stage3: AI Agent (LLM)                      │
│ ・4種類の分析ツール実行                      │
│ ・35種類のポリシールール適用                  │
│ ・最終判定                                   │
└─────────────────────────────────────────────┘
     ↓
[phishing / benign 最終判定]
```

### 3.3 AI Agent の構成

| コンポーネント | 役割 |
|--------------|------|
| LangGraph | エージェントのグラフ構造・状態管理 |
| Qwen3-4B (vLLM) | 推論エンジン（FP8量子化） |
| 分析ツール（4種類） | ブランド偽装、証明書、コンテキスト、短ドメイン分析 |
| ポリシールール（35種類） | 最終判定の調整 |

---

## 4. システム全体の性能

### 4.1 入力データ（artifacts/00-firststep）

| 項目 | 件数 | 備考 |
|------|------|------|
| 総件数 | 127,754 | バランスデータ |
| Phishing | 63,877 | 50% |
| Benign | 63,877 | 50% |

### 4.2 Stage1: XGBoost ML分類

**役割**: 全ドメインを高速スクリーニングし、確信度に基づき振り分け

| 判定 | 件数 | 内訳 |
|------|------|------|
| auto_phishing (p ≥ 0.5) | 62,471 | TP: 62,154 / FP: 317 |
| handoff (p < 0.5) | 65,283 | → Stage2へ |

**handoff内訳**：
- 要救済 Phishing: 1,723件（Stage1のFN）
- Benign: 63,560件

**Stage1単体性能**:

| 指標 | 値 |
|------|-----|
| Accuracy | 98.40% |
| Precision | 99.49% |
| Recall | 97.30% |
| FNR | 2.70% |

### 4.3 Stage2: Gate/ルールベースフィルタリング

**役割**: 証明書ルールにより安全なbenignをフィルタし、Stage3の負荷を軽減

**入力**: 65,283件（Stage1 handoff）

| ルール | 件数 | 説明 |
|-------|------|------|
| CRL配布点あり | 42,409 | 正規CA証明書の指標 |
| OV/EV証明書 | 1,271 | 組織検証済み |
| ワイルドカード証明書 | 3,062 | 正規運用の指標 |
| 長期有効証明書 | 6,617 | 1年以上有効 |

**フィルタ結果**:

| 判定 | 件数 |
|------|------|
| safe_benign（確定） | 44,732 |
| handoff → Stage3 | 15,670 |

### 4.4 Stage3: AI Agent (LLM)

**役割**: 判断困難なケースをLLMで精査し、最終判定

**入力**: 15,630件（Stage2 handoff、タイムアウト40件除く）

| ラベル | 件数 |
|-------|------|
| Phishing | 2,726 |
| Benign | 12,904 |

**混同行列**：
```
              Predicted
            Benign  Phishing
Actual  Benign   12,239    665 (FP)
       Phishing    945  1,781 (TP)
```

**Stage3性能**:

| 指標 | 値 |
|------|-----|
| Accuracy | 89.70% |
| Precision | 72.81% |
| Recall | 65.33% |
| F1 Score | 68.87% |

### 4.5 処理フロー全体像

```
Stage1 入力:        127,754件
  ├─ auto_phishing: 62,471件 (TP:62,154 / FP:317)
  └─ handoff:       65,283件 → Stage2

Stage2 入力:        65,283件
  ├─ safe_benign:   44,732件 (benign確定)
  └─ handoff:       15,670件 → Stage3

Stage3 入力:        15,630件
  ├─ phishing判定:  2,446件 (TP:1,781 / FP:665)
  └─ benign判定:    13,184件 (TN:12,239 / FN:945)
```

### 4.6 3段階システム推定性能

| 指標 | Stage1単体 | 3段階システム | 改善 |
|------|-----------|-------------|------|
| FNR | 2.70% | 0.94% | **-1.76pp** |
| Recall | 97.30% | 99.06% | +1.76pp |

**考察**：
- Stage2で44,732件をフィルタし、Stage3の負荷を約68%削減
- Stage3で1,781件のFNを救済（救済率65.33%）
- 最終FNR: 0.94%（1,723件→推定598件）

---

## 5. 打ち合わせ後の追加実装

### 5.1 Stage2 Gate/ルールの追加

打ち合わせでの「高確信度誤判定の削減」を実現するため、Stage2を新設：

| ルールカテゴリ | ルール数 | 目的 |
|--------------|---------|------|
| ML Guard | 5 | ML高スコア時の強制判定 |
| Cert Gate (B1-B4) | 4 | OV/EV証明書によるbenign判定 |
| Low Signal Gate (P1-P4) | 4 | 低シグナルフィッシング検出 |
| Policy (R1-R6) | 6 | コンテキストスコアベース判定 |
| CTX Trigger | 2 | 高ctxスコア時の強制判定 |
| その他 | 14 | ブランド、TLD組み合わせ等 |

### 5.2 改善施策と効果

| 施策 | 実施日 | 効果 |
|-----|--------|------|
| ml_paradox条件厳格化 | 2026-01-31 | FP -320件見込み |
| critical_brand_minimum ML閾値追加 | 2026-01-31 | FP -22件 |
| ブランドキーワード拡充 | 2026-01-29 | FN削減 |

---

## 6. handoff候補の詳細評価（✅ 完了）

### 6.1 評価概要

CSS2025論文とは別に、**handoff候補のみを対象とした詳細評価**を実施した。

**目的**：Stage2/Stage3単体の性能を検証

| 項目 | 値 |
|------|-----|
| 評価対象 | 15,670件 |
| 有効件数 | 15,630件 |
| タイムアウト | 40件（0.26%） |
| 総処理時間 | 36.1時間 |
| 平均処理時間 | 8.31秒/件 |

### 6.2 評価結果

**混同行列**：

```
              Predicted
            Benign  Phishing
Actual  Benign   12,239    665 (FP)
       Phishing    945  1,781 (TP)
```

**性能指標**：

| 指標 | 値 | 備考 |
|------|-----|------|
| Accuracy | 89.70% | - |
| Precision | 72.81% | FP削減が課題 |
| Recall | 65.33% | FN削減が課題 |
| F1 Score | 68.87% | 改善の余地あり |

**ラベル分布**：

| ラベル | 件数 | 割合 |
|-------|------|------|
| Benign | 12,904 | 82.6% |
| Phishing | 2,726 | 17.4% |

**注記**：この評価はhandoff候補（MLで判断困難なケース）のみを対象としており、システム全体の性能（4節）とは異なる。

### 6.3 評価基盤（マルチGPU並列処理）

| 項目 | 値 |
|------|-----|
| Worker数 | 3（GPU 1台/Worker） |
| GPU構成 | ローカル×1 + リモート×2 |
| 並列化方式 | ドメイン分割による独立処理 |
| チェックポイント | 10件ごとに自動保存 |

**処理時間の詳細**:

| Worker | 処理件数 | 処理時間 | 平均処理時間 |
|--------|---------|---------|-------------|
| Worker 0 | 5,715件 | 12.9h | 8.15秒/件 |
| Worker 1 | 6,361件 | 12.5h | 7.09秒/件 |
| Worker 2 | 3,554件 | 11.7h | 11.89秒/件 |

**高速化効果**:
- 実処理時間: **12.9時間**（最長Workerの完了時間）
- 単一GPU推定: 37.2時間
- 高速化率: **2.9倍**

評価完了日: 2026年2月1日

---

## 7. 打ち合わせ決定事項の対応状況

| # | 決定事項 | 状況 | 詳細 |
|---|---------|------|------|
| 1 | グレー判定を許容 | ✅ 完了 | handoff機構 + Stage2 Gate |
| 2 | 高確信度誤判定の対応 | ✅ 完了 | Cert Gate, ML Guard で救済 |
| 3 | handoff候補の詳細評価 | ✅ 完了 | 15,630件評価完了（F1: 68.87%） |
| 4 | XGBoostに固執しない | △ 検討中 | 現時点では継続使用 |
| 5 | LLM支援環境の整備 | ✅ 完了 | Claude Code導入 |

---

## 8. 課題と今後の検討事項

### 8.1 評価結果からの課題

| 課題 | 詳細 | 打ち合わせとの関連 |
|-----|------|----------------|
| FP削減 | Precision 72.81%（FP: 665件） | ルール調整 |
| FN削減 | Recall 65.33%（FN: 945件） | 検出ロジック強化 |
| 中間確信度領域 | p = 0.2-0.5 での検出率が不安定 | 三値分類の検討 |

### 8.2 打ち合わせでの問いへの現時点の回答

| 質問 | 回答 |
|-----|------|
| XGBoostを採用し続けるべきか | 現時点では有効。三値分類への拡張は今後検討 |
| チューニングすべきか | 閾値調整（0.5）で一定の効果 |
| 別モデルで実現可能か | 三値分類（確信0/確信1/グレー）は今後の課題 |

---

## 9. 今後の予定

### 短期（〜2月中旬）

- [x] ~~handoff評価完了~~（2026-02-01 完了）
- [ ] FP/FN詳細分析
- [ ] ml_paradox条件厳格化の効果検証

### 中期（〜3月）

- [ ] 三値分類モデルの試作・評価
- [ ] ルールモジュールの単体テスト追加
- [ ] handoff F1スコア改善（目標: 75%以上、現状: 68.87%）

---

## 10. まとめ

### システム変更

- 2層構成 → **3段階パイプライン**に拡張
- Stage2（Gate/ルール）を新設し、高確信度誤判定を救済

### 全体性能（127,754件）

| 指標 | Stage1単体 | 3段階システム | 改善 |
|------|-----------|-------------|------|
| FNR | 2.70% | 0.94% | **-1.76pp** |
| Recall | 97.30% | 99.06% | +1.76pp |

### handoff候補評価（15,630件）✅ 完了

| 指標 | 値 |
|------|-----|
| Accuracy | 89.70% |
| Precision | 72.81% |
| Recall | 65.33% |
| F1 Score | 68.87% |

### 今後の課題

- FP削減（3段階システムでFPが増加: 317→3,592件）
- handoff評価のRecall向上（65.33% → 目標: 75%以上）
- 三値分類モデルの検討（打ち合わせでの提案）

---

## 付録

### A. 参考資料

| 資料 | パス |
|-----|------|
| 前回打ち合わせ記録 | `docs/mtg/202512/20251228.txt` |
| CSS2025論文 | `docs/CSS2025.pdf` |

### B. 用語集

| 用語 | 説明 |
|-----|------|
| handoff | Stage1で確信度不足と判断され、Stage2/3に委譲されるケース |
| グレー領域 | p < 0.5 の確信度不足領域 |
| ml_paradox | MLスコア低いがフィッシング特徴を持つケース |
