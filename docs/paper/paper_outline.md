# 論文骨子: 3段カスケード型フィッシング検出における投入制御とルール統合の効果分析

作成日: 2026-02-06
最終更新: 2026-02-07

前論文: CSS2025「機械学習とAIエージェントを組み合わせたハイブリッド型フィッシングサイト検出システムの開発と評価」

更新履歴:
- 2026-02-06: 初版作成
- 2026-02-06: dataset_overview.md のDB実測値を反映（証明書取得ステータス、可用性、データ構築プロセス、特徴量数を明記）。Research Questions、アブレーション、閾値感度、時系列評価、キャリブレーション、倫理項目、妥当性への脅威を追記。
- 2026-02-07: 実データ（stage1/stage2/eval CSV）・コードとの突合レビューに基づき修正。テスト件数を127,222に訂正、Stage2基本条件・証明書ゲート詳細を追記、Stage3ルール数・モデル名・Structured Output完全仕様を反映。
- 2026-02-07: データ件数の脱落原因を調査・訂正。「特徴量抽出時の532件脱落」は誤りで、実際はデータ準備パイプラインでの重複排除・バランス調整による差異（319,383→318,055件/class）。特徴量抽出時の脱落は0件。
- 2026-02-07: 森先生レビュー指摘（RQ削減、知見ベース貢献、図表削減、手法節圧縮、Stage3 F1解釈、ページ配分）を反映（指摘1,2,3,5,6,7,10）。
- 2026-02-07: TODO-7反映 — MTG合意（確信度/gray設計）に基づき本文主軸を固定。§1（導入・RQ・貢献）の焦点を投入制御＋困難集合補正に統一、§3に用語定義・擬似コード・cert gate仕様境界を明文化、§4-5の指標体系を整理。

---

## CSS2025 → 本論文の進化ポイント

| 観点 | CSS2025 | 本論文 |
|------|---------|------|
| アーキテクチャ | 2段階（ML → AI Agent） | 3段階（ML → Error Gate → AI Agent + Rule Engine） |
| 主要論点 | 低確信度領域の偽陰性削減 | Stage2による投入率削減と、Stage3のルール統合効果の定量化 |
| Stage2 | なし | LR（誤り確率推定）+ 証明書ゲートによる投入制御 |
| Stage3 | LLM単体判定 | LLM + 証明書ドメイン知識ルール統合 |
| 説明可能性 | reasoning出力のみ | リスク要因の列挙 + ルール発火トレース |
| ルール設計 | インライン実装 | モジュール化（個別有効化、テスト容易性） |

---

## タイトル案

日本語:
- 「3段カスケード型フィッシング検出における投入制御とルール統合の効果分析」

英語:
- "Effect Analysis of Handoff Control and Rule Integration in a Three-Stage Cascade Phishing Detection System"

---

## 1. はじめに

### 1.1 背景
- フィッシング被害の深刻化と、HTTPS普及により単純な鍵マーク判定が無効化
- CSS2025で、MLによる高速スクリーニングとLLMエージェントの二段構えを提示
- 本論文は、証明書とドメインのみを用いる検出の射程において、投入制御とルール統合が精度と運用コストに与える影響を実測し整理する
<!-- CHANGED: TODO-7 — 焦点の明示文を追加。MTG合意「分類器優劣ではなくgray定義と投入制御」を導入冒頭に固定 -->
- **本研究の焦点は特定の分類器の性能比較ではなく、確信度に基づく投入制御（handoff control）と、困難集合での説明可能な補正（ルール統合）にある。** 運用では偽陰性（FN）の真値は事前に未知であるため、「FNを追跡する」のではなく、「分類器が確信を持てない領域（gray zone）を定義し、それを後段へ送る」という設計思想をとる。

<!-- 要相談: 指摘8 「なぜ証明書か」を1章でどこまで強調するか。Related Workと分担して、本文の紙面配分と一貫させる -->

### 1.2 CSS2025の残課題（本論文の出発点）
- handoff候補に対するLLM処理が計算コストの制約となる
- LLM単体判定では再現性、安定性、説明可能性に限界がある
<!-- CHANGED: TODO-7 — 「偽陰性要因の分析が不足」はFN追跡の書き方。MTG合意に沿い「確信度に基づく投入制御が未整理」に置換 -->
- 確信度に基づく投入制御の設計——何をhandoffし、何を自動判定するか——が体系化されていない
- 困難ケース（gray zone）での補正機構がなく、LLM出力をそのまま最終判定とする脆弱性がある

### 1.3 Research Questions（RQ）

<!-- CHANGED: TODO-7 — RQ1/RQ2を投入率＋auto-decision error / 困難集合Recall改善に寄せ、一次指標と補助指標を明示 -->
- **RQ1**: Stage2（誤り確率推定 + 証明書ゲート）は、**Stage3投入率（call rate）** をどこまで低減できるか。**自動判定誤り（auto-decision error）** と投入率はどのようなトレードオフを持つか。
  - 一次指標: Stage3 call rate（11,952/127,222 = 9.4%）、auto-decision error rate（401/115,270 = 0.348%）
  - 補助指標: システム全体 F1/FPR/FNR（Table 3 参照）
  - 対応: §4.2
- **RQ2**: Stage3における知識ルール統合は、LLM単体に比べて**困難ケース集合（difficult subset, n=11,952）** でどの程度 **Recall を改善** するか。FP増加との関係はどうか。説明可能性・再現性をどのように付与するか。
  - 一次指標: difficult subset 上の Recall 改善幅と FP 増加数
  - 補助指標: F1（72.33% はdifficult subset上の値であり、システム全体F1=98.67%と同列比較しない）
  - 対応: §4.3（アブレーション、誤り分析、ルール発火統計）

### 1.4 本論文で明らかにした知見（貢献）

<!-- CHANGED: TODO-7 — 知見の記述を投入制御・困難集合補正に寄せ、防御線（任意モデル適用可能）を追加 -->
- 知見1: 確信度に基づくhandoff制御（Stage2）により、Stage3投入率を9.4%に圧縮しつつ、自動判定誤り率を0.348%に抑え、システム全体F1=98.67%を維持できることを実データで示した。
- 知見2: 困難ケース集合（n=11,952）においてLLM判定にドメイン知識ルールを統合することで、Recallを55.34%→68.92%に改善し（+13.58pt）、同時にルール発火トレースによる説明可能性と再現性を付与できることを定量化した。
- 知見3: 誤り分析により、各Stageの自動判定誤りの性質と、困難ケース集合における残存FN・増加FPの構造的要因を明確化した。

<!-- CHANGED: TODO-7 — 「XGBoostを変えたら？」への防御線。任意の確率出力モデルに適用可能であることを明記 -->
> **スコープの限定**: 本研究の貢献は分類器の選択にはない。提案する投入制御とルール統合の枠組みは、Stage1に任意の確率出力モデルを代替可能であり、XGBoostに固有の設計ではない。本研究はこの制御構造と補正機構の効果を定量化したものである。

### 1.5 論文構成
第2章で関連研究、第3章で手法（設計原則中心）、第4章で評価（RQ1, RQ2に対応）、第5章で議論（妥当性・倫理・運用含む）、第6章でまとめ。

---

## 2. 関連研究

### 2.1 機械学習によるフィッシング検出
- URL/ドメイン特徴量によるML検出
- 証明書特徴量の活用
- 勾配ブースティング（XGBoost等）の有効性
- 共通課題: ブラックボックス性、誤り要因の体系的分析不足、分布変化への弱さ

### 2.2 LLMによるフィッシング検出
- 大型LLMによる高精度化とコスト問題
- 小型LLMや量子化による実用化の方向性
- 共通課題: 全件LLM処理の非効率性、再現性、説明性

### 2.3 ハイブリッド手法と投入制御
- MLによる絞り込み + LLM精査（トリアージ）
- CSS2025の二段設計と、本研究の三段拡張（誤り確率推定層の導入）

### 2.4 説明可能性とルール統合
- XAI（SHAP/LIME等）と自然言語説明
- ルールエンジン統合による決定過程トレース（別系統の説明可能性）

---

## 3. 手法（設計原則と判断根拠）

### 3.1 全体設計（3段カスケード）

<!-- CHANGED: TODO-7 — 設計思想を「確信度に基づくhandoff」として明文化し、用語定義・集合定義を追加 -->

**設計思想**: 分類器の出力確率に基づき、確信度の高い領域を自動判定（auto-decision）し、確信度の低い領域（gray zone）のみを高コストな後段へ送る（handoff）。目的は「どのケースを自動判定し、どのケースを精査に回すか」を制御することにある。

- Stage1: XGBoost（全件の高速スクリーニング → 三値ルーティング）
- Stage2: LR + 証明書ゲート（handoff領域の信頼性推定と投入制御）
- Stage3: LLMエージェント + ルール（困難ケースの精査、根拠提示）

#### 用語定義

本論文で用いる用語を以下に定義する。

| 用語 | 定義 |
|------|------|
| **Auto-decision（自動判定）** | Stage1またはStage2が後段に送らず確定した判定。auto_phishing、auto_benign、drop_to_auto の総称 |
| **Handoff（投入）** | 当該Stageで判定を確定せず、後段へ送ること |
| **Gray zone（低確信度領域）** | Stage1出力確率 p₁ が自動判定閾値の範囲外にある領域（t_low < p₁ < t_high）。ここに属するドメインは Stage2 へ handoff される |
| **Difficult subset（困難集合）** | Stage1・Stage2 の両方で自動判定されず Stage3 に到達した集合（n=11,952）。Stage3の評価指標はすべてこの集合上の値である |
| **Stage3 call rate（投入率）** | テスト全体に対する Stage3 投入件数の割合 = \|difficult subset\| / \|D_test\| |
| **Auto-decision error（自動判定誤り）** | 自動判定された集合における誤分類の件数。auto_decision_errors = 401件（115,270件中、誤り率 0.348%）|

### 3.2 Stage1: XGBoost（三値ルーティング）
- 入力特徴量: 42個（ドメイン構造15、証明書27）
- 出力: フィッシング確率 p₁ ∈ [0, 1]
- 位置づけ: 高確信度領域を高速・高精度に確定し、gray zone を後段に送る

<!-- CHANGED: TODO-7 — 三値ルーティングの擬似コードを追加。実装のt_high/t_lowを反映 -->

**三値ルーティング（Algorithm 1）**:

```
Input:  ドメイン x、閾値 t_high = 0.957, t_low = 0.001
Output: {auto_phishing, auto_benign, handoff}

p₁ ← XGBoost(x)          // フィッシング確率
if p₁ ≥ t_high then
    return auto_phishing   // 高確信度フィッシング
else if p₁ ≤ t_low then
    return auto_benign     // 高確信度正規
else
    return handoff          // gray zone → Stage2へ
```

- t_high, t_low は訓練データの5-fold CVでFPR/FNR制約から決定（§4.1.4参照）
- 実測: auto_phishing 60,767件（47.8%）、auto_benign 8,464件（6.7%）、handoff 57,991件（45.6%）

### 3.3 Stage2: 誤り確率推定 + 証明書ゲート

<!-- CHANGED: TODO-7 — cert gate仕様境界を明文化。適用順序・優先度・auto-decision error定義の一意性を担保 -->

Stage2 は Stage1 の handoff 領域（57,991件）を受け取り、**証明書ハードゲート**と**LR誤り確率推定**の組合せにより、Stage3 投入件数を制御する。

#### 適用順序（仕様境界の明確化）

Stage2 の判定は以下の順序で適用される。**証明書ゲートはハードゲート**であり、LR の p_error より先に評価される。

```
Input:  handoff集合 D_handoff (57,991件)
Output: {drop_to_auto, handoff_to_agent}
Params: τ = 0.4 (p_error閾値), τ_override = 0.3 (高ML強制投入閾値)

for each x in D_handoff:
    p_err ← LogisticRegression(features(x))   // Stage1誤り確率

    // Step 1: 証明書ハードゲート（safe_benign判定として先にdrop）
    cert_safe ← has_CRL(x) OR is_OV_EV(x) OR is_wildcard(x) OR long_validity(x)
    cert_risky ← is_dangerous_TLD(x)

    // Step 2: 投入判定
    if cert_risky then
        → handoff_to_agent                     // 危険TLD → 必ずStage3
    else if p₁(x) ≥ τ_override then
        → handoff_to_agent                     // 高MLスコア → 強制Stage3投入
    else if cert_safe AND p_err < τ then
        → drop_to_auto                         // 安全な証明書 + 低誤り確率 → 自動判定
    else if p_err ≥ τ then
        → handoff_to_agent                     // 高誤り確率 → Stage3
    else
        → drop_to_auto                         // その他 → 自動判定
```

#### 仕様上の重要な性質

| 性質 | 内容 |
|------|------|
| **cert gate優先** | 証明書ゲートでdropされた行は、p_error の値に関わらず Stage3 に送られない |
| **override優先** | p₁ ≥ τ_override (0.3) の行は、cert_safe であっても Stage3 へ強制投入される |
| **auto-decision error の一意性** | 上記の適用順により、どのドメインが「自動判定」に分類されるかが一意に決まる。auto-decision error = 自動判定集合（115,270件）内の誤分類 401件（0.348%） |

#### 実測値（table4_stage2_effect.csv）
- safe_benign（LR base）: 32,179件
- safe_benign_cert（証明書ゲート強化後）: 45,171件（+12,992件）
- safe_benign_combined（最終safe集合）: 45,307件
- high_ml_phish override（強制Stage3投入）: 1,718件
- **最終結果**: drop_to_auto 46,039件 / handoff_to_agent 11,952件（Stage3 call rate 9.4%）

### 3.4 Stage3: LLMエージェント + ルール統合（困難集合の精査）
<!-- CHANGED: TODO-7 — Stage3の位置付けを「difficult subsetの補正」として明示 -->
- Stage3 は **difficult subset（n=11,952）** のみを処理する。この集合は Stage1・2 で自動判定できなかったドメインであり、Stage3 の性能指標はすべてこの集合上の値である
- LLMエージェントは複数ツールの出力を統合して判定する
- ルールは証明書・TLD・ブランド偽装に関するドメイン知識に基づいて設計し、LLM出力を補正する
- 閾値（ctx_score等）は判定感度を調整するパラメータとして扱う（データから概念を発掘した立場ではない）

注: ルール一覧、モジュール数、ワークフロー詳細、クラス構造など実装詳細は補足資料に移し、本文では「どの誤りを抑制するために、どの種の知識を用いるか」を中心に記述する。

---

## 4. 評価実験（RQに対応）

### 4.1 実験設定

#### 4.1.1 データソースと証明書取得
データはPostgreSQL DB rapids_data に格納され、TLSハンドシェイクで取得したleaf証明書をDER形式で保存する。取得結果は status として記録される（SUCCESS、NOT_FOUND等）。

主要テーブルの証明書データ可用性（cert_data保有率）:
- certificates: 532,117中 196,083（36.9%）
- jpcert_phishing_urls: 222,984中 119,439（53.6%）
- phishtank_entries: 94,295中 52,808（56.0%）
- trusted_certificates: 554,801中 450,545（81.2%）

参考として、取得不能や例外の主因をstatus分布として併記する（詳細は表または付録）。
- certificates（総 532,117）: NOT_FOUND 49.2%、SUCCESS 36.9%、UNKNOWN_ERROR 7.9%、SEARCH_ERROR 5.1%、DOWNLOAD_ERROR 0.9%
- jpcert_phishing_urls（総 222,984）: SUCCESS 51.9%、NOT_HTTPS 18.7%、DUPLICATE 16.2%、NOT_FOUND 12.1% ほか
- phishtank_entries（総 94,295）: SUCCESS 52,805、NOT_FOUND 40,653、UNKNOWN_ERROR 441、SEARCH_ERROR 327 ほか
- trusted_certificates（総 554,801）: SUCCESS 81.2%、DOWNLOAD_ERROR 9.1%、NOT_FOUND 6.9%、UNKNOWN_ERROR 2.8%

#### 4.1.2 学習用データの構築と分割
- フィッシング側は複数ソース（PhishTank、JPCERT、certificates）から cert_data を保有するドメインを抽出し、ソース優先順位（PhishTank > JPCERT > certificates）により重複を解消する。
- データ準備パイプラインにより、ソース間重複排除（PhishTank/JPCERT/certificates間のドメイン重複約46,000件）、Phishing-Benign間重複排除（243件）、バランス調整を経て、最終的にPhishing 318,055件 + Benign 318,055件 = 合計636,110件を構築する。
  - 注: dataset_overview.mdの概算値（319,383件）はDB上のSUCCESSレコード数であり、重複排除・バランス調整前の値。実際のパイプライン通過後は318,055件/classとなる。
- Train/Testは80:20で分割し、**Test 127,222件（Phishing 63,611 / Benign 63,611）**、Train 508,888件。
- 特徴量抽出時の脱落は0件（train + test = 636,110 = prepared全数）。

50:50バランス学習は、手法間比較の公平性を優先する統制条件として採用する。運用では日々フィッシング証明書を収集でき、自然比率のデータで継続検証と閾値更新が可能である。運用更新は本論文のスコープ外とし、方針は6章に再掲する。

#### 4.1.3 特徴量と前処理
- 特徴量は42個（ドメイン構造15、証明書27）。
- ページ内容、HTML、スクリーンショットは利用しない（証明書とドメインのみ）。
- 乱数シード固定、重複排除基準、前処理の詳細を明記する。

#### 4.1.4 モデルと実行環境
- Stage1: XGBoost（max_depth=8, n_estimators=100, learning_rate=0.1）
  - 5-fold交差検証でROC-AUCを報告
- Stage2: Logistic Regression（p_error推定、StandardScalerで正規化）
- Stage3: Qwen3-4B-Thinking GPTQ-Int8（vLLM推論サーバ、temperature=0.1, max_tokens=512） + ルールエンジン
- 実行環境: 3GPU並列（ローカルGPU×1 + リモートGPU×2、スループット向上目的）

#### 4.1.5 評価指標

<!-- CHANGED: TODO-7 — RQごとに一次指標・補助指標を明示し、F1の位置付けを固定 -->

**RQ1（投入制御の効果）の指標**:
- 一次指標: **Stage3 call rate**（投入率）、**auto-decision error rate**（自動判定誤り率）
- 補助指標: システム全体 Precision / Recall / F1 / FPR / FNR（Table 3）
- 注: 最終 F1 は Stage3 の寄与を含む事後指標であり、投入制御そのものの評価には call rate と auto-decision error を用いる

**RQ2（ルール統合の効果）の指標**:
- 一次指標: difficult subset（n=11,952）上の **Recall 改善幅**、**FP 増加数**
- 補助指標: difficult subset 上の F1（72.33%）。ただし同値はシステム全体 F1（98.67%）と同列比較しない
- 再現性: ルール発火率（16.8%）、発火トレースの提示可能性
- 運用: 遅延分布（p50=8.31s / p90=15.27s / p99=28.59s）

### 4.2 RQ1: 投入制御の効果——call rate と auto-decision error のトレードオフ

<!-- CHANGED: TODO-7 — 一次指標（call rate, auto-decision error）を見出しレベルで明示 -->

**主張**: Stage2（LR + 証明書ゲート）により、Stage1 の handoff 領域（57,991件 = 45.6%）から Stage3 投入を 11,952件（9.4%）に圧縮し、自動判定誤り 401件（0.348%）に抑えた。

- **一次指標**（Table 4）:
  - Stage3 call rate: 9.4%（11,952 / 127,222）
  - Auto-decision total: 115,270件（90.6%）
  - Auto-decision errors: 401件（誤り率 0.348%）
  - 内訳: cert gate による safe_benign 拡張（+12,992件）、high_ml_phish override（1,718件強制投入）
<!-- CHANGED: TODO-8 — Fig.3参照を追加。閾値スイープの主張を「投入率 vs 自動判定誤り」に限定 -->
- **閾値感度分析**（図3）:
  - Stage2閾値τを0.0〜1.0でスイープし、Stage3 call rateとauto-decision errorsの関係を示す
  - 運用点 τ=0.4 では call rate=9.4%, auto-decision errors=401件
  - τを上げる（投入を減らす）と誤りが単調増加: τ=0.7 で errors=531, τ=1.0 で errors=1,447
  - **注意**: 図3は Stage1+2 の自動判定誤りのみを示し、Stage3込みの最終性能曲線ではない。最終性能はTable 3の2点比較で報告する
- **補助指標**（Table 3）:
  - Stage1+2のみ: F1=98.60%, FNR=2.27%, FPR=0.51%
  - Stage1+2+3（全段）: F1=98.67%, FNR=1.82%, FPR=0.84%
  - Stage3 追加により FNR が 0.45pt 改善する一方、FPR が 0.33pt 増加（トレードオフ）
- 遅延分布（p50/p90/p99）を報告し、投入率と合わせて運用上のスループット含意を議論する

### 4.3 RQ2: ルール統合の効果——困難集合（difficult subset, n=11,952）での Recall 改善

<!-- CHANGED: TODO-7 — 見出しに「difficult subset, n=11,952」を明記。F1の位置付けを補助に限定 -->

> **重要**: 本節の性能指標はすべて **difficult subset（n=11,952）** 上の値である。この集合は Stage1・Stage2 で自動判定できなかったドメインであり、システム全体の F1=98.67% と同列比較してはならない。

- **アブレーション**（Table 6）:
  - LLMのみ: Precision=87.69%, **Recall=55.34%**, F1=67.85%
  - LLM+ルール: Precision=76.11%, **Recall=68.92%**, F1=72.33%
  - ルール統合により **Recall が +13.58pt 改善**。Precision は 11.58pt 低下するが、困難集合での追加検知（286件の net FN→TP 転換）を得る
  - 判定変更: 811件（6.79%）がルールにより flip
- **誤り分析**:
  - 残存FN（760件）のカテゴリ、Stage3由来FP（529件）のカテゴリ
  - ルール発火の寄与（どの種のルールがどの誤りを抑制したか）
- **再現性**:
  - ルール適用は決定的（同一入力に対し同一のルール発火）。LLM出力の確率的揺らぎをルールが補正する構造により、再現性が向上する

<!-- 要相談: 指摘4 同一データセットでのベースライン（RF, LightGBM等）をどこまで追加するか。紙面と計算コストを踏まえ最小セットを検討 -->
<!-- 要相談: 指摘9 Threats to Validityの緩和策（感度分析、時系列評価、外部データ検証）を本文にどこまで入れるか。4.3末尾に短く置くか、5章に集約するか -->

---

## 5. 議論

### 5.1 各Stageの役割と相補性

<!-- CHANGED: TODO-7 — 各Stageの役割を「確信度ベースの制御構造」として一貫記述し、防御線を再掲 -->
- Stage1: 確信度に基づく三値ルーティング。高確信度領域を高速に確定し、gray zone を定義する
- Stage2: gray zone に対する信頼性推定と投入制御。証明書ハードゲートにより安全側を優先的にdropし、投入率を 45.6% → 9.4% に圧縮
- Stage3: difficult subset の精査。ルール統合により LLM 出力を補正し、Recall 改善と説明可能性を両立

> **一般化可能性**: 本研究の制御構造（三値ルーティング → 信頼性ゲート → ルール補正）は Stage1 の分類器に依存しない。Stage1 を LightGBM や Random Forest に置き換えても、handoff 閾値の再調整のみで同一の枠組みが適用できる。この点は、提案の貢献がモデル選択ではなく制御構造にあることを示している。

### 5.2 投入制御のトレードオフ
<!-- CHANGED: TODO-7 — 「FP/FNトレードオフ」→「投入制御のトレードオフ」に改題。FN追跡ではなく投入制御の観点で記述 -->
- Stage3 追加により FNR が 0.45pt 改善する一方、FPR が 0.33pt 増加する。これは difficult subset にFP源が集中する構造的帰結であり、投入制御の粒度で調整可能である
- 投入率と遅延分布を合わせ、「どこまで Stage3 に送るか」のコスト・ベネフィットを議論する
- auto-decision error rate（0.348%）は、115,270件の自動判定に対する誤り件数であり、運用上許容可能な水準かを被害コストの観点で評価する

<!-- CHANGED: TODO-3 — 脅威を「脅威＋緩和策＋残る限界」の3点セットに構造化。既存データ(Fig3/Table2/Fig5/付録表A)への参照を追加 -->
### 5.3 妥当性への脅威（Threats to Validity）

本節では、結果の解釈に影響しうる脅威を列挙し、実施済みの緩和策と残る限界を明示する（表7に要約）。

**T1. 観測バイアス（構成妥当性）**: フィッシングと正規で証明書取得成功率が異なるため（表2: フィッシング36.9〜56.0% / 正規81.2%）、本研究は証明書データを観測できた集合に条件づけられる。
- 緩和策: 証明書保有率とステータス分布を表2に明示し、適用範囲を定量化した。学習・評価は証明書保有ドメインのみで一貫して行い、欠損補完は行っていない
- 残る限界: 証明書を取得できないドメイン（NOT_FOUND等）への汎化性は検証していない
- 今後課題: Certificate Transparency (CT) ログとの連携により、観測窓を拡大した検証

**T2. 時間差（内的妥当性）**: URL報告日時と証明書ダウンロード日時の間に遅延があり、証明書の更新・失効が介在しうる。
- 緩和策: 本データセットでは報告後速やかにCT/直接接続で証明書を収集しており、大半は報告から数日以内に取得している
- 残る限界: 報告〜取得間の証明書変更率は定量化していない
- 今後課題: 時系列分割評価（temporal split）によるconcept drift検証

**T3. HTTPS未使用（外的妥当性）**: jpcertソースにおいてNOT_HTTPS比率は18.7%（表2）であり、本手法はHTTP-onlyサイトに適用できない。
- 緩和策: 近年のフィッシングサイトのHTTPS化率は急速に上昇しており、本手法の適用対象は拡大傾向にある。本研究ではHTTPS保有ドメインに限定した評価を行い、その範囲で有効性を示した
- 残る限界: HTTP-onlyフィッシングの特性が異なる場合、本研究の結論は直接適用できない

**T4. ラベルノイズ（内的妥当性）**: フィードに報告されたドメインの無害化（テイクダウン済み）や再利用（正規に転用）がラベル品質に影響しうる。
- 緩和策: 3つの独立したフィッシングソース（JPCERT, PhishTank, CT証明書DB）を統合し、単一ソースの偏りを抑制した。Stage3のFNをソース別に分析した結果（図5: JPCERT=387, PhishTank=232, CT=141）、特定ソースへの偏りはなく、FNのMLスコア中央値は0.14と低確信度域に集中しており、ラベルノイズよりも検知困難な特性に起因する可能性が高い
- 残る限界: ラベルの手動検証は実施していない
- 今後課題: ラベル品質の定量的評価（再訪問によるアクティブ検証）

**T5. 投入制御閾値の感度（内的妥当性）**: Stage2の投入閾値τは評価データ上で選択しており、過剰適合のリスクがある。
- 緩和策: 図3のτスイープ分析（τ=0.0〜1.0, 51点）により、auto-decision errorsはτ=0.3〜0.5の範囲で396〜427件（変動率±7.5%）と安定しており、急激な性能劣化（cliff effect）は観察されない。τ=0.4の選択は広い安定域の中間点にある
- 残る限界: 未知の分布（異なる時期・地域のフィッシング）でのτの最適性は検証していない
- 今後課題: 異なるドメイン集合でのτ交差検証

**T6. ルール閾値の調整（構成妥当性）**: ドメイン知識ルールの判定閾値は評価データ上の性能を参考に調整している。ルールの概念自体（DV証明書の検出、TLD危険度等）はデータ非依存だが、閾値の汎化性は未知のデータで検証が必要である。
- 緩和策: ルール発火率は16.8%（2,011/11,952件）であり、811件のflip（LLM判定の変更）のうち正答率は49.57%（表6）。ルール効果はRecallを+13.58pt改善する一方、flip精度が約5割であることは過補正のリスクを示しており、本文で明示的に報告している
- 残る限界: 閾値の汎化性は外部データでの検証が必要
- 今後課題: holdout期間データでのルール効果の再現性検証

**T7. 分類器選択（構成妥当性）**: Stage1のXGBoostを同一42特徴量・同一splitでLightGBM・RandomForestに置き換えた場合の性能を付録表Aに示す。全モデルのF1は98.58〜98.66%の範囲であり、Stage1分類器の選択がシステム全体の結論に実質的な影響を与えないことを確認した。

**T8. 処理遅延（外的妥当性）**: Stage3のLLM推論は中央値8.31秒、p90=15.27秒、p99=28.59秒（図4）の遅延を伴う。ただし投入率を9.4%に抑制しているため、システム全体のスループットへの影響は限定的である。リアルタイム遮断ではなくバッチ監視やアラート用途を想定する場合、この遅延は許容範囲である。

<!-- CHANGED: TODO-3 — スコープ宣言をThreatsの末尾に配置（推奨案） -->
> **スコープ宣言**: 三値学習（0/gray/1のラベルでの直接学習）、uncertainty calibration（確率出力の事後較正）、Stage1分類器の最適化はいずれも自然な拡張であるが、本稿のスコープは分類器の性能最適化ではなく、**確信度ベースの投入制御とルール統合の枠組みの効果検証**にある。これらの拡張は、本枠組みの上で独立に適用可能であり、今後の課題とする。

<!-- 表7: Threats要約（本文中に配置 or Appendix） -->
#### 表7: 妥当性への脅威と緩和策の要約

| 脅威 | 分類 | 緩和策（実施済み） | 残る限界 |
|------|------|-------------------|---------|
| T1. 観測バイアス | 構成 | 証明書保有率を表2で明示、保有ドメインに限定した一貫評価 | 証明書未取得ドメインへの汎化性 |
| T2. 時間差 | 内的 | 報告後速やかに収集 | 証明書変更率の定量化なし |
| T3. HTTPS未使用 | 外的 | HTTPS保有ドメインに限定した評価 | HTTP-onlyフィッシングは対象外 |
| T4. ラベルノイズ | 内的 | 3ソース統合、FNのソース/MLスコア分析（図5） | 手動検証なし |
| T5. 投入制御閾値 | 内的 | τスイープ分析: 安定域τ=0.3〜0.5で変動±7.5%（図3） | 異分布でのτ最適性 |
| T6. ルール閾値 | 構成 | flip率・精度を表6で明示報告 | 外部データでの閾値汎化性 |
| T7. 分類器選択 | 構成 | 3分類器比較でF1差0.08pt以内（付録表A） | — |
| T8. 処理遅延 | 外的 | 投入率9.4%で影響を限定（図4: p50=8.31s） | リアルタイム遮断には不向き |

### 5.4 倫理的配慮（Ethical Considerations）
- フィッシングデータの再配布方針と伏字方針
- 誤検知の影響と運用フロー（遮断前の確認）
- 攻撃者に有用な詳細の取り扱い（ルール詳細・閾値の公開粒度を抑制）
- 個人情報を扱わない（ドメインと証明書メタデータ中心）

---

## 6. まとめ

<!-- CHANGED: TODO-7 — まとめの記述を一次指標ベースに更新 -->
- Stage2 の投入制御により Stage3 call rate を 9.4% に圧縮し、auto-decision error rate 0.348% でシステム全体 F1=98.67% を維持できることを示した（RQ1）
- difficult subset（n=11,952）においてルール統合が Recall を +13.58pt 改善し、ルール発火トレースにより説明可能性と再現性を付与できることを示した（RQ2）
- 提案の投入制御とルール統合の枠組みは Stage1 の分類器選択に依存せず、任意の確率出力モデルに適用可能である
- 学習は50:50の統制条件で実施したが、運用では日々の証明書収集に基づき自然比率データで継続検証と閾値更新を行う方針である（運用更新は本論文のスコープ外）

---

## 図表計画（合計12程度）

図（5本程度）:
- 図1: 3段カスケード全体アーキテクチャ
- 図2: Stage遷移の件数推移（Sankeyまたは棒グラフ）
<!-- CHANGED: TODO-8 — Fig3の主張をCSVデータ（fig3_threshold_sweep.csv）に合わせ修正。「全体性能」ではなくStage1+2の自動判定誤りに限定 -->
- 図3: Stage3 call rate vs 自動判定誤り（Stage1+2のauto-decision errors、τスイープ）
- 図4: Stage3遅延分布（p50/p90/p99を含むCDF等）
- 図5: 誤り分析（残存FNと増加FPのカテゴリ分布）

表（7本程度）:
- 表1: データセット構築内訳（ソース別件数、重複排除、Train/Test）
- 表2: 証明書可用性とstatus分布要約（ソース別）
<!-- CHANGED: TODO-7 — 表キャプションに一次指標・difficult subset を反映 -->
- 表3: システム全体性能（Stage1+2 vs Stage1+2+3）— RQ1補助指標
- 表4: Stage2投入制御効果（call rate、auto-decision error）— RQ1一次指標
- 表5: Stage3性能（**difficult subset, n=11,952**）とルール発火率 — RQ2
- 表6: Stage3アブレーション（LLMのみ vs LLM+ルール、**difficult subset上**）— RQ2
- 表7: Threats to Validityの要約と緩和策（簡潔）

<!-- CHANGED: TODO-1 — Appendix表を追加 -->
付録:
- 付録表A: Stage1分類器のベースライン比較（XGBoost / LightGBM / RandomForest、同一42特徴量・同一split）

---

## 想定ページ数（CSS 8ページ厳守）

| セクション | ページ数 |
|----------|---------|
| 1. はじめに | 0.8 |
| 2. 関連研究 | 1.0 |
| 3. 手法 | 1.4 |
| 4. 評価実験 | 3.1 |
| 5. 議論 | 1.4 |
| 6. まとめ | 0.3 |
| 参考文献 | 0.0〜0.2（調整） |
| 合計 | 8.0 |

---

## 検証済み数値リファレンス（2026-02-07 SO再評価後・全件修復済み）

> 以下は `artifacts/2026-02-02_224105/results/` 配下のCSVから直接計算した権威的な数値である。
> 論文執筆時はこの数値を使用すること。
>
> 2026-02-07: SO (Structured Output) parse failure 16件全件を再評価して修復済み。
> Table5/Table6 ともに n=11,952 で完全一致。

### データセット
| 項目 | 値 |
|------|-----|
| DB概算 (重複排除前) | 319,383件/class × 2 = 638,766件 |
| **パイプライン通過後** | **318,055件/class × 2 = 636,110件** |
| **Train** | **508,888件 (Phishing 254,444 / Benign 254,444)** |
| **Test** | **127,222件 (Phishing 63,611 / Benign 63,611)** |
| 差異の原因 | ソース間重複排除、Phishing-Benign間重複排除(243件)、バランス調整 |
| 特徴量抽出時の脱落 | 0件 |

### Stage1 ルーティング（stage1_decisions_latest.csv: 127,222行）
| 判定 | 件数 | 割合 | TP | FP | TN | FN |
|------|------|------|---:|---:|---:|---:|
| auto_phishing | 60,767 | 47.8% | 60,765 | 2 | - | - |
| auto_benign | 8,464 | 6.7% | - | - | 8,461 | 3 |
| handoff | 57,991 | 45.6% | - | - | - | - |
| **自動判定合計** | **69,231** | **54.4%** | **60,765** | **2** | **8,461** | **3** |

### Stage2 振り分け（stage2_decisions_latest.csv: 127,222行）
| 判定 | 件数 | 割合 | y_true=0 | y_true=1 |
|------|------|------|---------|---------|
| not_candidate (Stage1自動) | 69,231 | 54.4% | - | - |
| drop_to_auto | 46,039 | 36.2% | 45,641 | 398 |
| handoff_to_agent | 11,952 | 9.4% | 9,507 | 2,445 |

Stage2証明書ゲート内訳:
- base safe_benign: 32,179件
- cert gate追加: 13,128件（net safe_benign_cert: 45,171件）
- phishing gate: 8件
- safe_benign_combined: 45,307件

### Stage3 評価（eval CSV: 11,952行）
| 項目 | 値 |
|------|-----|
| TP | 1,685 |
| FP | 529 |
| TN | 8,978 |
| FN | 760 |
| Precision | 76.11% |
| Recall | 68.92% |
| F1 | 72.33% |
| FPR | 5.56% |
| 処理時間 平均 | 9.22秒 |
| 処理時間 p50 | 8.31秒 |
| 処理時間 p90 | 15.28秒 |
| 処理時間 p99 | 28.60秒 |
| ルール発火件数 | 2,011件 (16.8%) |
| エラー件数 | 0件 |

### システム全体（全Stage合算）
| 項目 | 値 |
|------|-----|
| TP | 62,453 |
| FP | 532 |
| TN | 63,079 |
| FN | 1,158 |
| **Precision** | **99.16%** |
| **Recall** | **98.18%** |
| **F1** | **98.67%** |
| FPR | 0.84% |
| FNR | 1.82% |
| 自動判定率 | 90.6% (115,270/127,222) |
| Stage3投入率 | 9.4% (11,952/127,222) |

### データソース
- `artifacts/2026-02-02_224105/results/stage1_decisions_latest.csv` (127,222行)
- `artifacts/2026-02-02_224105/results/stage2_decisions_latest.csv` (127,222行)
- `artifacts/2026-02-02_224105/results/stage2_decisions_candidates_latest.csv` (57,991行)
- `artifacts/2026-02-02_224105/results/stage2_validation/eval_20260205_230157/eval_df__nALL__ts_20260205_230158.csv` (11,952行、SO再評価マージ済み)
- `artifacts/2026-02-02_224105/results/stage2_budget_eval.json` (Stage2設定記録)
