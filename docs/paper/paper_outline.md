# 論文骨子: 3段カスケード型フィッシング検出システム

作成日: 2026-02-06  
最終更新: 2026-02-06  
前論文: CSS2025「機械学習とAIエージェントを組み合わせたハイブリッド型フィッシングサイト検出システムの開発と評価」

更新履歴:
- 2026-02-06: 初版作成
- 2026-02-06: dataset_overview.md のDB実測値を反映（証明書取得ステータス、可用性、データ構築プロセス、特徴量数を明記）。Research Questions、アブレーション、閾値感度、時系列評価、キャリブレーション、倫理項目、妥当性への脅威を追記。

---

## CSS2025 → 新論文の進化ポイント

| 観点 | CSS2025 | 新論文 |
|------|---------|------|
| アーキテクチャ | 2段階（ML → AI Agent） | <b>3段階（ML → Error Gate → AI Agent + Rule Engine）</b> |
| データ規模 | 640,356件 | 学習+評価 638,766件（Train 511,012 / Test 127,754、50:50バランス） |
| Stage2 | なし | <b>LR（誤り確率推定）+ 証明書ゲートによる投入制御</b> |
| AI Agent | LLM単体判定 | <b>LLM + 証明書ドメイン知識ルール統合</b> |
| 主要論点 | 低確信度領域の偽陰性削減 | Stage2による投入率削減と、Stage3のルール統合効果の定量化 |
| 偽陰性分析 | 記述的（事例中心） | 体系的（スコア領域別、検知パターン別、ルール発火統計） |
| 説明可能性 | reasoning出力のみ | リスク要因の列挙 + ルール発火トレース |
| ルール設計 | インライン実装 | モジュール化（個別有効化、テスト容易性） |

---

## タイトル案

日本語:
- 「3段カスケード型ハイブリッドフィッシング検出システムにおけるルールエンジン統合の効果分析」

英語:
- "Effect Analysis of Rule Engine Integration in a Three-Stage Cascade Hybrid Phishing Detection System"

代替案:
- 「証明書特徴に基づく3段カスケード型フィッシング検出における偽陰性の体系的分析」
- 「機械学習モデルの判定境界域におけるAIエージェントとルールエンジンの相補的検出効果」
- "Systematic Analysis of False Negatives in Three-Stage Cascade Phishing Detection Using Certificate Features"

---

## 論文構成

### 1. はじめに

#### 1.1 動機・背景
- フィッシング被害の深刻化
- SSL/TLS普及により従来の単純なHTTPS有無では安全判断が困難
- CSS2025で、MLによる高速スクリーニングとLLMエージェントの二段構えを提示

#### 1.2 CSS2025の残課題（本論文の出発点）
- Stage2相当の投入制御がなく、handoff候補に対するLLM処理が計算コストの制約となる
- LLM単体判定に依存すると、再現性、安定性、説明可能性に限界がある
- 偽陰性要因の分析が事例ベースに留まり、体系性が不足
- 「高確信度で間違える」ケースへの設計が弱い（確信度の定義と運用が未整理）

#### 1.3 Research Questions（RQ）
本論文は、3段カスケード化により「どこで何が改善されたか」を因果に近い形で示すことを目的とし、以下のRQを設定する。

- RQ1: Stage2（誤り確率推定 + 証明書ゲート）は、Stage3投入率をどこまで低減できるか。性能指標（Recall/FNR、Precision/FPR）とのトレードオフはどうなるか。
- RQ2: Stage3における知識ルール統合は、LLM単体に比べてどの程度、性能と再現性（同一入力での一貫性）と説明可能性（根拠のトレース性）を改善するか。
- RQ3: Stage3のみが検知できたフィッシングはどのような特徴を持ち、Stage1/Stage2が見落とす構造的要因は何か。
- RQ4: 取得時刻のずれ、ソース差、ターゲット差などの分布変化の下でも、Stage2/Stage3の効果は維持されるか。

#### 1.4 本論文の貢献
- 貢献1: Stage2（誤り確率推定層）の新設。Stage1の信頼性をLRで推定し、証明書属性ゲートと組み合わせることでStage3投入率を制御する。
- 貢献2: Stage3におけるドメイン知識ルールの統合。LLM出力を証明書分野の専門知識で補正し、再現性と説明可能性を強化する。
- 貢献3: 偽陰性の体系的分析。MLスコア領域別、検知パターン別に定量化し、各Stageの役割と限界を明示する。
- 貢献4: コストと精度のトレードオフを含む運用指標（Stage3投入率、遅延分布）を提示し、実用性の議論を可能にする。

#### 1.5 論文構成
第2章で関連研究、第3章で提案手法、第4章で評価、第5章で議論（妥当性・倫理を含む）、第6章でまとめ。

---

### 2. 関連研究

#### 2.1 機械学習によるフィッシング検出
- URL/ドメイン特徴量によるML検出
- 証明書特徴量の活用
- 勾配ブースティング（XGBoost等）の有効性
- 共通課題: ブラックボックス性、誤り要因の体系的分析不足、分布変化への弱さ

#### 2.2 LLMによるフィッシング検出
- 大型LLMによる高精度化とコスト問題
- 小型LLMや量子化による実用化の方向性
- 共通課題: 全件LLM処理の非効率性、再現性、説明性

#### 2.3 マルチエージェント型検出
- 複数の専門エージェントを組み合わせた検出（Debateなど）
- 共通特徴: 大型LLM前提、全件処理寄り、運用コストが高い

#### 2.4 ハイブリッド手法
- MLによる絞り込み + LLM精査（トリアージ）
- CSS2025の二段設計と本研究の三段拡張の位置づけ

#### 2.5 説明可能AI（XAI）とルール統合
- SHAP/LIME等で特徴を説明し、LLMで自然言語化する流れ
- ルールエンジンによる決定過程のトレースは別系統の説明可能性として位置づけ

#### 2.6 本研究の位置づけ
- 新規性マトリクス（表）:
  - 3段カスケード（誤り確率推定層を含む）
  - 小型LLM（ローカルGPU完結）
  - 証明書とドメイン構造のみ（ページ取得不要）
  - 専門知識ルールによる再現性と説明可能性の強化
  - Stage2/Stage3の相対効果をアブレーションで示す

---

### 3. 提案手法

#### 3.1 全体設計
3段カスケードの目的は「容易なケースは高速に自動判定し、困難なケースのみ高コストな精査へ送る」ことである。

```
Stage1: XGBoost            高速スクリーニング（全件）
Stage2: LR + Cert Gate     Stage1の信頼性判定と投入制御
Stage3: LLM Agent + Rules  境界域の精査と根拠提示
```

#### 3.2 Stage1: XGBoostによる高速スクリーニング
- 特徴量: 42個
  - ドメイン構造: 15個（長さ、ドット数、エントロピー等）
  - 証明書: 27個（有効期間、SAN、OCSP/CRL、SCT、鍵種別、Let's Encrypt判定等）
- 出力: フィッシング確率 p1 としきい値により auto_phishing / auto_benign / handoff に分岐
- 解析: Feature Importance、誤りのスコア領域分析

#### 3.3 Stage2: 誤り確率推定と証明書ゲートによる投入制御
設計意図は、Stage1の出力をそのまま使うのではなく「Stage1が間違っていそうか」を推定し、Stage3投入を最適化すること。

- 主メカニズム: LRによる p_error 推定
  - 入力: Stage1と同等の特徴量 + Stage1出力由来特徴（p1、マージン等の不確実性指標）
  - 目的変数: Stage1判定が誤りか否か
  - 学習: Stratified CVとOOF予測で閾値選定（データリーク抑制）
- 補助メカニズム: 証明書属性ゲート
  - 例: OCSP/CRLの有無、組織情報の有無、ワイルドカード、有効期間など
  - 目的: LRの誤りを、決定的条件で抑制または補強
- TLDリスク制御
  - 危険TLDではゲートを弱め、過剰な正常判定を抑制する

#### 3.4 Stage3: LLMエージェントとルールエンジンの統合
- AI Agent構成
  - LangGraphベースのワークフロー
  - 小型LLM（例: Qwen3-4B量子化）を推論サーバで運用
  - 4種分析ツール（ブランド偽装、証明書解析、コンテキストリスク、短ドメイン）
  - Structured Output: is_phishing, confidence, risk_factors, reasoning
- ドメイン知識ルール（ポストプロセッサ）
  - 目的: LLM判定を専門知識で補正し、再現性と説明可能性を担保
  - カテゴリ:
    - 証明書信頼性: 認証局種別、組織情報、拡張の有無
    - ブランド偽装: ブランド類似やタイポスクワッティング
    - 複合条件: 低品質証明書 + ブランド類似などの条件結合
  - モジュール化: 個別ルールの有効化、閾値調整、発火ログの保存

---

### 4. 評価実験

#### 4.1 実験設定

##### 4.1.1 データソースと証明書取得
データはPostgreSQL DB rapids_data に格納され、TLSハンドシェイクで取得したleaf証明書をDER形式で保存する。取得結果は status として記録される（SUCCESS、NOT_FOUND等）。

主要テーブルの証明書データ可用性（cert_data保有率）は以下の通り。
- certificates: 532,117中 196,083（36.9%）
- jpcert_phishing_urls: 222,984中 119,439（53.6%）
- phishtank_entries: 94,295中 52,808（56.0%）
- trusted_certificates: 554,801中 450,545（81.2%）

参考として、取得不能や例外の主因をstatus分布として併記する（詳細は表または付録）。
- certificates（総 532,117）: NOT_FOUND 49.2%、SUCCESS 36.9%、UNKNOWN_ERROR 7.9%、SEARCH_ERROR 5.1%、DOWNLOAD_ERROR 0.9%
- jpcert_phishing_urls（総 222,984）: SUCCESS 51.9%、NOT_HTTPS 18.7%、DUPLICATE 16.2%、NOT_FOUND 12.1% ほか
- phishtank_entries（総 94,295）: SUCCESS 52,805、NOT_FOUND 40,653、UNKNOWN_ERROR 441、SEARCH_ERROR 327 ほか
- trusted_certificates（総 554,801）: SUCCESS 81.2%、DOWNLOAD_ERROR 9.1%、NOT_FOUND 6.9%、UNKNOWN_ERROR 2.8%


##### 4.1.2 学習用データの構築と分割
- フィッシング側は複数ソース（PhishTank、JPCERT、certificates）から cert_data を保有するドメインを抽出し、ソース優先順位（PhishTank > JPCERT > certificates）により重複を解消する。
- フィッシング 319,383件に合わせ、trusted_certificates から同数をサンプリングし、50:50バランスデータ（合計 638,766件）を構築する。
- Train/Testは80:20で分割し、Testは127,754件（Phishing 63,877 / Benign 63,877）とする。
- ソース別内訳（Test）:
  - certificates 38,044
  - jpcert 22,401
  - phishtank 3,432
  - trusted 63,877

##### 4.1.3 特徴量と前処理
- 特徴量は42個（ドメイン構造15、証明書27）。
- ページ内容、HTML、スクリーンショットは利用しない（証明書とドメインのみ）。
- 乱数シード固定、重複排除基準、前処理の詳細を明記する。

##### 4.1.4 モデルと実行環境
- Stage1: XGBoost
  - 5-fold交差検証でROC-AUCを報告
- Stage2: Logistic Regression（p_error推定）
- Stage3: 小型LLM（vLLM推論） + ルールエンジン
- 実行環境: 3GPU並列（ローカル1 + リモート2）

##### 4.1.5 指標
- 性能: Precision, Recall, F1, FPR, FNR, PR-AUC
- 運用: Stage3投入率（handoff率）、自動判定率、遅延分布（p50/p90/p99）
- 確信度: キャリブレーション（ECE、信頼度曲線）、Stage2のp_error整合性

#### 4.2 Stage1: XGBoostの性能
- 基本性能（Test 127,754件）
- 特徴量重要度
- handoff候補分布（phishing/benignの内訳）

#### 4.3 Stage2: LR + ゲートの効果
- p_error推定性能（AUC、PR-AUC、キャリブレーション）
- Stage3投入率の削減効果と性能トレードオフ
- 自動判定の誤り率（auto error rate）
- アブレーション（Stage2分解）:
  - Stage1のみ
  - Stage1 + LRのみ
  - Stage1 + ゲートのみ
  - Stage1 + LR + ゲート
  - Stage1 + LR + ゲート + TLD制御（可能なら）

#### 4.4 Stage3: AI Agent + ルールエンジンの性能
- Stage3単体性能（handoff集合上）
- ルール統合の効果（Stage3アブレーション）:
  - LLMのみ
  - ルールのみ（同じ入力から決定ルールで判定）
  - LLM + ルール（提案法）
- ツールアブレーション（任意）:
  - 4ツールのうち、どれを無効化すると性能が落ちるか

#### 4.5 システム全体の性能
- Stage1+2 と Stage1+2+3 の比較（Stage3の純貢献）
- FN削減とFP増加のトレードオフ（FN:FP比）
- 運用指標:
  - 全体遅延（平均に加え、p50/p90/p99）
  - Stage3投入率に対するスループットの変化

#### 4.6 追加分析（妥当性と一般化の補強）
- 閾値感度分析
  - Stage2のp_error閾値、主要ゲート閾値、主要ルール閾値をスイープし、性能と投入率の感度を示す
- 時系列評価
  - 期間で分割し、学習→未来評価で性能と投入率を比較する（可能ならソース別にも実施）
- 実分布評価（任意）
  - 1:9や1:99など疑似不均衡分布を構築し、PR-AUCとFPRの変化を示す
- 誤り分析
  - 残存FNと増えたFPを分類し、構造的限界と改善余地を議論する

#### 4.7 関連研究との比較
- 既報の性能比較（注意: データセット差異を明記）
- 同一データ上でのベースライン（可能な範囲で）:
  - Random Forest, LightGBM等
  - LLM全件適用（サブセットでコスト込み提示）

---

### 5. 議論

#### 5.1 各Stageの役割と相補性
- Stage1: 高速スクリーニング
- Stage2: Stage1信頼性の推定と投入制御（メタ学習）
- Stage3: 専門知識ルールでLLM判定を固定化し、境界域を精査

#### 5.2 ドメイン知識によるML補完の意義
- MLが苦手な領域（低スコアでも危険なケース）を、証明書品質、TLDリスク、ブランド偽装の複合で補う
- 説明可能性: リスク要因とルール発火トレース
- 再現性: ルールにより同一条件で同一の補正を保証

#### 5.3 FP/FNトレードオフの合理性
- 見逃し防止と誤検知増のトレードオフを、運用コストと被害コストの観点で評価する
- 閾値感度分析の結果と整合させる

#### 5.4 証明書ベース早期検知の優位性
- ページ取得不要、稼働前検知（CT監視等）との接続可能性
- 既存研究（HTML/画面取得前提）との差分

#### 5.5 制約事項と妥当性への脅威（Threats to Validity）
- 計算資源要件（GPU VRAM等）
- 処理時間とスループット（平均だけでなく分布を提示）
- 言語依存性（ブランド辞書、多言語ターゲット）
- データの観測バイアス
  - フィッシングと正規で証明書取得成功率が異なる（可用性の差）
  - 本研究は cert_data を観測できる集合に条件づけられる
- 時間差
  - URL報告日時と証明書ダウンロード日時に差があり、報告時点と異なる証明書を取得している可能性
- NOT_HTTPS
  - 一部データはHTTPS未使用で証明書が存在しないため、提案手法の適用範囲外
- ラベルノイズ
  - 時間経過により無害化、削除、再利用が起き得る

緩和策:
- アブレーション、閾値感度、時系列評価により過剰適合と脆弱性を検証する
- 比較実験は同一の観測可能集合上で実施し、相対効果の内的妥当性を重視する

#### 5.6 倫理的配慮（Ethical Considerations）
- フィッシングデータの取り扱い（再配布方針、共有範囲）
- 誤検知の影響（正規サイト遮断等）と運用フロー
- 攻撃者に有用な詳細の非公開（ルールや閾値の公開粒度）
- 個人情報を扱わないことの明記（ドメインと証明書メタデータ中心）

#### 5.7 今後の課題
- Stage2のFN削減とキャリブレーション改善
- 時系列評価の拡充（ゼロデイ検知）
- 説明可能性の深化（反事実的説明、ルールの学習化）
- ルール知見をML再学習へ反映する適応的特徴量学習

---

### 6. まとめ
- CSS2025の二段階システムを三段階に拡張し、投入制御（Stage2）と知識ルール統合（Stage3）を導入した
- Stage2によりStage3投入を抑制しつつ、境界域の見逃しを低減する設計を示した
- Stage3で、ML単体では捉えにくいパターンを専門知識ルールとLLMで補完し、説明可能性と再現性を強化した
- 偽陰性の体系的分析により、各Stageの限界と役割分担を定量化した

---

## 図表計画

### 図
| # | 内容 | 対応セクション |
|---|------|-------------|
| 図1 | 3段カスケード全体アーキテクチャ | 3.1 |
| 図2 | XGBoost学習曲線 | 4.2 |
| 図3 | 特徴量重要度（Top-k） | 4.2 |
| 図4 | Stage3投入率と性能のトレードオフ曲線 | 4.3 or 4.5 |
| 図5 | 閾値感度分析（Recall/FPR/投入率のスイープ） | 4.6 |
| 図6 | キャリブレーション曲線（Stage1確率、Stage2 p_error） | 4.3 |
| 図7 | 処理時間分布（p50/p90/p99） | 4.5 |
| 図8 | 時系列分割での性能推移（月別） | 4.6 |
| 図9 | Stage3検知パターン分類（棒グラフ等） | 4.6 |

### 表
| # | 内容 | 対応セクション |
|---|------|-------------|
| 表1 | データセット構築の内訳（ソース別件数、Train/Test） | 4.1 |
| 表2 | 証明書データ可用性とstatus分布要約（テーブル別） | 4.1 |
| 表3 | Stage1性能指標 | 4.2 |
| 表4 | Stage2アブレーション結果（LRのみ、ゲートのみ等） | 4.3 |
| 表5 | Stage3混同行列とアブレーション（LLMのみ、ルールのみ等） | 4.4 |
| 表6 | 全体性能（Stage1+2 vs Stage1+2+3） | 4.5 |
| 表7 | 残存FNと増加FPの分類 | 4.6 |
| 表8 | 関連研究との比較（注意書き付き） | 4.7 |
| 表9 | 新規性マトリクス | 2.6 |

---

## CSS2025からの再利用・拡張

### 再利用可能（加筆修正）
- 1章背景
- Stage1の基本説明
- エージェント基盤（LangGraph設計思想）

### 新規執筆が必要
- Stage2（p_error推定 + ゲート）
- ルールエンジン統合（設計、モジュール化、発火トレース）
- アブレーション、閾値感度、キャリブレーション、時系列評価
- 妥当性への脅威（証明書可用性、時間差、NOT_HTTPS）
- 倫理的配慮

---

## 想定ページ数
CSSフォーマット（2段組、8ページ）を想定。

| セクション | ページ数 |
|----------|---------|
| 1. はじめに | 1.0 |
| 2. 関連研究 | 1.3 |
| 3. 提案手法 | 2.0 |
| 4. 評価実験 | 2.8 |
| 5. 議論（妥当性・倫理含む） | 0.7 |
| 6. まとめ | 0.2 |
| 参考文献 | 0.0～0.2 |
| 合計 | 8.0 |

---

## 執筆順序（推奨）
1. 4章（評価）: 図表と追加実験（アブレーション、感度、校正、時系列）を先に固める  
2. 3章（提案）: 評価で使った手続きを記述  
3. 5章（議論）: 妥当性・倫理を含めて整合を取る  
4. 2章（関連研究）  
5. 1章（はじめに）  
6. 6章（まとめ）  

---

## 論文の核心メッセージ（候補）
CSS2025の二段構成を三段に拡張し、Stage1の誤り可能性を推定するStage2と、LLM判定を専門知識で補正するルール統合を導入した。これにより、境界域の見逃し削減と計算資源制約の両立を狙い、Stage2/Stage3の相対効果をアブレーションと感度分析で定量化する。証明書とドメインのみで、ページ取得に依存しない早期検知と説明可能性（リスク要因とルール発火トレース）を実現する。
