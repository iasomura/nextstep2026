# 論文骨子: 3段カスケード型フィッシング検出における投入制御とルール統合の効果分析

作成日: 2026-02-06
最終更新: 2026-02-07

前論文: CSS2025「機械学習とAIエージェントを組み合わせたハイブリッド型フィッシングサイト検出システムの開発と評価」

更新履歴:
- 2026-02-06: 初版作成
- 2026-02-06: dataset_overview.md のDB実測値を反映（証明書取得ステータス、可用性、データ構築プロセス、特徴量数を明記）。Research Questions、アブレーション、閾値感度、時系列評価、キャリブレーション、倫理項目、妥当性への脅威を追記。
- 2026-02-07: 実データ（stage1/stage2/eval CSV）・コードとの突合レビューに基づき修正。テスト件数を127,222に訂正、Stage2基本条件・証明書ゲート詳細を追記、Stage3ルール数・モデル名・Structured Output完全仕様を反映。
- 2026-02-07: データ件数の脱落原因を調査・訂正。「特徴量抽出時の532件脱落」は誤りで、実際はデータ準備パイプラインでの重複排除・バランス調整による差異（319,383→318,055件/class）。特徴量抽出時の脱落は0件。
- 2026-02-07: 森先生レビュー指摘（RQ削減、知見ベース貢献、図表削減、手法節圧縮、Stage3 F1解釈、ページ配分）を反映（指摘1,2,3,5,6,7,10）。

---

## CSS2025 → 本論文の進化ポイント

| 観点 | CSS2025 | 本論文 |
|------|---------|------|
| アーキテクチャ | 2段階（ML → AI Agent） | 3段階（ML → Error Gate → AI Agent + Rule Engine） |
| 主要論点 | 低確信度領域の偽陰性削減 | Stage2による投入率削減と、Stage3のルール統合効果の定量化 |
| Stage2 | なし | LR（誤り確率推定）+ 証明書ゲートによる投入制御 |
| Stage3 | LLM単体判定 | LLM + 証明書ドメイン知識ルール統合 |
| 説明可能性 | reasoning出力のみ | リスク要因の列挙 + ルール発火トレース |
| ルール設計 | インライン実装 | モジュール化（個別有効化、テスト容易性） |

---

## タイトル案

日本語:
- 「3段カスケード型フィッシング検出における投入制御とルール統合の効果分析」

英語:
- "Effect Analysis of Handoff Control and Rule Integration in a Three-Stage Cascade Phishing Detection System"

---

## 1. はじめに

### 1.1 背景
- フィッシング被害の深刻化と、HTTPS普及により単純な鍵マーク判定が無効化
- CSS2025で、MLによる高速スクリーニングとLLMエージェントの二段構えを提示
- 本論文は、証明書とドメインのみを用いる検出の射程において、投入制御とルール統合が精度と運用コストに与える影響を実測し整理する

<!-- 要相談: 指摘8 「なぜ証明書か」を1章でどこまで強調するか。Related Workと分担して、本文の紙面配分と一貫させる -->

### 1.2 CSS2025の残課題（本論文の出発点）
- handoff候補に対するLLM処理が計算コストの制約となる
- LLM単体判定では再現性、安定性、説明可能性に限界がある
- 偽陰性要因の分析が事例中心で体系性が不足
- 高確信度で間違えるケースの運用設計（確信度の扱い）が未整理

### 1.3 Research Questions（RQ）

- RQ1: Stage2（誤り確率推定 + 証明書ゲート）は、Stage3投入率をどこまで低減できるか。性能指標（FNR/FPR等）とのトレードオフはどうなるか。
  - 対応: 4.2（投入率と全体性能、トレードオフ）
- RQ2: Stage3における知識ルール統合は、LLM単体に比べてどの程度、困難ケース集合での追加検知、再現性、説明可能性を改善するか。
  - 対応: 4.3（Stage3アブレーション、誤り分析、ルール発火統計）

### 1.4 本論文で明らかにした知見（貢献）

- 知見1: Stage2によりStage3投入率を大幅に圧縮しつつ、システム全体の高精度を維持できることを実データで示した。
- 知見2: Stage3でLLM判定にドメイン知識ルールを統合することで、困難ケース集合で追加検知を得る一方、説明可能性（ルール発火トレース）と再現性（同一条件での補正）を担保できることを定量化した。
- 知見3: 誤り分析により、各Stageの限界（残存FNの性質、Stage3由来FPの性質）と改善余地を明確化した。

### 1.5 論文構成
第2章で関連研究、第3章で手法（設計原則中心）、第4章で評価（RQ1, RQ2に対応）、第5章で議論（妥当性・倫理・運用含む）、第6章でまとめ。

---

## 2. 関連研究

### 2.1 機械学習によるフィッシング検出
- URL/ドメイン特徴量によるML検出
- 証明書特徴量の活用
- 勾配ブースティング（XGBoost等）の有効性
- 共通課題: ブラックボックス性、誤り要因の体系的分析不足、分布変化への弱さ

### 2.2 LLMによるフィッシング検出
- 大型LLMによる高精度化とコスト問題
- 小型LLMや量子化による実用化の方向性
- 共通課題: 全件LLM処理の非効率性、再現性、説明性

### 2.3 ハイブリッド手法と投入制御
- MLによる絞り込み + LLM精査（トリアージ）
- CSS2025の二段設計と、本研究の三段拡張（誤り確率推定層の導入）

### 2.4 説明可能性とルール統合
- XAI（SHAP/LIME等）と自然言語説明
- ルールエンジン統合による決定過程トレース（別系統の説明可能性）

---

## 3. 手法（設計原則と判断根拠）

### 3.1 全体設計（3段カスケード）
目的は、容易なケースを高速に自動判定し、困難なケースのみ高コストな精査へ送ることである。

- Stage1: XGBoost（全件の高速スクリーニング）
- Stage2: LR + 証明書ゲート（Stage1信頼性推定と投入制御）
- Stage3: LLMエージェント + ルール（困難ケースの精査、根拠提示）

### 3.2 Stage1: XGBoost
- 入力特徴量: 42個（ドメイン構造15、証明書27）
- 出力: フィッシング確率 p1 としきい値により auto_phishing / auto_benign / handoff に分岐
- 位置づけ: 高確信度領域を高速・高精度に確定し、曖昧領域を後段に送る

### 3.3 Stage2: 誤り確率推定 + 証明書ゲート
- LRでStage1の誤り確率（p_error）を推定し、handoffを drop_to_auto と handoff_to_agent に分割する
- 証明書属性ゲートとTLDリスク制御により、benign方向の過剰な自動判定を抑制しつつ投入率を制御する
- ルールの意図: LLM投入を減らしながら、危険側の取りこぼしを運用上許容できる水準に抑える

### 3.4 Stage3: LLMエージェント + ルール統合
- LLMエージェントは複数ツールの出力を統合して判定する
- ルールは証明書・TLD・ブランド偽装に関するドメイン知識に基づいて設計し、LLM出力を補正する
- 閾値（ctx_score等）は判定感度を調整するパラメータとして扱う（データから概念を発掘した立場ではない）

注: ルール一覧、モジュール数、ワークフロー詳細、クラス構造など実装詳細は補足資料に移し、本文では「どの誤りを抑制するために、どの種の知識を用いるか」を中心に記述する。

---

## 4. 評価実験（RQに対応）

### 4.1 実験設定

#### 4.1.1 データソースと証明書取得
データはPostgreSQL DB rapids_data に格納され、TLSハンドシェイクで取得したleaf証明書をDER形式で保存する。取得結果は status として記録される（SUCCESS、NOT_FOUND等）。

主要テーブルの証明書データ可用性（cert_data保有率）:
- certificates: 532,117中 196,083（36.9%）
- jpcert_phishing_urls: 222,984中 119,439（53.6%）
- phishtank_entries: 94,295中 52,808（56.0%）
- trusted_certificates: 554,801中 450,545（81.2%）

参考として、取得不能や例外の主因をstatus分布として併記する（詳細は表または付録）。
- certificates（総 532,117）: NOT_FOUND 49.2%、SUCCESS 36.9%、UNKNOWN_ERROR 7.9%、SEARCH_ERROR 5.1%、DOWNLOAD_ERROR 0.9%
- jpcert_phishing_urls（総 222,984）: SUCCESS 51.9%、NOT_HTTPS 18.7%、DUPLICATE 16.2%、NOT_FOUND 12.1% ほか
- phishtank_entries（総 94,295）: SUCCESS 52,805、NOT_FOUND 40,653、UNKNOWN_ERROR 441、SEARCH_ERROR 327 ほか
- trusted_certificates（総 554,801）: SUCCESS 81.2%、DOWNLOAD_ERROR 9.1%、NOT_FOUND 6.9%、UNKNOWN_ERROR 2.8%

#### 4.1.2 学習用データの構築と分割
- フィッシング側は複数ソース（PhishTank、JPCERT、certificates）から cert_data を保有するドメインを抽出し、ソース優先順位（PhishTank > JPCERT > certificates）により重複を解消する。
- データ準備パイプラインにより、ソース間重複排除（PhishTank/JPCERT/certificates間のドメイン重複約46,000件）、Phishing-Benign間重複排除（243件）、バランス調整を経て、最終的にPhishing 318,055件 + Benign 318,055件 = 合計636,110件を構築する。
  - 注: dataset_overview.mdの概算値（319,383件）はDB上のSUCCESSレコード数であり、重複排除・バランス調整前の値。実際のパイプライン通過後は318,055件/classとなる。
- Train/Testは80:20で分割し、**Test 127,222件（Phishing 63,611 / Benign 63,611）**、Train 508,888件。
- 特徴量抽出時の脱落は0件（train + test = 636,110 = prepared全数）。

50:50バランス学習は、手法間比較の公平性を優先する統制条件として採用する。運用では日々フィッシング証明書を収集でき、自然比率のデータで継続検証と閾値更新が可能である。運用更新は本論文のスコープ外とし、方針は6章に再掲する。

#### 4.1.3 特徴量と前処理
- 特徴量は42個（ドメイン構造15、証明書27）。
- ページ内容、HTML、スクリーンショットは利用しない（証明書とドメインのみ）。
- 乱数シード固定、重複排除基準、前処理の詳細を明記する。

#### 4.1.4 モデルと実行環境
- Stage1: XGBoost（max_depth=8, n_estimators=100, learning_rate=0.1）
  - 5-fold交差検証でROC-AUCを報告
- Stage2: Logistic Regression（p_error推定、StandardScalerで正規化）
- Stage3: Qwen3-4B-Thinking GPTQ-Int8（vLLM推論サーバ、temperature=0.1, max_tokens=512） + ルールエンジン
- 実行環境: 3GPU並列（ローカルGPU×1 + リモートGPU×2、スループット向上目的）

#### 4.1.5 評価指標
- 性能: Precision, Recall, F1, FPR, FNR（必要に応じてPR-AUC）
- 運用: Stage3投入率、自動判定率、遅延分布（p50/p90/p99）
- 再現性と説明可能性: ルール発火率、発火トレースの提示可能性

### 4.2 RQ1: Stage2による投入率低減とトレードオフ
- Stage1のhandoff（候補）から、Stage2によりStage3へ送付される件数を算出し、投入率を示す
- Stage1+2 と Stage1+2+3 の全体性能（Precision/Recall/F1/FPR/FNR）を提示し、投入率とのトレードオフを評価する
- 遅延分布（p50/p90/p99）を報告し、投入率と合わせて運用上のスループット含意を議論する

### 4.3 RQ2: Stage3ルール統合の効果（困難ケース集合）

Stage3単体性能（F1=72.33%）は、Stage1・2で解けなかった困難ケース集合（11,952件）上での値である。よって、全体F1=98.67%と同列比較せず、追加検知（FN削減）とFP増加のバランス、および説明可能性・再現性の付与という観点で評価する。

- アブレーション:
  - LLMのみ vs LLM+ルール（必須）
  - ツール無効化（任意。4ツールのうちどれが効くか）
- 誤り分析:
  - 残存FNのカテゴリ、Stage3由来FPのカテゴリ
  - ルール発火の寄与（どの種のルールがどの誤りを抑制したか）
- 再現性:
  - 同一入力に対する出力一貫性の確認（ルール適用前後の差分を要約）

<!-- 要相談: 指摘4 同一データセットでのベースライン（RF, LightGBM等）をどこまで追加するか。紙面と計算コストを踏まえ最小セットを検討 -->
<!-- 要相談: 指摘9 Threats to Validityの緩和策（感度分析、時系列評価、外部データ検証）を本文にどこまで入れるか。4.3末尾に短く置くか、5章に集約するか -->

---

## 5. 議論

### 5.1 各Stageの役割と相補性
- Stage1: 高速スクリーニング（高確信度領域を確定）
- Stage2: Stage1信頼性の推定と投入制御（メタ学習の位置づけ）
- Stage3: 困難ケース集合の精査と、ルール発火トレースによる説明可能性

### 5.2 FP/FNトレードオフの合理性
- FN削減とFP増加の比率を運用コストと被害コストの観点で評価する
- 投入率と遅延分布を合わせ、コスト効率の観点で議論する

### 5.3 妥当性への脅威（Threats to Validity）
- 観測バイアス: フィッシングと正規で証明書取得成功率が異なるため、本研究は cert_data を観測できる集合に条件づけられる
- 時間差: URL報告日時と証明書ダウンロード日時の差
- NOT_HTTPS: HTTPS未使用データは適用範囲外
- ラベルノイズ: 無害化、再利用など
- ルール閾値の調整: ドメイン知識ルールの判定閾値は、評価データ上の性能を参考に調整している。ルールの概念自体はデータ非依存だが、閾値の汎化性は未知のデータで検証が必要

<!-- 要相談: 指摘9 緩和策の記述粒度。感度分析や時系列評価を本文に入れるか、今後課題として扱うかを決める -->

### 5.4 倫理的配慮（Ethical Considerations）
- フィッシングデータの再配布方針と伏字方針
- 誤検知の影響と運用フロー（遮断前の確認）
- 攻撃者に有用な詳細の取り扱い（ルール詳細・閾値の公開粒度を抑制）
- 個人情報を扱わない（ドメインと証明書メタデータ中心）

---

## 6. まとめ

- Stage2によりStage3投入率を圧縮しつつ全体性能を維持できることを示した（RQ1）
- Stage3でルール統合が困難ケース集合の追加検知、再現性、説明可能性に寄与することを示した（RQ2）
- 学習は50:50の統制条件で実施したが、運用では日々の証明書収集に基づき自然比率データで継続検証と閾値更新を行う方針である（運用更新は本論文のスコープ外）

---

## 図表計画（合計12程度）

図（5本程度）:
- 図1: 3段カスケード全体アーキテクチャ
- 図2: Stage遷移の件数推移（Sankeyまたは棒グラフ）
- 図3: Stage3投入率と全体性能のトレードオフ（Stage2設定差）
- 図4: Stage3遅延分布（p50/p90/p99を含むCDF等）
- 図5: 誤り分析（残存FNと増加FPのカテゴリ分布）

表（7本程度）:
- 表1: データセット構築内訳（ソース別件数、重複排除、Train/Test）
- 表2: 証明書可用性とstatus分布要約（ソース別）
- 表3: システム全体性能（Stage1+2 vs Stage1+2+3）
- 表4: Stage2効果（投入率、自動判定誤り）
- 表5: Stage3性能（困難ケース集合）とルール発火率
- 表6: Stage3アブレーション（LLMのみ vs LLM+ルール）
- 表7: Threats to Validityの要約と緩和策（簡潔）

---

## 想定ページ数（CSS 8ページ厳守）

| セクション | ページ数 |
|----------|---------|
| 1. はじめに | 0.8 |
| 2. 関連研究 | 1.0 |
| 3. 手法 | 1.4 |
| 4. 評価実験 | 3.1 |
| 5. 議論 | 1.4 |
| 6. まとめ | 0.3 |
| 参考文献 | 0.0〜0.2（調整） |
| 合計 | 8.0 |

---

## 検証済み数値リファレンス（2026-02-07 SO再評価後・全件修復済み）

> 以下は `artifacts/2026-02-02_224105/results/` 配下のCSVから直接計算した権威的な数値である。
> 論文執筆時はこの数値を使用すること。
>
> 2026-02-07: SO (Structured Output) parse failure 16件全件を再評価して修復済み。
> Table5/Table6 ともに n=11,952 で完全一致。

### データセット
| 項目 | 値 |
|------|-----|
| DB概算 (重複排除前) | 319,383件/class × 2 = 638,766件 |
| **パイプライン通過後** | **318,055件/class × 2 = 636,110件** |
| **Train** | **508,888件 (Phishing 254,444 / Benign 254,444)** |
| **Test** | **127,222件 (Phishing 63,611 / Benign 63,611)** |
| 差異の原因 | ソース間重複排除、Phishing-Benign間重複排除(243件)、バランス調整 |
| 特徴量抽出時の脱落 | 0件 |

### Stage1 ルーティング（stage1_decisions_latest.csv: 127,222行）
| 判定 | 件数 | 割合 | TP | FP | TN | FN |
|------|------|------|---:|---:|---:|---:|
| auto_phishing | 60,767 | 47.8% | 60,765 | 2 | - | - |
| auto_benign | 8,464 | 6.7% | - | - | 8,461 | 3 |
| handoff | 57,991 | 45.6% | - | - | - | - |
| **自動判定合計** | **69,231** | **54.4%** | **60,765** | **2** | **8,461** | **3** |

### Stage2 振り分け（stage2_decisions_latest.csv: 127,222行）
| 判定 | 件数 | 割合 | y_true=0 | y_true=1 |
|------|------|------|---------|---------|
| not_candidate (Stage1自動) | 69,231 | 54.4% | - | - |
| drop_to_auto | 46,039 | 36.2% | 45,641 | 398 |
| handoff_to_agent | 11,952 | 9.4% | 9,507 | 2,445 |

Stage2証明書ゲート内訳:
- base safe_benign: 32,179件
- cert gate追加: 13,128件（net safe_benign_cert: 45,171件）
- phishing gate: 8件
- safe_benign_combined: 45,307件

### Stage3 評価（eval CSV: 11,952行）
| 項目 | 値 |
|------|-----|
| TP | 1,685 |
| FP | 529 |
| TN | 8,978 |
| FN | 760 |
| Precision | 76.11% |
| Recall | 68.92% |
| F1 | 72.33% |
| FPR | 5.56% |
| 処理時間 平均 | 9.22秒 |
| 処理時間 p50 | 8.31秒 |
| 処理時間 p90 | 15.28秒 |
| 処理時間 p99 | 28.60秒 |
| ルール発火件数 | 2,011件 (16.8%) |
| エラー件数 | 0件 |

### システム全体（全Stage合算）
| 項目 | 値 |
|------|-----|
| TP | 62,453 |
| FP | 532 |
| TN | 63,079 |
| FN | 1,158 |
| **Precision** | **99.16%** |
| **Recall** | **98.18%** |
| **F1** | **98.67%** |
| FPR | 0.84% |
| FNR | 1.82% |
| 自動判定率 | 90.6% (115,270/127,222) |
| Stage3投入率 | 9.4% (11,952/127,222) |

### データソース
- `artifacts/2026-02-02_224105/results/stage1_decisions_latest.csv` (127,222行)
- `artifacts/2026-02-02_224105/results/stage2_decisions_latest.csv` (127,222行)
- `artifacts/2026-02-02_224105/results/stage2_decisions_candidates_latest.csv` (57,991行)
- `artifacts/2026-02-02_224105/results/stage2_validation/eval_20260205_230157/eval_df__nALL__ts_20260205_230158.csv` (11,952行、SO再評価マージ済み)
- `artifacts/2026-02-02_224105/results/stage2_budget_eval.json` (Stage2設定記録)
