XGBoostとLR、それと Stage1・Stage2・Stage3 の役割分担を、02系 ipynb の実装に寄せて整理します。
研究として重要なのは「各段が何を保証し、どこから先が未確定か」を明確にすることです。 

---

## 全体像

* Stage1（XGBoost）: 高速スクリーニング担当。大量のドメインを一気に捌き、確信が高いものだけ自動決定し、曖昧は次段へ回す。
* Stage2（LRとゲート）: Stage1が曖昧にした集合を、限られた予算で優先度付けし、どれを Stage3 に回すか決める。運用上は未処理を未処理として明示するのが重要。
* Stage3（AIエージェント）: 高コストだが高精度な精査担当。Stage1やStage2だけでは判断が難しいものを、証拠と説明付きで裁く。

あなたの言う通り、02系 ipynb が Stage1 と Stage2 を担っています（Stage3 は 03系や agent 実行側）。

---

## XGBoost と LR の役割分担

### XGBoostが得意なこと

* 非線形な境界を高精度に学習できる（木のアンサンブル）
* 特徴量間の相互作用を自動で拾いやすい
* 大量データを高速に推論できる

このため Stage1 で使うのが合理的です。まず大半を高速に振り分ける。

### LRが得意なこと

* シンプルで安定、学習が速い
* スコア（確率）をランキングに使いやすい
* 過学習しにくく、説明もしやすい

ただし LR は「XGBoostの代わりに最終分類する」よりも、「Stage1の曖昧領域の中で、何を次に回すべきか」を順位付けする用途に向いています。02系の Stage2 LR はまさにここを狙っています。

---

## Stage1（XGBoost）の役割

Stage1 は2つの仕事をしています。

1. 高確信の自動決定

* 例えば確率が極端に低いものは AUTO_BENIGN
* 極端に高いものは AUTO_PHISH
  この領域は、誤りを極小化することが最重要です。

2. グレーの切り出し

* 0か1に無理に押し込まず、確信が持てないものは DEFER として Stage2 へ回す
  この「確信が持てない」の定義が閾値設計で、論文でも設計の肝になります。

02系 ipynb では、この Stage1 のしきい値（t_low/t_high）が route1_thresholds.json と stage1_decisions_latest.csv として成果物に出ます。

---

## Stage2（LRとゲート）の役割

Stage2 は Stage1=DEFER の中だけを扱います。役割は次の2つです。

1. 限られた予算で優先度付け
   Stage3 は高コストなので、DEFER を全件渡すのではなく、危険度が高い順に budget 件だけ選ぶ必要があります。
   Stage2 LR のスコア（p_error 等）は、DEFERの中で優先順位を付けるための指標です。

2. 送れなかったものを未確定として残す責任
   ここが重要です。Stage2 で予算に入らなかったものは、正常確定ではありません。
   運用上は PENDING として、隔離・後追い・人手、いずれかの責任ある扱いが必要です。

02系 ipynb の範囲では、stage2_decisions_candidates_latest.csv と stage2_decisions_latest.csv が Stage2 の結果です。

---

## Stage3（AIエージェント）の役割

Stage3 は「高コストだが高精度」の精密分析層です。
論文の言い方に合わせると、MLが苦手な低確信領域にだけLLMエージェントを限定適用して、見逃しを減らす、という役割です。

重要なのは Stage3 の入力が

* Stage1で確信が持てない
* Stage2で優先度が高い
  という条件を満たす集合になっていることです。

---

## 02系 ipynb をどう説明すると分かりやすいか

02系は、実務フローとしては次の2段を一体で作っている、と言えます。

* StepA: XGBoostで全件を高速にスクリーニングし、AUTOとDEFERに分ける
* StepB: DEFERの中をLR等で順位付けし、budget件だけを次の精査（Stage3）へ回す

これが「XGBoostとLRの役割分担」で、Stage1/Stage2 の役割分担そのものです。

---


