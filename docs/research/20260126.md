# 研究日誌 2026-01-26

## 本日の作業

### FN/FP分析と修正実装
- 1. 前回評価（25%完了時点）のFN/FP詳細分析
- 2. FP削減のための修正実装（ULTRA_LOW_ML_BLOCK等）
- 3. FN削減のための修正実装（ブランドキーワード、危険TLD強化）
- 4. Stage3全データ（15,670件）での静的分析
- 5. 修正適用後の評価再開

---

## 1. FN/FP詳細分析（前回評価 n=3,741, 23.9%時点）

### 分析結果サマリー

| 区分 | 件数 | 割合 |
|------|------|------|
| FN（フィッシング見逃し） | 261 | 7.0% |
| FP（誤検知） | 305 | 8.2% |

### FN主要原因

| 原因 | 件数 | 対策 |
|------|------|------|
| ブランドキーワード検出漏れ | 7 | `citi`, `rakuten`, `courts`等追加 |
| 低ML + .com ドメイン | 83 | 検出困難（要調査） |
| 危険TLDだが見逃し | 25 | 危険TLD+低MLブースト追加 |

**具体例:**
- `whatsapp-jq.com` (ML=0.883) - WhatsApp偽装
- `citifinanceswiftbank.com` (ML=0.032) - Citi銀行偽装
- `kurodnekoyfamaxto.buzz` (ML=0.012) - クロネコヤマト偽装

### FP主要原因

| 原因 | 件数 | 割合 | 対策 |
|------|------|------|------|
| 短ドメイン (SLD≤5文字) | 111 | 36.4% | .org等で緩和 |
| 低ML過検知 (ML<0.1) | 165 | 54.1% | ULTRA_LOW_ML_BLOCK |
| .org ドメイン | 32 | 10.5% | 信頼TLD緩和 |

**具体例:**
- `tcpdf.org`, `cppcon.org` - 正規OSSプロジェクト
- `skatepro.com`, `aurora.tech` - 正規ビジネス

---

## 2. FP削減のための修正実装

### 2.1 ULTRA_LOW_ML_BLOCK (`llm_final_decision.py`)

**目的:** ML < 0.05 でブランド検出なし・危険TLDなしの場合、AIのphishing判定をブロック

```python
ULTRA_LOW_ML_TH = 0.05
if ip and ml < ULTRA_LOW_ML_TH and (not brand_detected) and (not has_dangerous_tld_signal):
    ip = False  # phishing判定をブロック
    tr.append({
        "rule": "ULTRA_LOW_ML_BLOCK",
        "action": "block_ultra_low_ml_phishing",
        ...
    })
```

**期待効果:** FP ~95件削減（ML < 0.05 のFPを救済）

### 2.2 短ドメインペナルティ緩和 (`short_domain_analysis.py`)

**目的:** `.org`, `.edu`, `.gov`等の信頼TLDに対する短ドメインペナルティを緩和

```python
_trusted_tlds = {"org", "edu", "gov", "mil", "int", "ac.jp", "go.jp", "co.jp", "ne.jp"}

if n <= 3:  # very_short
    if _is_trusted_tld:
        score += 0.10  # 通常: 0.30 → 信頼TLD: 0.10
    else:
        score += 0.30
elif n <= 6:  # short
    if _is_trusted_tld:
        score += 0.03  # 通常: 0.10 → 信頼TLD: 0.03
```

**テスト結果:**

| ドメイン | 修正前 | 修正後 |
|----------|--------|--------|
| fmr.org | 0.50 | 0.30 |
| fmr.com | 0.50 | 0.50 |
| abc.top | 0.60 | 0.60 |

### 2.3 信頼TLD緩和 (`contextual_risk_assessment.py`)

**目的:** `.org`, `.edu`, `.gov`等のリスクスコアを軽減

```python
_trusted_tld_mitigation = {
    "org": 0.08,   # -0.08 軽減
    "edu": 0.12,
    "gov": 0.15,
    "mil": 0.15,
    "int": 0.10,
}

# ブランド検出がない場合のみ緩和を適用
if _trusted_mitigation_value > 0 and "brand_detected" not in issue_set:
    score = max(0.0, score - _trusted_mitigation_value)
```

**期待効果:** .org FP ~34件を軽減

---

## 3. FN削減のための修正実装

### 3.1 ブランドキーワード追加 (`brand_impersonation_check.py`)

**追加キーワード:**
```python
# 金融機関
"citi", "citibank", "citigroup", "swift",

# 政府機関偽装
"courts", "judiciary", "hmrc", "revenue",

# 日本
"rakuten",

# 通信/SNS (lineは誤検出多いため除外)
"linemessenger", "lineapp", "linepay", "viber", "signal",
```

**除外したキーワード:**
- `ato` - "aviator", "elevator"等で誤検出（Benign 68件 vs Phishing 4件）
- `irs` - 短すぎて誤検出リスク
- `line` - "online"で誤検出

**キーワード総数:** 201件 → 204件

### 3.2 危険TLD + 低MLブースト (`contextual_risk_assessment.py`)

**目的:** 危険TLD + ML < 0.15 のドメインにベースブーストを付与

```python
if is_dangerous_tld:
    if p < 0.15:  # 低ML
        dangerous_tld_combo_boost += 0.12
        dangerous_tld_combo_signals.append("dangerous_tld_low_ml")
```

**テスト結果:**

| ドメイン | ML | 修正前 | 修正後 |
|----------|-----|--------|--------|
| kurodnekoyfamaxto.buzz | 0.012 | 低 | 0.386 ✓ |
| server-jp.icu | 0.010 | 低 | 0.386 ✓ |
| ofrwicu.cyou | 0.019 | 低 | 0.386 ✓ |
| rakutenu.top | 0.019 | 低 | 0.386 ✓ |

---

## 4. Stage3全データ静的分析（15,670件）

### データ構成

| 区分 | 件数 | 割合 |
|------|------|------|
| Phishing | 2,739 | 17.5% |
| Benign | 12,931 | 82.5% |

### 修正効果の予測

| 修正 | 対象 | FP削減 | FN削減 |
|------|------|--------|--------|
| ULTRA_LOW_ML_BLOCK | ML<0.05 Benign 6,483件 | ◎ 大 | - |
| 信頼TLD緩和 | .org Benign 1,513件 | ○ 中 | - |
| 短ドメイン緩和 | .org+short 142件 | ○ 小 | - |
| 危険TLD+低MLブースト | Phishing 86件 | △ リスクあり | ○ 中 |
| ブランドキーワード | Phishing 12件 | - | △ 小 |

### 注意事項

- **危険TLD+低MLブースト**: Benign 352件がFPリスクあり
  - ただしブーストは+0.12のみで単独ではphishing判定にならない
- **ULTRA_LOW_ML_BLOCK**: Phishing 289件（ML<0.05）が見逃しリスク
  - ブランド検出・危険TLDがあれば除外されるため影響は限定的

---

## 5. 評価再開

### 実行環境

- tmuxセッション `eval` で実行（Claude終了後も継続）
- 3 GPU並列（Port 8000, 8001, 8002）
- `--shuffle` オプションでデータをランダム化

### 現在の進捗（00:50時点）

```
進捗: 4,562/15,670 (29.1%)
TP: 486  TN: 3,400  FN: 313  FP: 363
Precision: 0.572  Recall: 0.608  F1: 0.590
速度: 24件/分  ETA: 7.6時間
```

### 監視コマンド

```bash
# tmuxセッションに接続
tmux attach -t eval

# 進捗確認
tail -f eval_20260126_final.log

# 結果ファイル確認
wc -l /data/hdd/asomura/nextstep/artifacts/2026-01-24_213326/results/stage2_validation/worker_*_results.csv
```

---

## 6. 追加対策の実装（評価完了後のFN/FP分析に基づく）

### 評価結果（15,670件完了）

```
TP: 1,665  TN: 11,956  FN: 1,074  FP: 975
Precision: 0.631  Recall: 0.608  F1: 0.619
```

### 実装した対策一覧

| # | 対策 | 対象エラー | 修正ファイル | 状態 |
|---|------|-----------|-------------|------|
| 7 | ブランドキーワード境界チェック | FP -30 | brand_impersonation_check.py | ✓完了 |
| 8 | 問題キーワード除去/置換 | FP -20 | brand_impersonation_check.py, brand_keywords.json | ✓完了 |
| 1 | HIGH_ML_OVERRIDE | FN -80 | llm_final_decision.py | ✓完了 |
| 3 | フランス語キーワード追加 | FN -38 | contextual_risk_assessment.py | ✓完了 |
| 2 | .cn TLD強化 | FN -50 | contextual_risk_assessment.py | ✓完了 |
| 5 | ランダム文字列検出強化 | FN -30 | short_domain_analysis.py | ✓完了 |
| 6 | serviceキーワード強化 | FN -9 | contextual_risk_assessment.py | ✓完了 |

### 6.1 対策7: ブランドキーワード境界チェック

**問題:** `BOUNDARY_REQUIRED_BRANDS` の短いキーワード（"line", "ups", "visa"等）が、一般的な単語（"online", "pushups"等）で誤検出。

**対策:**
```python
BOUNDARY_REQUIRED_BRANDS = frozenset(["line", "ing", "au", "ups", "visa", "ana", "chase"])
BRAND_FP_EXCLUSION_WORDS = frozenset(["online", "offline", "pipeline", ...])  # ~80語

# _check_brand_substring() で境界チェック
if brand in BOUNDARY_REQUIRED_BRANDS:
    if token in BRAND_FP_EXCLUSION_WORDS:
        return False, ""
```

### 6.2 対策8: 問題キーワード除去/置換

**問題:** `brand_keywords.json` の短すぎるキーワードがFPを引き起こす。

**対策:**
- 削除: "ing", "au", "nta", "ana"
- 追加: "ingbank", "ingdirect", "inggroup", "aupay", "auwallet", "auone", "kddi", "anaairlines", "allnippon", "ntagojp", "kokuzei"
- CRITICAL_BRAND_KEYWORDS追加: "sbisec", "sbinet", "sbibank", "netbksbi", "vpass", "vpasso", "shinkansen", "mercari", "merucari", "ekinet", "eki-net", "coincheck"

### 6.3 対策1: HIGH_ML_OVERRIDE

**問題:** ML ≥ 0.4 でもAIが "low risk" と判定して見逃すFN。

**対策:**
```python
HIGH_ML_OVERRIDE_TH = 0.40
if not ip and ml >= HIGH_ML_OVERRIDE_TH and rl in {"low", "medium"}:
    _has_override_trigger = bool(_random_override_signals) or has_dangerous_tld_signal
    if _has_override_trigger and not is_allowlisted and not _is_override_trusted:
        ip = True
        c = max(c, 0.65)
        rl = "high"
```

### 6.4 対策3: フランス語キーワード追加

**問題:** フランス語のフィッシングキーワードが未検出。

**対策:** `MULTILINGUAL_RISK_WORDS` に追加:
```python
"suivi", "remboursement", "virement", "paiement", "bancaire",
"impots", "amende", "douane", "carte", "retrait", "depot",
"chronopost", "laposte", "colissimo", "relais", "infos",
```

### 6.5 対策2: .cn TLD強化

**問題:** `.cn` TLDのフィッシングが見逃されている。

**対策:** `.cn` + 複数シグナルの場合に追加ブースト:
```python
if _tld_suffix_ctx == "cn":
    if _cn_additional_signals >= 2:
        dangerous_tld_combo_boost += 0.15
        dangerous_tld_combo_signals.append("cn_tld_high_risk")
```

### 6.6 対策5: ランダム文字列検出強化

**問題:** 一部のランダムパターンが検出漏れ。

**対策:**
1. **母音なしドメイン検出**（危険TLD限定）
2. **連続文字パターン検出**（"aaabbcc.com"等）

```python
# 母音なし + 危険TLD
if vowel_ratio == 0 and tld_category == "dangerous":
    issues.append("no_vowel_dangerous_tld")
    score += 0.15

# 連続文字パターン + 危険TLD
if is_repeating_pattern and tld_category == "dangerous":
    issues.append("repeating_pattern_dangerous_tld")
    score += 0.15
```

### 6.7 対策6: serviceキーワード強化

**問題:** "service", "support"等を含むフィッシングドメインが見逃し。

**対策:** `MULTILINGUAL_RISK_WORDS` に追加:
```python
"service", "services", "support", "customer", "helpdesk",
"technical", "billing", "invoice", "receipt", "refund",
"activation", "registration", "subscription", "membership",
"notification", "delivery", "shipping", "tracking", "parcel",
```

---

## 次回の作業予定

- 対策実装後の再評価（新しいvLLMインスタンスで）
- Before/After の性能比較
- 残FN/FPの詳細分析
- 必要に応じて追加対策の検討
