# 研究日誌 2026-01-23

## 本日の作業

### 並列評価システム
- 1. 3000件評価完了・結果確認
- 2. 並列評価システムの設計
- 3. Worker 1 (external) 設定
- 4. 10件テスト・バグ修正
- 5. 100件テスト成功
- 6. vLLM自動停止機能の実装
- 7. Worker 2 (SSH) 設定
- 8. 全件評価 (17,434件) 開始

---

## 1. 3000件評価完了

### 結果サマリー (2026-01-22 02:09完了)

| 項目 | 値 |
|------|-----|
| 評価対象 | Stage2 Handoff 3,000件 |
| 実行時間 | 約6.4時間 |
| エラー | 0件 |

### パイプライン全体性能 (3000件サンプル)

| 指標 | Stage1 | Final | 差分 |
|------|--------|-------|------|
| Precision | 0.9950 | 0.9937 | -0.0013 |
| Recall | 0.9722 | 0.9728 | +0.0006 |
| F1 | 0.9835 | 0.9832 | -0.0003 |

### Handoff Subset (3000件)

| 指標 | Stage1 | Final | 差分 |
|------|--------|-------|------|
| Precision | 0.8798 | 0.8549 | -0.0249 |
| Recall | 0.6188 | 0.6300 | +0.0112 |
| F1 | 0.7266 | 0.7254 | -0.0012 |

### 課題認識

- 3000件サンプルでは母集団の一部しか評価できない
- **全17,434件の評価が必要** → 並列化が必須
- 1GPU=約33時間、2GPU=約17時間の見積もり

---

## 2. 並列評価システムの設計

### アーキテクチャ

```
evaluate_e2e_parallel.py (エントリポイント)
       │
       ▼
┌─────────────────────────────────────────┐
│  ParallelOrchestrator                    │
│  ┌──────────────┐  ┌─────────────────┐  │
│  │ VLLMCluster  │  │ HealthMonitor   │  │
│  │ (N instances)│  │ (Background)    │  │
│  └──────────────┘  └─────────────────┘  │
│  ┌──────────────┐  ┌─────────────────┐  │
│  │ Checkpoint   │  │ RecoveryManager │  │
│  │ Manager      │  │                 │  │
│  └──────────────┘  └─────────────────┘  │
└───────────────┬─────────────────────────┘
                │ multiprocessing.Process
       ┌────────┼────────┐
       ▼        ▼        ▼
   Worker 0  Worker 1  Worker 2
   (GPU 0)   (Port 8001)(Port 8002)
   Port 8000  External   SSH start/stop
```

### Workerタイプ

| タイプ | 説明 | vLLM管理 |
|--------|------|----------|
| `local` | ローカルGPU (PID管理) | 起動/停止をプロセスで制御 |
| `external` | ポートフォワード済み外部vLLM | no-op or start_cmd/stop_cmd |
| `remote` | SSH+tmux でリモート完全管理 | SSH経由で起動/停止 |

### 主要機能

- **チェックポイント/リジューム**: Worker単位で進捗保存、中断後の再開可能
- **ヘルスモニタリング**: 5秒間隔でvLLM生存確認、連続3回失敗で障害判定
- **自動リカバリ**: vLLM再起動 (最大3回)
- **共有サーバ対応**: GPU使用状況確認、他ユーザーとの共存

### 作成ファイル

| ファイル | 内容 |
|----------|------|
| `scripts/evaluate_e2e_parallel.py` | エントリポイント |
| `scripts/parallel/__init__.py` | パッケージ初期化 |
| `scripts/parallel/config.py` | WorkerConfig, ParallelConfig |
| `scripts/parallel/vllm_manager.py` | Local/External/Remote VLLMManager |
| `scripts/parallel/orchestrator.py` | ParallelOrchestrator |
| `scripts/parallel/worker.py` | Worker プロセス |
| `scripts/parallel/checkpoint.py` | CheckpointManager |
| `scripts/parallel/health.py` | HealthMonitor |
| `scripts/parallel_config.yaml` | Worker設定ファイル |

---

## 3. Worker 1 (external) 設定

### 設定内容

Worker 1は別マシンでvLLMが稼働し、ポートフォワード済みの `localhost:8001` に接続する構成。

```yaml
- id: 1
  port: 8001
  type: external      # ポートフォワード済み、no-op
```

### ExternalVLLMManager

```python
class ExternalVLLMManager(BaseVLLMManager):
    """外部管理vLLM用。start/stopは基本no-op、
    start_cmd/stop_cmdが指定されていればsubprocess実行。"""
```

---

## 4. 10件テスト・バグ修正

### 発見・修正したバグ

| バグ | 原因 | 修正 |
|------|------|------|
| データ読み込みエラー | `prepared_data.pkl` を参照していた | `handoff_candidates_latest.csv` から読込に変更 |
| `-y` フラグ無効 | GPU確認が `skip_confirmation` を受け取っていなかった | パラメータ追加 |
| ドメインファイル衝突 | CheckpointManagerの `init_worker_state()` が orchestrator書き出しの `worker_N_domains.json` を上書き | orchestrator側を `worker_N_input.json` にリネーム |
| NaN JSON化エラー | pandas NaN が JSON serializable でない | `df.where(df.notna(), None)` で変換 |

---

## 5. 100件テスト成功

### テスト結果

| 項目 | 値 |
|------|-----|
| Worker 0 | 50件完了 |
| Worker 1 | 50件完了 |
| エラー | 0件 |
| 結果マージ | 成功 (100行) |

両Worker均等分割、チェックポイント動作、結果マージ全て正常動作を確認。

---

## 6. vLLM自動停止機能

### 実装内容

評価完了後にGPU 0のvLLMを自動停止する機能を追加。

```python
def _find_pid_by_port(self) -> Optional[int]:
    """pgrep -f でvLLMのメインプロセスPIDを特定"""
    result = subprocess.run(
        ['pgrep', '-f', f'vllm serve.*--port {self.port}'],
        capture_output=True, text=True, timeout=5
    )
    ...
```

### 初回の問題

`lsof -ti :PORT` は子プロセスのPIDを返すことがあり、メインプロセスのkillに失敗。
`pgrep -f "vllm serve.*--port {port}"` でメインプロセスを正確に特定するよう修正。

---

## 7. Worker 2 (SSH) 設定

### 設定内容

Worker 2は別マシン (192.168.100.70) のGPU上でvLLMを動かす構成。SSH経由でstart/stop。

```yaml
- id: 2
  port: 8002
  type: external
  start_cmd: "ssh asomura@192.168.100.70 'bash -lc \"/home/asomura/src/vllm.sh start\"'"
  stop_cmd: "ssh asomura@192.168.100.70 'bash -lc \"/home/asomura/src/vllm.sh stop\"'"
```

※ 本日はGPU 2が他ユーザー使用中のため、Worker 0 + 1 の2並列で評価開始。

---

## 8. 全件評価 (17,434件) 開始

### 実行情報

| 項目 | 値 |
|------|-----|
| 開始時刻 | 2026-01-23 15:39 JST |
| ドメイン数 | 17,434件 |
| Worker数 | 2 (GPU 0 + External GPU 1) |
| 推定完了 | 約17時間後 (01-24 09:00頃) |

### 実行コマンド

```bash
PYTHONUNBUFFERED=1 nohup python scripts/evaluate_e2e_parallel.py \
  --add-gpu 1 -y > artifacts/2026-01-21_152158/logs/parallel_all.log 2>&1 &
```

### ログバッファリング問題

初回はnohup環境でログがバッファリングされ進捗確認不可。`PYTHONUNBUFFERED=1` で解決。

---

## 本日の成果まとめ

### 並列評価システム

1. **設計完了**: multi-worker、checkpoint/resume、health monitoring
2. **実装完了**: local/external/remote の3タイプ対応
3. **テスト完了**: 10件/100件で動作確認
4. **全件評価開始**: 17,434件、2GPU並列、~17時間

### 技術的解決

- ファイル名衝突問題の解決
- NaN処理の統一化
- vLLM PID特定の正確化
- nohupログバッファリング問題の解決

---

## 次のステップ

1. [ ] 全件評価の完了待ち (01-24 09:00頃)
2. [ ] パイプライン全体性能の算出
3. [ ] Stage3 FP/FN のVirusTotal調査
4. [ ] データクリーニング・再評価の検討
