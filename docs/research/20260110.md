# 研究日誌 2026-01-10

## 概要

本日は大規模な改善を複数実施し、Stage2 handoff削減とモジュール化を完了した。特にStage3への送信件数を大幅に削減し、処理時間の短縮を実現した。

## 用語・システム構成

本研究のフィッシング検出システムは3段階のパイプライン構成を採用している。各Stageの命名は本研究で定義したものである。

### システム全体図

```
┌─────────────────────────────────────────────────────────────────┐
│  Stage1 (XGBoost)                                               │
│  ・証明書/ドメイン特徴量に基づく機械学習分類                    │
│  ・出力: ml_probability (0.0-1.0)                               │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Route1 (閾値判定)                                              │
│  ・高確信度ケースを自動判定 (AUTO_PHISHING / AUTO_BENIGN)       │
│  ・中間ケースはStage2へ (PENDING)                               │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Stage2 (Logistic Regression Defer)                             │
│  ・Stage1の予測を再評価し、確信度の低いケースを選別             │
│  ・出力: defer_score (Stage3送信の必要性スコア)                 │
│  ・defer_score >= tau → "Handoff" (Stage3へ送信)                │
│  ・defer_score < tau → Stage1の判定を採用                       │
└─────────────────────────────────────────────────────────────────┘
                              ↓ (Handoff)
┌─────────────────────────────────────────────────────────────────┐
│  Stage3 (AI Agent / LLM)                                        │
│  ・LLMによる詳細分析（Webコンテンツ、ブランド検出等）           │
│  ・処理コスト: 約8秒/件                                         │
└─────────────────────────────────────────────────────────────────┘
```

### 用語定義

| 用語 | 説明 |
|------|------|
| **Stage1** | 第1段階の分類器。XGBoostを使用し、SSL証明書情報とドメイン名から抽出した41種類の特徴量に基づいてフィッシング確率（ml_probability）を算出する。高速だが、Webコンテンツは参照しない。 |
| **Route1** | Stage1の出力に対する閾値判定。確信度の高いケース（ml_probability が極端に高い/低い）を自動判定し、中間のケースのみをStage2に送る。 |
| **Stage2** | 第2段階の判定器。Logistic Regressionを使用し、Stage1の予測に対する「確信度」を再評価する。"Defer"（判断保留）すべきケースを選別し、Stage3に送信するかを決定する。 |
| **Stage3** | 第3段階の分析器。LLM（大規模言語モデル）を使用したAI Agentが、Webコンテンツ取得、ブランド偽装検出、証明書詳細分析などを実施する。最も精度が高いが、処理コストも最大（約8秒/件）。 |
| **Handoff** | Stage2からStage3への「引き継ぎ」。Stage2がdefer_score >= tauと判定したケースがStage3に送信される。LLMの処理コストが高いため、Handoff件数の削減がシステム効率化の鍵となる。 |
| **defer_score** | Stage2が出力する「判断保留スコア」。値が高いほど「Stage1の判定に確信が持てない、Stage3で詳細調査すべき」ことを示す。 |
| **tau (τ)** | Stage2のHandoff閾値。defer_score >= tau のケースがStage3に送信される。本研究ではtau=0.40を使用。 |

## 実施事項

### 1. Phase 2.0 & 2.1: モジュール抽出と完全統合

02_main.ipynb（Jupyter Notebook）から独立したPythonモジュールを抽出し、コマンドラインツールとして利用可能にした。

#### Phase 2.0: モジュール抽出
| モジュール | 説明 | 行数 |
|------------|------|------|
| `config.py` | YAML設定管理 | - |
| `features.py` | 特徴量エンジニアリング（35特徴） | - |
| `train_xgb.py` | XGBoost学習（GPU対応） | - |
| `route1.py` | Wilson scoreによる閾値選択 | - |
| `stage2_gate.py` | segment_priority選択 | - |
| `brand_extraction.py` | ブランドキーワード抽出 | - |

**合計: 6モジュール、1,916行**

#### Phase 2.1: 完全統合
- `02_main.py`（437行）: エンドツーエンドパイプライン
  - Predictモード: CSV入力 → 予測結果 + 統計
  - Interactiveモード: リアルタイムドメイン分類
  - 自動RUN_ID検出とアーティファクト読み込み

#### テストカバレッジ
| カテゴリ | 結果 |
|----------|------|
| Unit tests | 19/19 (100%) |
| Integration tests | 8/8 (100%) |
| Regression tests | 5/5 (100%) |
| **合計** | **32/32 (100%)** |

---

### 2. Stage2 LRモデルの強化

エントロピーと不確実性に基づく派生特徴量を追加し、Stage3 handoffを大幅に削減。

#### 追加した特徴量
- Stage1予測のエントロピー
- Stage1予測の不確実性

#### パラメータ調整
- tau: 0.60 → 0.40（特徴量探索により最適化）

#### 結果
| メトリクス | 改善前 | 改善後 | 変化 |
|------------|--------|--------|------|
| Stage3 handoff | 55,524 | 34,848 | **-37.2%** |
| AUTO error rate | 0.195% | 0.195% | 維持 |

**コミット**: `a17813c Enhance Stage2 LR with entropy+uncertainty features`

---

### 3. XGBoostハイパーパラメータ最適化

Optunaを使用した自動ハイパーパラメータ探索を実施。

#### 最適化されたパラメータ（Trial 25）
```python
{
    "n_estimators": 500,
    "max_depth": 10,
    "learning_rate": 0.206,
    "min_child_weight": 6,
    "subsample": 0.77,
    "colsample_bytree": 0.70,
    "gamma": 2.38,
    "reg_alpha": 0.11,
    "reg_lambda": 2.37,
    "tree_method": "hist",
    "device": "cuda"
}
```

#### 結果
| メトリクス | 改善前 | 改善後 | 変化 |
|------------|--------|--------|------|
| AUTO errors | 182 | 139 | **-24%** |
| Error rate | 0.195% | 0.152% | -22% |

**コミット**: `c48a5ab Optimize XGBoost hyperparameters via Optuna tuning`

---

### 4. 証明書特徴量の追加

`search_new_features.py`による特徴量探索で発見した6つの新特徴量を追加。

#### 追加した特徴量
| 特徴量名 | 説明 |
|----------|------|
| `cert_key_bits_normalized` | 鍵サイズ（0-1正規化） |
| `cert_issuer_country_code` | 発行者国コード（0=不明, 1=US, 2=その他） |
| `cert_serial_entropy` | シリアル番号のシャノンエントロピー |
| `cert_has_ext_key_usage` | Extended Key Usage拡張の有無 |
| `cert_has_policies` | Certificate Policies拡張の有無 |
| `cert_issuer_type` | 発行者タイプ（LE, Google, Cloudflare, Commercial） |

#### 結果
| メトリクス | 改善前 | 改善後 | 変化 |
|------------|--------|--------|------|
| AUC | 0.9945 | 0.9973 | **+0.28%** |
| AUTO errors | 139 | 137 | -1.4% |
| Stage2 handoff | 36,644 | 36,489 | -0.4% |
| 特徴量数 | 35 | 41 | +6 |

**コミット**: `833cad9 Add 6 new certificate features from feature exploration`

---

### 5. Scenario 5: Auto-BENIGNフィルター

Stage2でp1が非常に低く、defer_scoreも低いケースを自動的にBENIGNとして処理し、Stage3をスキップ。

#### フィルター条件
```
p1 < 0.15 AND defer_score < 0.4 → 自動BENIGN（Stage3スキップ）
```

#### 結果
| メトリクス | 改善前 | 改善後 | 変化 |
|------------|--------|--------|------|
| Stage3 Handoff | 36,489 | 28,684 | **-21.4%** (-7,805件) |
| 推定処理時間 | ~81時間 | ~64時間 | **-17時間** |
| FN増加 | - | +87件 | +2.5% of phishing |

#### FN分析（87件）
- 43.7%: 本質的にbenignと区別困難（短いドメイン + 正規TLD + ブランド名なし）
- Stage3のWebコンテンツ解析が必要なケース

#### 追加した設定オプション
```yaml
stage2_safe_benign_enabled: true
stage2_safe_benign_p1_max: 0.15
stage2_safe_benign_defer_max: 0.40
```

**コミット**: `33fb65e Implement Scenario 5: Auto-BENIGN filter for Stage2`

---

## 本日の総合成果

### Stage3 Handoff削減の推移

| ステップ | Handoff件数 | 削減率 |
|----------|-------------|--------|
| 初期状態 | 55,524 | - |
| Stage2 LR強化後 | 34,848 | -37.2% |
| 証明書特徴量追加後 | 36,489 | -34.3%* |
| Auto-BENIGNフィルター後 | **28,684** | **-48.3%** |

*再学習により一時的に増加

### 処理時間削減
- 推定削減時間: **約27時間**（55,524件 → 28,684件、1件あたり約8秒として）

### 品質維持
- AUTO error rate: 0.195% → 0.152%（改善）
- AUC: 0.9945 → 0.9973（+0.28%）
- FN増加: +87件（許容範囲内、Stage3で検出可能なケース）

---

## 作成したスクリプト・ドキュメント

| ファイル | 説明 |
|----------|------|
| `02_main.py` | メインパイプライン（437行） |
| `scripts/tune_xgboost.py` | Optunaによるハイパーパラメータ探索 |
| `scripts/search_lr_features.py` | Stage2特徴量探索 |
| `scripts/search_new_features.py` | 新特徴量発見スクリプト |
| `scripts/analyze_handoff.py` | HANDOFF分布分析 |
| `scripts/analyze_scenario5_fn.py` | FN分析スクリプト |
| `USAGE_GUIDE.md` | 使用方法ドキュメント |
| `quick_start.py` | 最小動作例 |
| `example_usage.py` | 詳細使用例 |

---

## コミット一覧（時系列）

1. `dcee83c` まとめてコミット (07:36)
2. `a4fc72b` Remove notebooks under 02 (07:41)
3. `80e80da` Complete Phase 2.0 & 2.1: Module extraction and full integration (15:57)
4. `5a78c06` Add --train mode to replicate Notebook workflow (16:09)
5. `ddaba15` Refactor 02_main.py: Use features.py module (19:06)
6. `e9790a4` Add 02_original.ipynb as reference notebook (19:06)
7. `822a973` Fix handoff output: include both ml_probability and prediction_proba (19:22)
8. `a17813c` Enhance Stage2 LR with entropy+uncertainty features (20:04)
9. `c48a5ab` Optimize XGBoost hyperparameters via Optuna tuning (21:02)
10. `833cad9` Add 6 new certificate features from feature exploration (21:18)
11. `33fb65e` Implement Scenario 5: Auto-BENIGN filter for Stage2 (23:29)

---

## 次のステップ

- [x] AI Agent（Phase6）のML Paradox検出テスト（→ 01/11に実施）
- [ ] Stage3処理時間の実測
- [ ] Scenario 5の本番環境適用
- [ ] 証明書特徴量の追加探索
