# 研究日誌 2026-01-21

## 本日の作業

### データクレンジング
- 1. VirusTotal調査完了（2,172件）
- 2. ラベリングエラーの特定と分類
- 3. データベースからの削除実行
- 4. パイプライン再実行・検証

### 評価
- 5. Stage1/Stage2性能確認
- 6. evaluate_e2e.py 3000件評価開始

---

## 1. VirusTotal調査完了

### 調査結果サマリー

| カテゴリ | 調査件数 | ラベルエラー検出 | 検出率 |
|----------|---------|-----------------|--------|
| FP (trusted) | 339 | 29 | 8.6% |
| FN (phishing) | 1,833 | 164 | 8.9% |
| **合計** | 2,172 | **193** | 8.9% |

### FP分析（trustedデータのラベルエラー）

VTでmalicious > 0 のドメイン = 実際は悪意あり

| ドメイン | Malicious | Suspicious | 備考 |
|----------|-----------|------------|------|
| kra27s.cc | 14 | 0 | 高リスク |
| bahiscasino491.com | 10 | 0 | カジノ |
| gooogles.site | 9 | 0 | ブランド偽装 |
| 1fvpd.com | 5 | 0 | |
| yeezy-450.com | 4 | 1 | ブランド偽装 |

### FN分析（phishingデータのラベルエラー）

VTでharmless >= 60, malicious = 0 のドメイン = 実際は正規サイト

| ソース | 件数 | 備考 |
|--------|------|------|
| jpcert | 128 | |
| certificates | 26 | |
| phishtank | 10 | |

---

## 2. データベースクレンジング実行

### 削除結果

| テーブル | 削除レコード数 | 備考 |
|----------|---------------|------|
| trusted_certificates | 29 | FPラベルエラー |
| jpcert_phishing_urls | 162 | FNラベルエラー（重複含む） |
| certificates | 26 | FNラベルエラー |
| phishtank_entries | 22 | FNラベルエラー（重複含む） |
| **合計** | **239** | |

※ 削除ドメイン数(193)と削除レコード数(239)の差は、同一ドメインの重複レコードによる

### 実行手順

1. データベースバックアップ取得
2. 削除記録作成（`docs/data_cleaning_log.md`）
3. 削除SQL実行（`scripts/data_cleaning_complete.sql`）
4. パイプライン再実行

---

## 3. パイプライン再実行結果

### 実行概要

```
RUN_ID: 2026-01-21_152158
実行時間: 約10分（evaluate_e2e除く）
```

### データフロー

```
入力: 128,002件 (Phishing 64,001 / Benign 64,001)
         │
    ┌────┴────┐
    ▼         ▼
┌─────────────────────────────────────────────────┐
│  Stage1: XGBoost                                │
│  ・AUTO_BENIGN:   11,094件 (ML<0.002)  → 確定   │
│  ・AUTO_PHISHING: 59,989件 (ML>0.98)   → 確定   │
│  ・HANDOFF:       56,919件             → Stage2 │
└─────────────────────────────────────────────────┘
         │ (56,919件)
         ▼
┌─────────────────────────────────────────────────┐
│  Stage2: Gate/LR + 証明書ルール                 │
│  ・Safe Benign:   38,976件 (証明書で安全判定)   │
│  ・DROP:          39,485件 (スコア低)  → 確定   │
│  ・HANDOFF:       17,434件             → Stage3 │
└─────────────────────────────────────────────────┘
         │ (17,434件)
         ▼
┌─────────────────────────────────────────────────┐
│  Stage3: AI Agent (評価中)                      │
└─────────────────────────────────────────────────┘
```

---

## 4. Stage1/Stage2 性能

### Stage1 XGBoost

| 決定 | 件数 | 割合 | 正解 | エラー | エラー率 |
|------|------|------|------|--------|---------|
| AUTO_BENIGN | 11,094 | 8.7% | 11,085 | 9 (FN) | 0.08% |
| AUTO_PHISHING | 59,989 | 46.9% | 59,984 | 5 (FP) | 0.01% |
| HANDOFF | 56,919 | 44.5% | - | - | - |

**Stage1 AUTOエラー率: 0.02%** (14件/71,083件)

### Stage2 Gate/LR

| 項目 | 値 |
|------|-----|
| Stage1 Handoff | 56,919件 |
| Stage2 Handoff → Stage3 | 17,434件 |
| AUTO決定 | 110,568件 |
| **AUTOエラー** | **427件 (0.39%)** |

### フィルタリング効果

| フィルタ | 件数 |
|----------|------|
| 証明書ルールでBenign判定 | 38,814件 |
| Safe Benign combined | 38,976件 |
| High ML Phish救済 | 2,514件 |

---

## 5. evaluate_e2e.py 3000件評価

### 実行状況

| 項目 | 値 |
|------|-----|
| 開始時刻 | 2026-01-21 19:38 |
| サンプル数 | 3,000件 |
| 推定完了 | 約7-8時間後 |
| PID | 2619766 |

### 進捗確認コマンド

```bash
tail -f eval_3000_*.log
```

---

## 本日の成果まとめ

### データ品質改善

1. **VirusTotal調査完了**: 2,172件全件調査
2. **ラベリングエラー特定**: 193ドメイン（8.9%）
3. **データベースクレンジング**: 239レコード削除
4. **パイプライン再実行**: クリーンデータで検証完了

### 性能指標

| 指標 | 値 |
|------|-----|
| Stage1 AUTOエラー率 | **0.02%** |
| Stage2 AUTOエラー率 | **0.39%** |
| Stage3送り | 17,434件 (13.6%) |

### 生成ファイル

| ファイル | 内容 |
|----------|------|
| `docs/data_cleaning_log.md` | 削除記録 |
| `scripts/data_cleaning_complete.sql` | 削除SQL |
| `artifacts/2026-01-21_152158/` | 再実行結果 |

---

## 次のステップ

1. [ ] evaluate_e2e.py 3000件評価の完了待ち
2. [ ] AI Agent評価結果の分析
3. [ ] クレンジング前後の性能比較
4. [ ] 必要に応じてALL評価（17,434件）
