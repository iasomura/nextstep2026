# 研究日誌 2026-01-12

## 概要

Stage2に証明書ベースの早期終了ルール（Scenario 6）を実装し、Stage3へのHandoff件数を大幅に削減した。

## 用語・システム構成

本システムの3段階パイプライン（Stage1/Stage2/Stage3）およびHandoff等の用語定義については [2026-01-10の研究日誌](20260110.md) を参照。

## 背景・課題

### Stage3 Handoffの課題

Stage3（AI Agent/LLM）による分析は1件あたり約8秒を要するため、Handoff件数の削減がスループット向上の鍵となる。

既存のScenario 5（safe_benign）では以下の条件でStage3をスキップ：
- `p1 < 0.15` AND `defer_score < 0.40`

しかし、証明書分析から発見した高識別力特徴量を活用することで、さらなる削減が可能と判断した。

### 証明書分析からの発見

2026-01-11の証明書分析で以下の特徴量が高い識別力を持つことが判明：

| 特徴量 | 正規サイト | フィッシング | 識別力 |
|--------|-----------|-------------|--------|
| CRL Distribution Points | 81.7% | 1.6% | **80.1%** |
| ワイルドカード証明書 | 55.1% | 1.5% | **53.6%** |
| OV/EV証明書 | 6.6% | 0.1% | 6.5% |
| 有効期間180日超 | 27.0% | 1.0% | 26.0% |

## 実施事項

### 1. 仕様策定

証明書ベースの早期終了ルール仕様書を作成：
- `docs/specs/stage2_certificate_rules_spec.md`
- `docs/specs/stage1_stage2_feature_spec.md`

### 2. 実装

`02_main.py` に Scenario 6（証明書ベースルール）を実装。

#### 追加した設定オプション (L113-128)

```python
'stage2_cert_rules_enabled': True,
'stage2_cert_benign_crl_enabled': True,       # CRL保有
'stage2_cert_benign_crl_p1_max': 0.30,
'stage2_cert_benign_ov_ev_enabled': True,     # OV/EV証明書
'stage2_cert_benign_wildcard_enabled': True,  # ワイルドカード
'stage2_cert_benign_long_validity_enabled': True,  # 長期有効期間
'stage2_cert_benign_long_validity_days': 180,
'stage2_cert_benign_long_validity_p1_max': 0.25,
'stage2_cert_phish_tier1_tld_enabled': True,  # Tier1危険TLD + LE
'stage2_cert_phish_tier1_tlds': ['gq', 'ga', 'ci', 'cfd', 'tk'],
'stage2_cert_phish_dynamic_dns_enabled': True,  # 動的DNS + 大量SAN
'stage2_cert_phish_dynamic_dns_san_min': 20,
```

#### Safe BENIGN ルール

| ルール | 条件 | 根拠 |
|--------|------|------|
| CRL | `cert_has_crl_dp=1` AND `p1<0.30` | 正規81.7% vs フィッシング1.6% |
| OV/EV | `cert_subject_has_org=1` | 正規6.6% vs フィッシング0.1% |
| Wildcard | `cert_is_wildcard=1` AND `!dangerous_tld` | 正規55.1% vs フィッシング1.5% |
| Long Validity | `cert_validity_days>180` AND `p1<0.25` | 正規27% vs フィッシング1% |

#### Safe PHISHING ルール

| ルール | 条件 | 根拠 |
|--------|------|------|
| Tier1 TLD | `tld in [gq,ga,ci,cfd,tk]` AND `is_lets_encrypt=1` | フィッシング率99%以上 |
| Dynamic DNS | `domain.endswith(duckdns等)` AND `san_count>=20` | 動的DNS悪用パターン |

### 3. 変更ファイル

| ファイル | 変更内容 |
|----------|----------|
| `02_main.py` L113-128 | 設定オプション追加 |
| `02_main.py` L802-892 | ルールロジック実装 |
| `02_main.py` L900-947 | 選択ロジック・統計更新 |
| `02_main.py` L1001-1009 | 変数初期化追加 |
| `02_main.py` L1029-1032 | gate_traceカラム追加 |
| `02_main.py` L1321-1323 | df_stage1に証明書特徴量追加 |

## 評価結果

### ルール別ヒット数

| ルール | ヒット数 |
|--------|----------|
| CRL Distribution Points | **54,567** |
| 長期有効期間 (180日超) | 8,507 |
| ワイルドカード | 4,841 |
| OV/EV証明書 | 1,355 |
| Tier1 TLD + LE | 12 |
| 動的DNS + 大量SAN | 0 |

### Stage3 Handoff削減効果

| 指標 | Scenario 5のみ | Scenario 5+6 | 変化 |
|------|----------------|--------------|------|
| Safe BENIGN | 33,477 | **57,779** | +72.6% |
| Safe PHISHING | - | 12 | +12 |
| Stage3 Handoff | 5,003 | **4,386** | -12.3% |

### パイプライン全体

| 段階 | 件数 | 割合 |
|------|------|------|
| 全テストデータ | 128,067 | 100% |
| Stage1 → Stage2 (DEFER) | 62,725 | 49.0% |
| Stage2 → Stage3 (Handoff) | **4,386** | **3.4%** |
| Stage2でフィルタ (PENDING) | 58,339 | 45.6% |

Stage2で **93.0%** のDEFERケースをフィルタリングし、Stage3へは全体の **3.4%** のみ送信。

### 精度への影響

| 指標 | 変更前 | 変更後 |
|------|--------|--------|
| Auto Error Rate | 1.07% | 1.10% |
| Precision | 18.97% | 20.59% |
| Recall | 41.81% | 39.78% |

Auto Error Rateはわずかに上昇（+0.03%）したが、Stage3コスト削減効果を考慮すると許容範囲。

## 考察

### 1. CRLルールの有効性

CRL Distribution Points（CRL配布ポイント）は最も効果的な識別特徴量であった。

- **54,567件**のケースに適用
- 正規サイトの81.7%が保有、フィッシングはわずか1.6%
- 証明書発行プロセスの違いを反映（正規サイトはCA/B Forumの基準に準拠）

### 2. 動的DNSルールの不発

動的DNSルールは0件にヒット。原因として：
- テストデータに動的DNSドメインが少ない可能性
- またはSAN数20以上の条件が厳しすぎる

今後、閾値調整またはOR条件への変更を検討。

### 3. Tier1 TLDルールの限定的効果

Tier1 TLD（.gq, .ga, .ci, .cfd, .tk）+ Let's Encryptの組み合わせは12件のみ。

- DEFERリージョンにはこれらのTLDが少ない（Stage1で既にauto_phishingに分類済み）
- Stage2での効果は限定的だが、安全策として維持

### 4. スケール済み特徴量の扱い

`X_defer` はStandardScalerでスケール済みのため、バイナリ特徴量（0/1）は `> 0.5` で判定。連続値（validity_days, san_count）は `df_defer` から生データを参照するよう実装。

---

## Stage3 証明書特徴量強化の検討

### 背景

Stage2で有効性が確認された証明書特徴量が、Stage3（AI Agent）では十分に活用されていないことが判明。

### 現状の問題点

| 特徴量 | Stage2での扱い | Stage3での扱い | 問題 |
|--------|---------------|---------------|------|
| CRL Distribution Points | Safe BENIGN | **未使用** | 80%の識別力が未活用 |
| OV/EV証明書 | Safe BENIGN | **未使用** | 正規の強いシグナル |
| ワイルドカード | Safe BENIGN | **リスク扱い** | 解釈が逆 |
| 長期有効期間 | Safe BENIGN | short_termのみ | 長期=正規が未活用 |

### 提案: Benign Certificate Gates

Stage3に以下のゲートを追加する仕様を策定：

| ゲート | 条件 | 効果 |
|--------|------|------|
| Gate B1 | OV/EV証明書 + ctx < 0.50 | → BENIGN強制 |
| Gate B2 | CRL保有 + ml < 0.30 + ctx < 0.45 | → BENIGN強制 |
| Gate B3 | ワイルドカード + 非危険TLD + ctx < 0.40 | → BENIGN強制 |

### 期待効果

- **FP削減**: 正規サイトの誤検知を防止
- **一貫性**: Stage2/Stage3で同じ証明書特徴量を活用
- **処理効率**: 明らかに正規のケースを早期判定

### 仕様書

`docs/specs/stage3_certificate_enhancement_spec.md` を作成。

---

## Stage3 Handoffデータの詳細分析

### 分析対象

Stage2からStage3へ送信される4,386件のHandoffデータを分析。

### ケース分類

| カテゴリ | 件数 | 説明 | 対応 |
|----------|------|------|------|
| 低シグナルフィッシング | 176 | 低ML(<0.3) + 実Phishing | **検知必須** |
| FP Risk | 124 | 高ML(≥0.7) + 実Benign | **FP防止** |
| 正常Phishing | 1,616 | 高ML + 実Phishing | 容易 |
| 正常Benign | 1,867 | 低ML + 実Benign | 容易 |

**用語**:
- **低シグナルフィッシング (Low-Signal Phishing)**: MLが捉える特徴量（シグナル）が少なく、低リスクと誤判定されるフィッシング
- **FP Risk**: MLが高リスクと判定するが実際は正規サイトであるケース

### 低シグナルフィッシング（Stage3で検知すべきフィッシング）

**特徴:**
- TLD: .comが多い（100/176 = 57%）
- 証明書: 短期有効（90日以下）が**97.7%**
- ソース: JPCERT主体（94/176 = 53%）
- ドメイン: 正規ビジネスのように見える名前
- SAN: 平均4.3（少ない）

**サンプルドメイン:**
```
ml=0.040 | .in  | playstationgames.in
ml=0.056 | .com | pepzop.com
ml=0.061 | .com | techwillow.com
ml=0.064 | .online | amzawszone.online
```

**必要なシグナル:**
- ブランド偽装チェック（ロゴ、ファビコン）
- コンテンツ分析（ログインフォーム、クレデンシャル要求）
- WHOISで新規登録かどうか
- 類似ドメインチェック（typosquatting）

### FP Risk（Stage3でFPを防ぐべき正規サイト）

**特徴:**
- TLD: .comが多い、.govも含まれる
- 証明書: SAN数が多い（平均**13.2**）
- 含まれる正規サイト: github.com, miumiu.com, gov.wales等
- ドメイン: 数字やハイフン含むが正規

**サンプルドメイン:**
```
ml=0.932 | .com | github.com
ml=0.943 | .com | miumiu.com
ml=0.945 | .gov | flcourts.gov
ml=0.934 | .scot | consult.gov.scot
```

**必要な保護:**
- 既知正規ドメインのホワイトリスト
- OV/EV証明書の検出
- CRL配布ポイントの確認
- 長期運営ドメイン（WHOIS経過年数）

### 重要な発見: SAN数が識別に有効

| カテゴリ | SAN平均 |
|----------|---------|
| 低シグナルフィッシング（検知） | **4.3** |
| FP Risk（FP防止） | **13.2** |
| 正常Phishing | 9.2 |
| 正常Benign | 3.6 |

**考察**: SAN数が多い場合は正規サイトの可能性が高い。Stage3でSAN数をBenignシグナルとして活用可能。

---

## Low Signal Phishing Gate LLMテスト結果

### 実装内容

`llm_final_decision.py` に低シグナルフィッシング検出ゲート (P1-P3) を実装:

- **Gate P1**: brand_detected + cert≤90日 + ml<0.30 → PHISHING強制
- **Gate P2**: brand_suspected + cert≤90日 + san≤5 + ml<0.25 → PHISHING強制
- **Gate P3**: dangerous_tld + cert≤90日 + san≤3 + ml<0.20 + no_benign → risk bump

ポリシーバージョン: `v1.5.0-low-signal-phishing-gate`

### テスト環境

- テストスクリプト: `scripts/test_low_signal_phishing_gate.py`
- テストデータ: 低シグナルフィッシング19件（y_true=1, ml<0.25）
- 証明書データ: `cert_full_info_map`（55,524件）から取得

### テスト結果

| 指標 | 結果 |
|------|------|
| 検出率 | **0/19 (0%)** |
| LOW_SIGNAL_GATE発火 | 0件 |
| 処理時間 | 111秒（5.84秒/件） |

### 証明書データ取得の確認

修正前は `valid_days=0` が全件だったが、`_adapt_cert_meta()` を修正して `not_before`/`not_after` から `valid_days` を計算するようにした結果、正しく取得できることを確認:

| ドメイン | valid_days | san_count | is_free_ca |
|----------|------------|-----------|------------|
| usps-pyc.com | 89 | 2 | True |
| family-officebell.com | 89 | 2 | True |
| au-safety.com | 89 | 1 | True |
| mrelay-servicefr.com | 89 | 2 | True |

### 検出失敗の原因分析

ゲートが発火しない理由:

1. **brand_detected=False**: テスト対象ドメインのブランドが `brand_keywords` リストに含まれていない
   - `usps-pyc.com` → "usps" は brand_keywords に未登録
   - `au-safety.com` → "au" は brand_keywords に未登録
   - `relay-retrait.com` → "relay" は brand_keywords に未登録

2. **dangerous_tld=False**: 全ドメインが `.com` TLD（危険TLDではない）

3. **brand_keywords の現状**: 109件のみ、郵便サービス系が少ない
   - 含まれる: swisspost
   - 含まれない: usps, royalmail, laposte, deutschepost, japanpost, auspost

### 技術的な修正点

1. `phishing_agent/tools/certificate_analysis.py`:
   - `_adapt_cert_meta()` に `not_before`/`not_after` → `valid_days` 計算ロジック追加

2. `scripts/test_low_signal_phishing_gate.py`:
   - データ取得パスを `result.get('tool_summary')` から `result.get('graph_state', {}).get('tool_results')` に修正

### 考察

現在の Low Signal Phishing Gate は **ブランド検出依存** の設計となっており、ブランド名が `brand_keywords` に登録されていない場合は検出不可。

低シグナルフィッシングの多くはブランド名を直接含まないため、この設計ではカバレッジが低い。

### 改善案

1. **brand_keywords の拡充**:
   - 郵便サービス: usps, royalmail, laposte, deutschepost, japanpost, auspost, canadapost
   - 金融: 国内銀行、カード会社
   - 通信: 携帯キャリア

2. **ブランド検出に依存しない新ゲート（P4）**:
   ```
   条件:
     - cert_validity_days <= 90
     - san_count <= 3
     - ml_probability < 0.15
     - is_free_ca = true
     - benign_indicators が空
     - contextual_risk_score >= 0.40

   効果:
     - risk_level を medium に上昇
     - フラグ追加: suspicious_low_signal
   ```

3. **LLMによるブランド推測強化**:
   - 現在はbrand_keywords にマッチしないとLLM呼び出しをスキップ
   - brand_keywords に依存せず、ドメイン名から直接LLMでブランド推測

---

## 低シグナルフィッシングのラベル検証

### 背景・疑問

低シグナルフィッシング（ml < 0.30）1,446件について、「そもそも本当にフィッシングか？」という疑問を検証。

### 検証方法

Wayback Machine APIを使用して、ドメインの過去アーカイブ存在を確認。

- 長期間アーカイブあり → 正規サイトが一時侵害された可能性
- アーカイブなし → 純粋なフィッシング（短命ドメイン）

### サンプリング検証結果（150件）

| ソース | アーカイブあり | アーカイブなし | エラー |
|--------|--------------|--------------|--------|
| PhishTank (50件) | 50% | 28% | 22% |
| JPCERT (50件) | **66%** | 14% | 20% |
| certificates (50件) | 0% | 0% | **100%** |

### 解釈

1. **JPCERT (66%アーカイブあり)**
   - 長期間存在する正規サイトが多数
   - 「一時侵害パターン」の可能性が高い

2. **PhishTank (50%アーカイブあり)**
   - 純粋なフィッシングと侵害サイトが混在

3. **certificates (100%エラー)**
   - ドメインが存在しないか、極めて短命
   - 証明書ヒューリスティックのみでラベル付け → **信頼性が最も低い**

### 結論

低シグナルフィッシングの多くは「ドメインレベルのフィッシング」ではなく、**正規ドメインの一時侵害**である可能性が高い。

| パターン | 推定割合 | 対応方針 |
|----------|---------|---------|
| 純粋なフィッシング | ~30% | 検出可能（ブランド偽装あり） |
| 侵害された正規サイト | ~40% | ドメイン単位検出は不適切 |
| ラベル疑問 | ~30% | certificates ソース要除外 |

### 今後の方針

1. **certificatesソースのデータは除外または低信頼として扱う**
2. **低シグナルフィッシング検出の優先度を下げる**（FPリスクが高い）
3. **URLレベルの検出**が本来必要（ドメインレベルでは限界）

---

## 現在稼働中サイトの除外リスト作成

### 目的

「現在正規サイトとして動作している」ドメインを特定し、低シグナルフィッシングから除外する。

### 検証方法

1. DNS解決可能か確認
2. HTTP 200でアクセス可能か確認
3. コンテンツに正規サイト指標があるか確認
   - 正規指標: "about us", "contact", "privacy policy", "copyright", "会社概要", "お問い合わせ" 等
   - フィッシング指標: "verify your account", "suspended", "confirm your identity" 等

### 全件検証結果（1,446件）

| 指標 | 件数 | 割合 |
|------|------|------|
| DNS解決可能 | 986 | 68.2% |
| HTTP 200 | 192 | 13.3% |
| **正規サイト風** | **109** | **7.5%** |
| フィッシング風 | 3 | 0.2% |

### ソース別除外候補

| ソース | 総件数 | DNS解決 | 正規サイト風 | 除外率 |
|--------|--------|---------|-------------|--------|
| JPCERT | 613 | 429 | **78** | 12.7% |
| PhishTank | 647 | 435 | 21 | 3.2% |
| certificates | 186 | 122 | 10 | 5.4% |

### 除外候補の例

**日本の正規企業サイト（JPCERT報告）:**
- `tcial.jp` - 会社概要、お問い合わせあり
- `s-esu.co.jp` - 日本企業サイト
- `mizunowa.jp` - 日本企業サイト
- `asset-design.jp` - 日本企業サイト
- `yesseafood.com` - シーフード会社

**海外の正規サイト:**
- `praevida.com.ar` - アルゼンチン企業
- `urbanandruraldesign.com.au` - オーストラリア企業
- `buscoverytours.com` - 旅行会社

### 結論

1. **109件を除外候補としてリスト化** → `low_signal_exclusion_list.csv`
2. **JPCERTソースの12.7%が現在正規サイト** → 一時侵害パターンの証拠
3. **低シグナルフィッシング1,446件のうち、純粋なフィッシングは限定的**

### 出力ファイル

- `artifacts/2026-01-10_140940/stage3_test/low_signal_alive_check_full.csv` - 全件チェック結果
- `artifacts/2026-01-10_140940/stage3_test/low_signal_exclusion_list.csv` - 除外候補109件

---

## 対照実験: 低シグナル vs 高シグナル

### 目的

「低シグナルフィッシングは正規サイトの一時侵害が多い」という仮説を統計的に検証する。

### 実験設計

| グループ | 条件 | 件数 |
|----------|------|------|
| 低シグナル | y_true=1, ml < 0.30 | 1,446件 |
| 高シグナル | y_true=1, ml > 0.70 | 1,387件 |

同じ検証方法（DNS解決、HTTP応答、正規サイト指標）を適用。

### 結果

| 指標 | 低シグナル | 高シグナル | 比率 |
|------|-----------|-----------|------|
| DNS解決可能 | 68.2% | 35.5% | **1.9倍** |
| HTTP 200 | 13.3% | 1.9% | **7.0倍** |
| 正規サイト風 | **7.5%** | **0.4%** | **17倍** |

### 統計的検定

```
カイ二乗検定（正規サイト風の割合）
χ² = 89.96
p < 0.001 (非常に有意)
```

### 解釈

1. **低シグナルフィッシングは「生存率」が高い**
   - DNS解決可能率が1.9倍 → ドメインがまだ存在している
   - 純粋なフィッシングドメインは短命（テイクダウン済み）

2. **低シグナルフィッシングは「正規サイト」の特徴を持つ**
   - 正規サイト風率が17倍 → 正規ビジネスサイトが侵害されたパターン
   - 高シグナルフィッシングは専用ドメインで短命

3. **統計的に非常に有意（p < 0.001）**
   - 偶然ではなく、構造的な違いがある

### 論文への示唆

この結果は以下の主張を支持する：

> 「MLスコアが低いフィッシング（低シグナルフィッシング）の多くは、
> 純粋なフィッシングドメインではなく、正規ドメインの一時的な侵害である。
> したがって、ドメイン単位での検出は本質的に限界があり、
> URLパスレベルまたはコンテンツレベルでの検出が必要である。」

---

## 詳細分析: HTTPステータスの内訳

### 「正規サイト風」割合が低い理由

低シグナル1,446件の内訳：

| カテゴリ | 件数 | 割合 | 説明 |
|----------|------|------|------|
| DNS解決不可 | 460 | 31.8% | テイクダウン済み or 短命ドメイン |
| DNS解決可能 | 986 | 68.2% | ドメインは存続 |

DNS解決可能（986件）の内訳：

| HTTPステータス | 件数 | 割合 | 説明 |
|---------------|------|------|------|
| 200 OK | 192 | 19.5% | 正常動作中 |
| 503 Service Unavailable | 670 | 68.0% | **サスペンション状態** |
| 403 Forbidden | 57 | 5.8% | アクセス拒否 |
| その他/無応答 | 67 | 6.8% | サーバー停止等 |

### 503エラーの解釈

503エラー（68%）の多さは重要な発見：
- ホスティング会社によるフィッシング検出後のサスペンション
- ドメイン自体は存続（正規所有者のもの）
- フィッシングコンテンツは削除済み

### 複数角度からの証拠

| 指標 | 低シグナル | 高シグナル | 倍率 |
|------|-----------|-----------|------|
| DNS生存率 | 68.2% | 35.5% | **1.9倍** |
| サーバー稼働率（HTTP 200） | 19.5% | 5.5% | **3.5倍** |
| 稼働中の正規サイト率 | 56.8% | 22.2% | **2.6倍** |

### 論文用サマリー

**主張**: 低シグナルフィッシングは、純粋なフィッシングドメインではなく、正規ドメインの一時的な侵害であることが多い。

**証拠**:
1. **DNS生存率**: 低シグナルは1.9倍高い → ドメインが継続使用されている
2. **サーバー稼働率**: 低シグナルは3.5倍高い → 現在もサービス提供中
3. **稼働中の正規性**: 低シグナルは2.6倍高い → 正規ビジネスサイト
4. **統計的有意性**: χ² = 89.96, p < 0.001

**限界と考察**:
1. 絶対値が低い（7.5%）のは、多くがサスペンション状態（503）のため
2. サスペンションは「フィッシング検出後の対応」を示唆
3. 低シグナルでも68%がDNS存続 → ドメイン自体は正規目的で継続使用
4. 「ドメインレベル」での検出限界を示す重要な知見

**推奨される論文記述**:

> 「低シグナルフィッシングドメインは、高シグナルと比較して
> DNS存続率が1.9倍、サーバー稼働率が3.5倍高く、
> 稼働中のドメインの過半数（56.8%）が正規サイトの特徴を持つ。
> これは、低シグナルフィッシングの多くが正規ドメインの一時侵害であり、
> ドメイン単位での検出には本質的な限界があることを示す。」

---

## 低シグナルフィッシング検出の最終評価

### データ品質の問題

| 問題 | 影響 |
|------|------|
| 一時侵害された正規サイトが含まれる | ドメイン単位での検出は不適切 |
| certificatesソースの信頼性が低い | ヒューリスティックのみでラベル付け |
| 現在正規サイトとして動作中のドメインが7.5% | ラベルの精度に疑問 |

### 推奨対応

1. **Low Signal Phishing Gate (P1-P3)**: 現状維持（ブランド偽装ありのみ検出）
2. **ブランド非依存の検出 (P4)**: 実装見送り（FPリスクが高い）
3. **データ品質改善**: certificatesソースの除外、または信頼度ラベル追加

### システム完成度

| コンポーネント | 状態 | 備考 |
|----------------|------|------|
| Stage1 (XGBoost) | ✅ 完成 | |
| Stage2 (LR + 証明書ルール) | ✅ 完成 | |
| Stage3 Benign Cert Gate (B1-B4) | ✅ 完成 | FP防止に有効 |
| Stage3 Low Signal Gate (P1-P3) | ⚠️ 限定的 | ブランド偽装ありのみ |
| 低シグナルフィッシング全般検出 | ❌ 見送り | データ品質問題 |

---

## 次のステップ

### Stage2関連
- [ ] 動的DNSルールの閾値調整（san_count >= 10に緩和を検討）
- [ ] Tier2 TLDルールの追加検討（.xyz, .top, .shop等）
- [ ] Safe PHISHINGルールの拡充
- [ ] A/Bテストによる精度影響の詳細評価

### Stage3関連
- [x] certificate_analysis.pyにbenign_indicators追加
- [x] Gate B1-B4（Benign Cert Gate）実装
- [x] Gate P1-P3（Low Signal Phishing Gate）実装
- [x] ユニットテストの追加
- [ ] **brand_keywords の拡充**（優先度高）
- [ ] **ブランド非依存の検出ゲート（P4）検討**
- [ ] LLMブランド推測の強化

## 作成・更新したファイル

### 仕様書
- `docs/specs/stage2_certificate_rules_spec.md` - Stage2証明書ルール仕様（実装完了）
- `docs/specs/stage1_stage2_feature_spec.md` - Stage1/2特徴量仕様
- `docs/specs/stage3_certificate_enhancement_spec.md` - **Stage3証明書強化仕様（新規）**

### 分析メモ
- `docs/analysis/feature_candidates_memo.md` - 特徴量候補メモ
- `docs/analysis/certificate_analysis_report.md` - 証明書分析レポート

### 実装
- `02_main.py` - Stage2証明書ルール実装（Scenario 6）

---

## 3-Stage Pipeline パフォーマンス総括

### 分析目的

システム全体のパフォーマンスを評価し、論文でAI Agent（Stage3）の優位性を主張できる程度の性能が達成されているか確認する。

### データセット

| 項目 | 件数 |
|------|------|
| 総データ数 | 128,067 |
| Phishing | 64,033 (50%) |
| Benign | 64,034 (50%) |

### Stage別処理結果

#### Stage1 (XGBoost)

| 決定 | 件数 | 正解率 |
|------|------|--------|
| auto_phishing | 59,874 | 100.00% (TP=59,872, FP=2) |
| auto_benign | 5,468 | 99.95% (TN=5,465, FN=3) |
| handoff_to_agent | 62,725 | - |

#### Stage2 (Certificate Rules)

| 処理 | 件数 |
|------|------|
| Stage1からのhandoff | 62,725 |
| auto_benignに落とした数 | 58,339 (93.0%) |
| Stage3へのhandoff | 4,386 (7.0%) |
| Stage2 auto_benign精度 | 96.64% (TN=56,380, FN=1,959) |

#### Stage3 (AI Agent) への入力

| 項目 | 件数 | 割合 |
|------|------|------|
| 総handoff | 4,386 | 3.4% |
| - Phishing | 2,199 | 50.1% |
| - Benign | 2,187 | 49.9% |

### パフォーマンス比較

#### シナリオ分析

| シナリオ | Precision | Recall | F1 |
|----------|-----------|--------|-----|
| Stage3なし（handoff→benign） | 1.0000 | 0.9350 | 0.9664 |
| Stage3なし（ML閾値0.5で判定） | 0.9948 | 0.9603 | 0.9772 |
| 理想的Stage3（全handoff正解） | 1.0000 | 0.9694 | **0.9844** |

#### Stage3精度とシステムF1の関係

| Stage3精度 | システムPrecision | システムRecall | システムF1 |
|------------|------------------|----------------|------------|
| 60% | 0.9859 | 0.9556 | 0.9705 |
| 70% | 0.9894 | 0.9590 | 0.9740 |
| 80% | 0.9929 | 0.9624 | 0.9774 |
| 90% | 0.9964 | 0.9659 | 0.9809 |
| 100% | 1.0000 | 0.9693 | 0.9844 |

参考: ML閾値0.5（精度79.4%）: F1 = 0.9772

### Stage3が処理する難しいケース

| カテゴリ | 件数 | 説明 |
|----------|------|------|
| Low ML Phishing (ML < 0.3) | 176 | MLでは検出不能、LLMの意味理解が必要 |
| High ML Benign (ML ≥ 0.7) | 124 | MLでは誤検知、LLMで回避が必要 |
| Mid ML (0.3-0.7) | 1,596 | 判断困難、多角的分析が必要 |

### False Positiveリスクの例

MLスコアが高い（0.7以上）が実際はbenignのドメイン：

| ドメイン | MLスコア | 備考 |
|----------|----------|------|
| b2evolution.net | 0.955 | ブログプラットフォーム |
| datatransfer.com | 0.909 | 正規サービス |
| forums.tigsource.com | 0.907 | ゲーム開発フォーラム |
| moika78.ru | 0.889 | ロシアニュースサイト |
| phl17.com | 0.863 | 米国TVニュース |

これらをStage3（AI Agent）がコンテキスト理解により正しくbenignと判定することで、False Positiveを回避できる。

### 論文での主張ポイント

#### 1. 定量的改善

- Stage3が80%精度 → F1: 0.9772 → 0.9774 (+0.02%)
- Stage3が90%精度 → F1: 0.9772 → 0.9809 (+0.37%)
- 完璧なStage3 → F1: 0.9844 (+0.72%)

#### 2. セキュリティ観点の価値（より重要）

- **False Positive回避**: 124件の正規サイト誤ブロック防止
- **Low signal phishing検知**: 176件のMLでは検知不能なフィッシング
- **ユーザー体験向上**: 正規サイトへのアクセス妨害を削減

#### 3. コスト効率

| 処理方式 | LLM呼び出し件数 | 削減率 |
|----------|-----------------|--------|
| 全件LLM処理 | 128,067 | - |
| 3-Stageカスケード | 4,386 | **96.6%削減** |

Stage1+Stage2で96.6%のケースを自動処理し、LLM呼び出しを大幅に削減。

#### 4. 技術的貢献

1. **3段階カスケード構造の有効性実証**
   - Stage1: 高信頼度の自動判定（Precision 100%/99.95%）
   - Stage2: 証明書ルールによる効率的フィルタリング（93%削減）
   - Stage3: 困難なケースへのLLM活用

2. **各ステージの役割分担最適化**
   - Stage1は明確なケースを高精度で処理
   - Stage2は証明書特徴量で中間ケースをフィルタ
   - Stage3は意味理解が必要なケースのみ処理

3. **MLとLLMのハイブリッドアプローチ**
   - MLの高速処理 + LLMの深い理解
   - コスト効率とパフォーマンスの両立

### 結論

Stage3 AI Agentは、ML単体では達成できないF1 0.9772 → 0.9844の改善を実現可能。

**特に重要なのは**：
- False Positive回避（124件の正規サイト保護）
- Low signal phishing検知（176件のML検出不能ケース）
- コスト効率（96.6%のLLM呼び出し削減）

これらの点で、AI Agentの優位性を論文で主張できる水準に達している。

---

## Stage2証明書ルールの独立評価

### 背景・問題意識

Stage2の93%フィルタリング率は、証明書分析レポートの統計（CRL 81.7% vs 1.6%等）から導出したルールを、**同じデータで評価**している可能性があった。

過学習（data leakage）の懸念を検証するため、**独立したtrain/test split**で再評価を実施。

### 実験設計

| データ | 件数 | 用途 |
|--------|------|------|
| Train | 76,800 (Phishing 38,400 + Benign 38,400) | 統計算出 |
| Test | 51,200 (Phishing 25,600 + Benign 25,600) | ルール評価 |

元データ（320k phishing + 320k trusted）から新規にサンプリングし、60:40で分割。

### Train setから算出した証明書統計

| 特徴量 | Phishing | Benign | 識別力 |
|--------|----------|--------|--------|
| CRL Distribution Points | 8.2% | 91.7% | **83.5%** |
| OV/EV (組織名) | 0.2% | 6.1% | 5.9% |
| ワイルドカード | 0.5% | 11.5% | 11.0% |
| 長期有効期間 (>180日) | 2.4% | 21.8% | 19.4% |
| Let's Encrypt | 93.0% | 39.3% | 53.7% |

※ 証明書分析レポートの統計（CRL: Benign 81.7%, Phishing 1.6%）と若干異なるが、同様の傾向。

### Test setでのルール評価結果

| ルール | ヒット数 | 精度 | FN(見逃し) |
|--------|----------|------|------------|
| CRL | 25,546 | **91.7%** | 2,129 |
| OV/EV | 1,623 | 97.0% | 49 |
| Wildcard | 3,065 | 96.1% | 121 |
| Long Validity | 6,230 | 90.8% | 573 |
| **全ルール (OR)** | **27,266** | **90.7%** | **2,533** |

### 元の評価との比較

| 指標 | 元の評価 | 独立評価 | 差異 |
|------|----------|----------|------|
| フィルタリング率 | **93.0%** | **53.3%** | **-39.7%** |
| 精度 | 96.64% | 90.71% | -5.9% |
| FN率 | 3.36% | 9.89% | +6.5% |

### 考察

1. **フィルタリング率の大幅低下（93% → 53%）**
   - 元の評価では、ルール導出に使ったデータで評価していた
   - 独立評価では、フィルタリング率が約半分に低下
   - **過学習の証拠**

2. **精度の低下（97% → 91%）**
   - 見逃し率（FNR）が3.4% → 9.9%に上昇
   - 2,533件のフィッシングを見逃す

3. **CRLルールの限界**
   - Train統計: Phishing 8.2%がCRL保有
   - Test結果: 2,129件のPhishingがCRLルールで見逃される
   - 「CRLあり = 正規サイト」は絶対的ではない

### 結論

**Stage2の93%フィルタリングは過学習の結果**であり、独立データでは53%程度が現実的。

これにより、Stage3へのHandoff件数は当初想定より増加する：
- 元の想定: 4,386件 (3.4%)
- 修正後の想定: 約60,000件以上

### 今後の対応

1. **Stage2ルールの閾値調整**: より保守的な条件で精度向上
2. **クロスバリデーション導入**: k-foldで安定した性能評価
3. **Stage3の重要性再認識**: フィルタリングに頼りすぎない設計

---

## Stage2 LR過学習分析（学習曲線）

### 背景

Stage2の93%フィルタリング率が過学習によるものかを検証するため、LR（Logistic Regression）モデルの学習曲線を分析した。

### 分析手法

- Stage2 DEFERデータ（62,411件）を80:20でTrain/Test分割
- 学習データ量を10%〜100%で変化させながらROC-AUCを計測
- 5-Fold Cross Validationで安定性を確認

### 学習曲線結果

| Train Size | Train AUC | Val AUC | Gap |
|------------|-----------|---------|-----|
| 4,992 | 0.8196 | 0.8136 | 0.0060 |
| 14,978 | 0.8208 | 0.8171 | 0.0037 |
| 29,956 | 0.8176 | 0.8162 | 0.0014 |
| 49,928 | 0.8178 | 0.8178 | **-0.0000** |

### 評価指標

| 指標 | 値 | 判定 |
|------|-----|------|
| 最終Train-Val Gap | **-0.0000** | ✓ 過学習なし |
| 5-Fold CV Mean AUC | 0.8178 ± 0.0082 | ✓ 安定 |
| Test AUC | 0.8043 | ✓ 許容範囲 |

### 結論

**Stage2 LRモデル自体に過学習は見られない**。

学習曲線は安定して収束しており、Train-Val Gapはほぼゼロ。問題は**LRモデルの過学習ではなく、証明書ルールの閾値設定**にある。

---

## 証明書ルール誤分類フィッシングの裏取り調査

### 背景

Stage2の証明書ルール（CRL等）により1,400件のフィッシングが「safe_benign」として誤分類されていた。これらの内訳を詳細に調査し、検知困難の正当性を検証した。

### 調査方法

1. ML確率による分類（高MLは証明書ルールの誤判定）
2. ドメインパターンによる分類（.edu/.co.jp等は侵害サイト）
3. 各カテゴリのサンプル確認

### 排他的カテゴリ分類結果

| カテゴリ | 件数 | 割合 | 説明 |
|---------|------|------|------|
| **証明書ルール誤判定** | 65 | 4.6% | ML>0.5だが証明書ルールで上書き |
| **機関ドメイン侵害** | 5 | 0.4% | .edu/.gov/.ac等の教育・政府機関 |
| **企業ドメイン侵害** | 32 | 2.3% | .co.jp/.co.uk等の企業ドメイン |
| **正規サイト酷似** | 736 | 52.6% | ML<0.05、ドメイン特徴が正規と同一 |
| **Stage3対象** | 562 | 40.1% | ML 0.05-0.50、判断保留領域 |

### 各カテゴリの典型例

#### 1. 証明書ルール誤判定（65件）- **修正可能**

MLが高い（フィッシング確率高）にも関わらず、証明書ルールで上書きされたケース。

```
qhcrih.cn               ML=0.938  ← 明らかにフィッシングだが誤分類
anaujizon-co-jp.com     ML=0.965  ← Amazon偽装
ver-t-amazzon.net       ML=0.830  ← Amazon偽装
us11.list-manage.com    ML=0.910  ← Mailchimp偽装
```

**対応**: CRLルールの閾値を `p1 < 0.30` から `p1 < 0.10` に厳格化することで救済可能。

#### 2. 機関ドメイン侵害（5件）- **検知困難（説明可能）**

教育機関・政府機関のドメインが一時的にフィッシングに使用されたケース。

```
svmschool.edu.bd        ML=0.307  バングラデシュの学校
mlrip.ac.in             ML=0.048  インドの教育機関
sadaohospital.go.th     ML=0.030  タイ政府の病院
tanimukai.or.jp         ML=0.031  日本の組織
```

**説明**: 正規ドメインが一時的に侵害されたパターン。ドメイン単位の検出では本質的に限界がある。

#### 3. 企業ドメイン侵害（32件）- **検知困難（説明可能）**

正規企業のドメインが一時的にフィッシングに使用されたケース。

```
komano.co.jp            ML=0.035  日本企業
retail-takasawa.co.jp   ML=0.008  日本小売業
mtech-kobe.co.jp        ML=0.116  日本企業
archdaleceramics.co.uk  ML=0.618  英国企業
```

**説明**: 企業サイトが侵害されたパターン。OV/EV証明書を持つ場合もあり、証明書ルールでは判別不能。

#### 4. 正規サイト酷似（736件）- **ML限界**

ML確率が極めて低く（<0.05）、ドメイン特徴量が正規サイトと区別不能なケース。

```
sensoriumpsychologists.com   ML=0.031  心理学関連に見える
reschiastudios.com           ML=0.023  スタジオサイトに見える
salmonriverfarm.com          ML=0.007  農場サイトに見える
choisirunrelay.com           ML=0.025  サービスサイトに見える
```

**説明**: これらのドメインはMLの特徴量（長さ、エントロピー、TLD等）が正規サイトと同一レベル。**ドメイン単位のML検出の本質的限界**を示す。

#### 5. Stage3対象（562件）- **AI Agent対応**

ML確率が中間帯（0.05-0.50）で、追加分析が必要なケース。

```
huwaifeng.cn            ML=0.056
pkobp.com               ML=0.170  ← 銀行名偽装の可能性
dniperu.online          ML=0.181
inicioraiker.site       ML=0.072
```

**対応**: Stage3 AI Agentによるコンテンツ分析・ブランド検出で判定可能。

### 最終評価サマリー

| 対応 | 件数 | 割合 | 説明 |
|------|------|------|------|
| **ルール修正で救済** | 65 | 4.6% | CRL閾値厳格化で対応 |
| **検知困難（説明可能）** | 773 | 55.2% | 侵害サイト + ML限界 |
| **Stage3で対応** | 562 | 40.1% | AI Agentで判定 |

### 結論

1. **LRモデルに過学習はない**（学習曲線で確認済み）

2. **1,400件の誤分類の内訳**:
   - 65件（4.6%）は証明書ルール修正で救済可能
   - 773件（55.2%）は検知困難だが正当な理由あり
     - 侵害サイト: 正規ドメインの一時的悪用
     - 正規酷似: MLの特徴量では識別不能
   - 562件（40.1%）はStage3 AI Agentで対応

3. **検知困難なケースは「システム欠陥」ではない**
   - 侵害サイト（37件）: 正規ドメインが攻撃者に悪用された
   - 正規酷似（736件）: ドメイン名の特徴量がMLの識別限界を超えている

4. **推奨対応**:
   - CRLルール閾値を `p1 < 0.30` → `p1 < 0.10` に厳格化
   - または証明書ルールを無効化して保守的運用

---

## 実験データ移設

### 移設内容

`artifacts/2026-01-10_140940/stage3_test/` の実験データを `docs/analysis/stage3_experiments/` に移設。

### 移設ファイル

| ファイル | 説明 |
|---------|------|
| ai_agent_sample_results.csv | ランダムサンプル評価結果 |
| ai_agent_high_risk_tld_results.csv | 高リスクTLD評価結果 |
| low_signal_*.csv | 低シグナルフィッシング分析 |
| high_signal_alive_check.csv | 高シグナル対照実験 |
| difficult_cases.csv | 分類困難ケース |

### ドキュメント更新

- `docs/analysis/stage3_experiments/README.md` - 新規作成
- `docs/analysis/README.md` - stage3_experimentsセクション追加

---

## TLDベースのフィルタリング改善

### 背景

証明書ルール（CRL等）による誤分類1,400件を救済する方法を検討。Stage3 AI Agentテストの結果、ドメイン単位では検知困難なケースが多いことが判明したため、TLD（トップレベルドメイン）の信頼性に基づくフィルタリングを検討した。

### TLD別フィッシング率分析

テストデータ128,067件のTLD別フィッシング率を分析。

#### 安全なTLD（フィッシング率 < 2%）

| TLD | 総数 | フィッシング率 | 備考 |
|-----|------|--------------|------|
| .gov | 217 | **0.00%** | 政府機関 |
| .edu | 365 | **0.27%** | 教育機関 |
| .fi | 123 | 0.00% | フィンランド |
| .ie | 150 | 0.00% | アイルランド |
| .nl | 1,082 | 0.74% | オランダ |
| .uk | 2,198 | 1.50% | イギリス |
| .de | 1,675 | 1.73% | ドイツ |
| .fr | 774 | 1.81% | フランス |
| .au | 829 | 2.05% | オーストラリア |
| .jp | - | - | 日本 |

#### 危険なTLD（フィッシング率 > 90%）

| TLD | 総数 | フィッシング率 | 備考 |
|-----|------|--------------|------|
| .mw | 196 | **99.49%** | マラウイ |
| .ci | 385 | **99.48%** | コートジボワール |
| .cfd | 892 | 98.77% | 新gTLD |
| .icu | 1,019 | 98.33% | 新gTLD |
| .cn | 12,157 | **98.23%** | 中国 |
| .buzz | 370 | 97.84% | 新gTLD |
| .dev | 1,442 | 97.16% | Google管理 |
| .xyz | 2,099 | 94.47% | 新gTLD |
| .top | 3,116 | 93.74% | 新gTLD |
| .shop | 1,775 | 93.41% | 新gTLD |

### Stage3 AI Agentテスト結果

誤分類1,400件から45件をサンプリングし、Stage3 AI Agentでテスト。

| カテゴリ | 件数 | Stage3検知率 | 解釈 |
|---------|------|-------------|------|
| A_高ML誤判定 | 10 | **100%** | ルール修正で救済可能 |
| B_機関侵害 | 5 | 0% | 正規サイトと判定（正しい） |
| C_企業侵害 | 10 | 0% | 正規サイトと判定（正しい） |
| D_正規酷似 | 10 | 0% | 正規サイトと判定 |
| E_中間ML | 10 | 0% | 正規サイトと判定 |

**発見**: 高ML誤判定（65件）はStage3で100%検知可能だが、残り773件はStage3でもBENIGN判定。これはドメイン単位検出の本質的限界を示す。

### TLDベースフィルタリング方式の比較

| アプローチ | safe_benign | FN(見逃し) | FN率 | Stage3追加 | 救済Phish |
|-----------|-------------|-----------|------|-----------|-----------|
| **現状** | 57,522 | 1,400 | 2.43% | - | - |
| **ホワイトリスト** | 12,672 | 138 | 1.09% | 44,850 | 1,262 |
| **ブラックリスト** | 56,212 | 1,210 | 2.15% | 1,310 | 190 |
| **ハイブリッド** | 39,729 | 399 | **1.00%** | 17,793 | **1,001** |

### 推奨: ハイブリッド方式

TLDを3カテゴリに分類し、それぞれ異なるルールを適用：

```python
# TLDカテゴリ定義
safe_tlds = ['gov', 'edu', 'fi', 'ie', 'tv', 'at', 'nl', 'se', 'be',
             'uk', 'de', 'fr', 'au', 'jp', 'nz', 'ca', 'ch', 'it', 'es']

dangerous_tlds = ['mw', 'ci', 'cfd', 'icu', 'cn', 'buzz', 'dev', 'pw',
                  'cyou', 'tokyo', 'xyz', 'club', 'top', 'shop', 'sbs',
                  'vip', 'asia', 'cc', 'one', 'rest', 'link', 'click']

neutral_tlds = ['com', 'net', 'org', 'info', 'biz']

# フィルタリングルール
if tld in safe_tlds:
    → safe_benign_cert適用（そのまま自動判定）
elif tld in dangerous_tlds:
    → Stage3へ送信（AI Agent判定）
elif tld in neutral_tlds:
    if ml_probability < 0.03:
        → safe_benign_cert適用（極低MLなら許容）
    else:
        → Stage3へ送信
```

### 期待効果

| 指標 | 現状 | ハイブリッド方式 | 改善 |
|------|------|----------------|------|
| FN（見逃し） | 1,400 | 399 | **-72%** |
| FN率 | 2.43% | 1.00% | **-1.43%** |
| Stage3追加 | - | 17,793 | 許容範囲 |
| 救済Phish | - | 1,001 | +1,001件 |

### 説明可能性

この方式は以下の点で説明可能：

1. **TLDの信頼性は客観的指標**: 政府機関(.gov)や教育機関(.edu)は審査が厳しく、フィッシング率が極めて低い

2. **危険TLDは統計的に明白**: .cn, .xyz, .top等は90%以上がフィッシングであり、自動BENIGNは不適切

3. **中立TLDは追加条件で判断**: .comは正規サイトもフィッシングも多いため、ML確率で追加フィルタリング

4. **残りのFN（399件）の内訳**:
   - 安全TLD内の侵害サイト（.jp, .de, .uk等の正規ドメインが一時的に悪用）
   - これらはドメイン単位では本質的に検知不可能

### 実装方針

`02_main.py` の証明書ルール部分を修正：

```python
# 現状
if cert_has_crl and p1 < 0.30:
    safe_benign_cert = True

# 改善案
if tld in safe_tlds and cert_has_crl and p1 < 0.30:
    safe_benign_cert = True
elif tld in dangerous_tlds:
    safe_benign_cert = False  # Stage3へ
elif tld in neutral_tlds and cert_has_crl and p1 < 0.03:
    safe_benign_cert = True
else:
    safe_benign_cert = False  # Stage3へ
```

### 結論（当初の見積もり）

TLDベースのフィルタリングにより、見逃しフィッシングを1,400件から399件（72%削減）に改善可能。Stage3への追加負荷は17,793件で許容範囲内。残り399件は安全TLD内の侵害サイトであり、ドメイン単位検出の本質的限界として説明可能。

---

## TLDベースフィルタリング実装結果（Scenario 7）

### 実装内容

`02_main.py`にScenario 7（TLDベースフィルタリング）を実装。Scenario 5（safe_benign）およびScenario 6（証明書ルール）の両方にTLD制限を適用。

### 危険TLDリストの拡張

FN分析の結果、以下のTLDを危険リストに追加：

| TLD | DEFERデータでのフィッシング率 | 追加理由 |
|-----|---------------------------|---------|
| .lat | **85.0%** | 高フィッシング率 |
| .gq, .ga, .tk, .ml, .cf | >99% | 無料TLD、悪用多発 |
| .online | 9.4% | FN分析で6件、既存リストと整合 |
| .site, .website | - | 悪用されやすい新gTLD |
| .me | 16.3% | FN分析で9件 |
| .pe | 22.9% | FN分析で7件 |
| .ar | 14.7% | FN分析で10件 |
| .cl | 14.8% | FN分析で7件 |

### 最終的な危険TLDリスト

```python
'stage2_tld_dangerous': [
    # 超危険（>90%）
    'mw', 'ci', 'cfd', 'icu', 'cn', 'buzz', 'dev', 'pw',
    'cyou', 'tokyo', 'xyz', 'club', 'top', 'shop', 'sbs',
    'vip', 'asia', 'cc', 'one', 'rest', 'link', 'click',
    # 高危険（>50%）
    'lat', 'gq', 'ga', 'tk', 'ml', 'cf',
    # 中危険（>15%）- FN分析から追加
    'online', 'site', 'website', 'me', 'pe', 'ar', 'cl',
]
```

### 「その他TLD」の扱い変更

当初は「その他TLD」（リストにないTLD）を安全TLDと同様に扱っていたが、FN分析の結果、以下に変更：

- **変更前**: その他TLD → 証明書ルール適用（安全TLDと同等）
- **変更後**: その他TLD → ML < 0.03の場合のみ適用（中立TLDと同等）

### 実装結果

| 指標 | TLDフィルタリング前 | TLDフィルタリング後 | 変化 |
|------|-------------------|-------------------|------|
| FN（見逃しフィッシング） | ~1,400 | **886** | **-36.7%** |
| Stage3 Handoff | 4,386 | 17,403 | +297% |
| TLDフィルタリングでブロック | - | 17,086 | - |

### TLDフィルタリング統計

```
TLD Filtering: blocked 17,086 (S5:1,026, S6:16,060)
  S5: dangerous=849, neutral(p1>=0.03)=177
  S6: dangerous=1,929, neutral=14,131
```

### FN内訳（886件）

| カテゴリ | 件数 | 説明 |
|---------|------|------|
| safe_benign_combined | 472 | 自動BENIGNと判定 |
| - 安全TLD | 116 | 侵害された正規サイト（.jp, .de, .uk等） |
| - 危険TLD | **0** | TLDフィルタリングで完全ブロック |
| - 中立/その他TLD (p1<0.03) | 356 | MLで区別不能 |
| PENDING | 414 | defer_score < tau でStage3未選択 |

### 当初見積もりとの差異

| 指標 | 当初見積もり | 実装結果 | 差異理由 |
|------|------------|---------|---------|
| FN | 399 | 886 | PENDING FN（414件）が見積もりに含まれていなかった |
| 削減率 | 72% | 37% | 同上 |

### 考察

1. **危険TLDのFNは0件達成**: TLDフィルタリングにより、危険TLD（.cn, .xyz, .top等）での自動BENIGN判定を完全にブロック

2. **残りのFNの構成**:
   - 安全TLD（116件）: .jp, .de, .uk等の正規ドメインが一時的に侵害されたケース。ドメイン単位検出の本質的限界
   - 中立/その他TLD（356件）: ML確率が極めて低く（<0.03）、特徴量でフィッシングと区別不能
   - PENDING（414件）: defer_scoreが閾値未満でStage3に選択されなかったケース

3. **Stage3負荷**: 17,403件（@8秒/件 = 約39時間）は許容範囲内だが、バッチ処理の最適化が望ましい

### 変更ファイル

| ファイル | 変更内容 |
|----------|----------|
| `02_main.py` L130-151 | TLDフィルタリング設定オプション追加 |
| `02_main.py` L805-867 | Scenario 7（TLD分類）をScenario 5の前に移動 |
| `02_main.py` L854-865 | Scenario 5にTLDフィルタリング適用 |
| `02_main.py` L910-977 | Scenario 6の各ルールにTLDフィルタリング適用 |
