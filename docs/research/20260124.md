# 研究日誌 2026-01-24

## 本日の作業

### 評価結果
- 1. 全件評価完了 (17,434件)
- 2. パイプライン全体性能サマリ

### ラベル品質調査
- 3. Stage3 FP/FN VirusTotal調査開始 (1,624件)
- 4. VT調査中間結果

### ドキュメント整備
- 5. プログラム一覧の作成
- 6. 仕様書の作成・更新

### Stage3改善分析 (午前)
- 7. Stage3 AI Agentの貢献度分析

### データクリーニングと再評価 (午後)
- 8. VT結果に基づくデータクリーニング (87件削除)
- 9. 3000件サンプル再評価 (3 Worker並列)
- 10. 再評価結果分析

### vLLM最適化・運用改善
- 11. vLLM設定最適化 (max_model_len=4096)
- 12. Worker完了時vLLM自動停止機能 (stop_on_complete)
- 13. Stage3評価ガイド作成

---

## 1. 全件評価完了 (17,434件)

### 実行結果

| 項目 | 値 |
|------|-----|
| 開始 | 2026-01-23 15:39 |
| 完了 | 2026-01-24 09:25 |
| 実行時間 | **17.64時間** |
| Worker数 | 2 (GPU 0: local, GPU 1: external) |
| 評価ドメイン数 | 17,434件 |
| エラー | **0件** |
| Worker 0 | 8,717件 |
| Worker 1 | 8,717件 |
| 平均処理時間 | 6.79秒/ドメイン |
| スループット | ~16.5 domains/min (2GPU合計) |

### Stage3混同行列

| 指標 | 値 |
|------|-----|
| TP | 2,145 |
| FP | 196 |
| TN | 13,665 |
| FN | 1,428 |
| **Precision** | **91.6%** |
| **Recall** | **60.0%** |
| **F1 Score** | **72.5%** |

### ソース別分布

| ソース | 件数 | 割合 |
|--------|------|------|
| trusted | 13,861 | 79.5% |
| jpcert | 1,578 | 9.1% |
| certificates | 1,048 | 6.0% |
| phishtank | 947 | 5.4% |

### 並列評価システムの信頼性

- **エラーゼロ**: 17,434件を完走
- **均等分散**: 各Worker 8,717件 (完全均等)
- **vLLM安定性**: 再起動なし、ヘルスチェック失敗なし
- **チェックポイント**: テスト時に動作確認済み

---

## 2. パイプライン全体性能サマリ

### 全体フロー (128,002件)

```
入力: 128,002件 (Phishing 64,001 / Benign 64,001)
         │
    ┌────┴────┐
    ▼         ▼
┌─────────────────────────────────────────────────┐
│  Stage1: XGBoost                                │
│  ・AUTO_BENIGN:   11,094件 (ML<0.002)  → 確定   │
│  ・AUTO_PHISHING: 59,989件 (ML>0.98)   → 確定   │
│  ・HANDOFF:       56,919件             → Stage2 │
│                                                 │
│  AUTOエラー: 14件 (0.02%)                        │
│  ・FP: 5件, FN: 9件                              │
└─────────────────────────────────────────────────┘
         │ (56,919件)
         ▼
┌─────────────────────────────────────────────────┐
│  Stage2: Gate/LR + 証明書ルール                 │
│  ・Safe Benign:   38,976件 (証明書安全判定)      │
│  ・DROP:          39,485件 (スコア低)            │
│  ・HANDOFF:       17,434件             → Stage3 │
│                                                 │
│  AUTOエラー: 427件 (0.39%)                       │
└─────────────────────────────────────────────────┘
         │ (17,434件)
         ▼
┌─────────────────────────────────────────────────┐
│  Stage3: AI Agent (全件評価完了)                 │
│  ・Phishing判定:   2,341件 (TP:2,145 FP:196)    │
│  ・Benign判定:    15,093件 (TN:13,665 FN:1,428) │
│                                                 │
│  Precision: 91.6%, Recall: 60.0%                │
└─────────────────────────────────────────────────┘
```

### パイプライン全体性能

| 指標 | 値 |
|------|-----|
| **Precision** | **99.68%** |
| **Recall** | **97.08%** |
| **F1 Score** | **98.36%** |

### 計算内訳

```
全パイプライン:
  TP = Stage1_AUTO_PHISHING(59,984) + Stage3_TP(2,145) = 62,129
  FP = Stage1_AUTO_FP(5) + Stage2_AUTO_FP(6) + Stage3_FP(196) = 207
  TN = Stage1_AUTO_BENIGN(11,085) + Stage2_DROP/Safe(52,658) + Stage3_TN(13,665) = 63,794*
  FN = Stage1_AUTO_FN(9) + Stage2_FN(418) + Stage3_FN(1,428) = 1,855*

  *注: 厳密な値はStage2の安全判定のTP/FP内訳による
```

### Stage別エラー寄与

| Stage | FP寄与 | FN寄与 | 備考 |
|-------|--------|--------|------|
| Stage1 AUTO | 5件 | 9件 | 極めて低エラー |
| Stage2 AUTO | 6件 | 418件 | FN主要因は証明書ルール |
| Stage3 | 196件 | 1,428件 | **FNのボトルネック** |
| **合計** | **207件** | **1,855件** | |

### 主要発見

1. **Stage3のFNが全FNの77.0%** (1,428/1,855)
2. **Stage3のRecall 60%が改善余地** - ルール/モデル改善の最大効果点
3. **Precisionは各Stageとも高い** - FP問題は小さい
4. **Stage2のFN 418件** - CRL DPルールの過剰benign判定が主因 (既知)

---

## 3. Stage3 FP/FN VirusTotal調査

### 調査概要

Stage3の全FP/FNをVirusTotalで検証し、ラベルエラーの検出とモデル実性能の評価を行う。

| 項目 | 値 |
|------|-----|
| FP対象 | 196件 (trusted→phishing誤判定) |
| FN対象 | 1,428件 (phishing→benign見逃し) |
| **合計** | **1,624件** |
| APIキー数 | 4 |
| 並列Worker | 4 |
| 推定所要時間 | ~7時間 |

### 実行コマンド

```bash
python scripts/vt_batch_investigation.py \
  --input artifacts/.../stage3_fp_fn_all_domains.csv \
  --output artifacts/.../stage3_vt_investigation_all.csv \
  --no-resume
```

### ラベルエラー判定基準

| ケース | 条件 | 意味 |
|--------|------|------|
| FP → ラベルエラー | FP かつ malicious >= 3 | 実はphishing (trusted側のラベル間違い) |
| FN → ラベルエラー | FN かつ malicious == 0 & suspicious == 0 | 実はbenign (phishing側のラベル間違い) |

---

## 4. VT調査中間結果

### 進捗 (17:00時点)

| 項目 | 値 |
|------|-----|
| 完了数 | 1,293 / 1,624 (79.6%) |
| FP完了 | 196 / 196 (**100%**) |
| FN完了 | 1,097 / 1,428 (76.8%) |
| 残り | 331件 |

### 中間分析

| カテゴリ | 対象 | ラベルエラー | 割合 |
|----------|------|-------------|------|
| FP (trusted) | 196件 | 2件 (mal>=3) | **1.0%** |
| FN (phishing) | 1,097件 | 108件 (mal=0, sus=0) | **9.8%** |

### 考察

- **FPラベルエラーが非常に少ない (1.0%)**: Stage1時のVT調査 (37.6%) と大幅に異なる
  - Stage1 FPはhigh-ML-probaドメインが多く、実際に悪性が多かった
  - Stage3 FPはStage2を通過した「微妙なケース」が多い
- **FNラベルエラーが約10%**: phishingラベルだがVTで未検出のドメイン
  - フィッシングサイトがtakedown済み、またはショートライフで消滅した可能性
  - これらを除外するとStage3 Recallは改善する見込み

### FNラベルエラー除外後の推定性能

```
FN = 1,428 - (1,428 * 0.098) ≈ 1,288  (推定)
Recall = 2,145 / (2,145 + 1,288) ≈ 62.5%  (現60.0%から+2.5pp)
```

---

## 5. プログラム一覧

`docs/program_inventory.md` を作成。全プログラム・スクリプトを体系的に整理。

### カテゴリ

| カテゴリ | プログラム数 |
|----------|-------------|
| Stage1 データ準備 | 1 |
| Stage2 ML + Gate | 1 |
| Stage3 AI Agent | 8 (コアモジュール) + 4 (ツール) |
| Stage3 評価 | 4 |
| パイプライン管理 | 3 |
| VirusTotal調査 | 2 |
| 分析・可視化 | 3 |
| データクリーニング | 6 (SQL) |
| ドキュメント | 10+ |

---

## 6. 仕様書の作成・更新

### 新規作成

| ファイル | 内容 |
|----------|------|
| `docs/specs/stage3_ai_agent_spec.md` | Stage3 AI Agent仕様 (v1.6.3) |
| `docs/specs/parallel_evaluation_spec.md` | 並列評価システム仕様 (v1.0) |
| `docs/specs/evaluate_e2e_spec.md` | E2E評価スクリプト仕様 |
| `docs/specs/vt_batch_investigation_spec.md` | VTバッチ調査仕様 |

### 更新

| ファイル | 更新内容 |
|----------|----------|
| `docs/specs/pipeline_execution_order.md` | vLLM管理ルール追加、並列評価セクション追加、処理時間目安更新 |

---

## 7. Stage3 AI Agentの貢献度分析 — 論文化の検討

### 7.1 AI Agent vs ML閾値の比較

Handoff subset (17,434件) でStage3 AI Agent と単純なML閾値 (>0.5) を比較。

| 手法 | Precision | Recall | F1 |
|------|-----------|--------|-----|
| ML > 0.5 threshold | 88.0% | 61.9% | 72.7% |
| Stage3 AI Agent | 91.6% | 60.0% | 72.5% |

**パイプライン全体 (128,002件) での比較:**

| 戦略 | Precision | Recall | F1 |
|------|-----------|--------|-----|
| Handoff→全部benign | 99.98% | 93.75% | 96.76% |
| Handoff→ML閾値(>0.5) | 99.50% | 97.20% | 98.34% |
| **Handoff→Stage3 AI Agent** | **99.67%** | **97.10%** | **98.37%** |
| Handoff→全部phishing | 82.08% | 99.33% | 89.89% |

**AI Agent vs ML閾値の差: F1 +0.03pp（実質同等）**

### 7.2 FNの構造分析

| ML確率帯 | FN数 | 全FN比 | Recall | 備考 |
|----------|------|--------|--------|------|
| < 0.1 | 591 | 41.4% | 0.7% | ほぼ検出不可 |
| 0.1-0.3 | 416 | 29.1% | ~1% | 困難 |
| 0.3-0.5 | 329 | 23.0% | 2-5% | チューニング候補 |
| 0.5-0.6 | 82 | 5.7% | 40% | 中程度 |
| 0.6+ | 10 | 0.7% | 95%+ | 問題なし |

**FNの93.6%がML < 0.5。** このゾーンでStage3は事実上機能していない。

### 7.3 根本原因: FNとTNが特徴量空間で区別不能

FN (ML<0.5) と TN の主要特徴量を比較:

| 特徴量 | FN (ML<0.5) | TN | 比率 |
|--------|-------------|-----|------|
| cert_is_free_ca | 82.3% | 82.2% | 1.00 |
| cert_validity_days | 109日 | 112日 | 0.98 |
| domain_length | 14.7 | 14.8 | 0.99 |
| entropy | 3.295 | 3.306 | 1.00 |
| TLD (.com率) | 87.5% | — | — |

**オフライン特徴量では、FNとbenignドメインの区別が原理的に不可能。**
LLMに同じ特徴量を渡してもMLと同じ結論になるのは構造的に必然。

### 7.4 LLM判定の実態

| 項目 | FN (1,428件) | TP (2,145件) |
|------|-------------|-------------|
| ai_risk_level = low | 1,369 (95.9%) | 0 (0%) |
| ai_risk_level = medium | 59 (4.1%) | 0 (0%) |
| ai_risk_level = high | 0 | 872 (40.7%) |
| ai_risk_level = critical | 0 | 1,268 (59.1%) |
| ai_confidence (mean) | 0.81 | — |

LLMはFN全件を「low/medium risk」と自信を持って判定。Phase6ルールも発火せず。

### 7.5 オンラインシグナル追加の検討

#### WHOIS登録日の可能性

| 条件 | 評価 |
|------|------|
| 不変メタデータか | ○ (creation_dateは変わらない) |
| 過去データで取得可能か | △ (drop済みドメインは取得不可) |

**実測結果 (FNドメイン5件):**

| ドメイン | WHOIS結果 |
|----------|-----------|
| rozaweb.com | Not Found (消滅) |
| bkmufg.com | creation=2024-08-26 ✓ |
| axemaul.com | Not Found (消滅) |
| hazotech.com | Not Found (消滅) |
| egyfreeze.com | creation=2020-11-17 ✓ |

**取得成功率: 約40%。** フィッシングドメインの多くがdrop済みのため、既存データセットでのWHOIS後付け評価は困難。

### 7.6 結論と論文化への課題

#### 現状の問題

1. **AI Agentの貢献がF1 +0.03pp** → 論文主要貢献として弱い
2. **同じオフライン特徴量ではMLを超えられない** → 構造的限界
3. **WHOIS後付けは60%がdrop済み** → 既存データセットとの整合性なし
4. **Stage1/2のみの論文は既出** → 新規性不足

#### 方向性の選択肢

| 方針 | 利点 | 課題 |
|------|------|------|
| A. 新規リアルタイムデータセット構築 | オンラインシグナルが使える | 128Kデータとの整合性、データ収集期間 |
| B. データセット設計から変更 (収集時にWHOIS取得) | 完全なデータ | 既存データ破棄、再収集コスト |
| C. SOC分析者支援 (説明生成) として論文化 | 実用的価値 | 定量評価が難しい |
| D. ゲーティング研究 (いつLLMに委ねるべきか) | ML+LLM融合の知見 | Stage3単体の貢献は示せない |

---

## 本日の成果まとめ

### パイプライン性能確定

| 指標 | 値 | 備考 |
|------|-----|------|
| Precision | **99.68%** | 全128,002件 |
| Recall | **97.08%** | 全128,002件 |
| F1 Score | **98.36%** | 全128,002件 |
| Stage3 Precision | 91.6% | 17,434件 |
| Stage3 Recall | 60.0% | 17,434件 |

### 並列評価システム

- **17,434件を17.64時間で完走** (2GPU, エラーゼロ)
- チェックポイント/リジューム機能動作確認済み
- 3GPUで~11時間の見込み

### ラベル品質調査

- Stage3 FP/FN 全1,624件のVT調査進行中 (79.6%完了)
- FPラベルエラー率: 1.0% (Stage1の37.6%と対照的)
- FNラベルエラー率: ~10% (ラベル修正でRecall +2.5pp見込み)

### ドキュメント

- プログラム一覧作成
- 仕様書4件新規作成 + 1件更新

---

## 8. データクリーニング (VT結果に基づく)

### 概要

VT調査結果に基づき、ラベルエラーと判定された87ドメインをDBから削除。

| カテゴリ | 件数 | 判定基準 |
|----------|------|----------|
| FN→ラベルエラー (実はbenign) | 69件 | harmless>=60 & malicious=0 |
| FP→ラベルエラー (実はphishing) | 18件 | malicious>0 |
| **合計** | **87件** | |

### 削除テーブル内訳

| テーブル | FN削除 | FP削除 | 合計 |
|----------|--------|--------|------|
| jpcert | 36件 | - | 36件 |
| certificates | 11件 | - | 11件 |
| phishtank_entries | 2件 | - | 2件 |
| trusted_certificates | - | 18件 | 18件 |
| **合計** | **49件** (追加分) + 20件 (先行分) | **18件** | **87件** |

### 削除前後の性能シミュレーション

| シナリオ | Precision | Recall | F1 | ΔF1 |
|----------|-----------|--------|-----|-----|
| 削除前 (現状) | 91.6% | 60.0% | 72.5% | - |
| FN 69件削除 | 91.6% | 61.2% | 73.6% | +1.1pp |
| FP 18件削除 | 92.4% | 60.0% | 72.7% | +0.2pp |
| **両方削除** | **92.4%** | **61.2%** | **73.9%** | **+1.4pp** |

---

## 9. 3000件サンプル再評価 (3 Worker)

### 実行情報

| 項目 | 値 |
|------|-----|
| サンプル数 | 3,000件 |
| Worker数 | 3 (GPU 0, 1, 2) |
| Worker 0 | Port 8000, RTX 5000 (local, 共用) |
| Worker 1 | Port 8001, RTX 3080 (external, 個人) |
| Worker 2 | Port 8002, RTX 4000 (external/SSH, 共用) |
| 実行時間 | 約2.85時間 |
| エラー | 0件 |

### 実行中の問題と修正

| 問題 | 原因 | 修正 |
|------|------|------|
| Worker 1台しか動かない | `get_active_workers()` がWorker 0のみ返す | `--add-gpu 1,2` フラグ使用 |
| FileNotFoundError (checkpoint) | Worker子プロセスで相対パスが無効 | `.resolve()` で絶対パス化 |
| Worker 0のvLLMが死ぬ | pkillで評価プロセス殺すとvLLMも死ぬ | 再起動後に再実行 |

---

## 10. 再評価結果

### Handoff Subset (3000件, データクリーニング後)

| 指標 | Stage1 | Stage3 (Final) | 差分 |
|------|--------|----------------|------|
| Precision | 89.52% | 92.13% | **+2.61pp** |
| Recall | 63.96% | 62.09% | -1.87pp |
| **F1** | **74.61%** | **74.18%** | **-0.43pp** |

### 前回評価 (クリーニング前) との比較

| 指標 | 前回 Stage1 F1 | 今回 Stage1 F1 | 改善 |
|------|---------------|---------------|------|
| F1 | 72.66% | 74.61% | **+1.95pp** |

| 指標 | 前回 Stage3 F1 | 今回 Stage3 F1 | 改善 |
|------|---------------|---------------|------|
| F1 | 72.54% | 74.18% | **+1.64pp** |

### 考察

- **データクリーニングの効果**: 両Stage とも +1.6~1.9pp のF1改善
- **Stage3 vs Stage1**: Stage3はPrecision +2.61ppだがRecall -1.87pp、F1は-0.43pp
- **Stage3の優位性は未だ不明確**: Precision改善は見られるが、F1でStage1に届かない
- **12件のTP損失**: Stage3がphishing→benignに誤フリップする問題が残存

---

## 11. vLLM設定最適化

### 背景

Worker 1 (RTX 3080, max_model_len=4096) がエラー0件で完走したことから、4096トークンで十分と確認。
全Worker統一により KVキャッシュ効率向上・GPUメモリ消費削減を実現。

### 変更内容

| Worker | 変更項目 | 変更前 | 変更後 |
|--------|----------|--------|--------|
| Worker 0 (RTX 5000) | max_model_len | 16384 | **4096** |
| Worker 0 (RTX 5000) | gpu_memory_utilization | 0.50 | **0.25** |
| Worker 2 (RTX 4000) | MAX_MODEL_LEN | 8192 | **4096** |

### 推論結果への影響

- max_model_len はKVキャッシュの最大長を制御するだけ
- 入力が4096トークン以内なら推論結果は完全に同一
- 実測で最大入力は ~2000トークン → 4096で十分余裕あり

---

## 12. Worker完了時vLLM自動停止 (stop_on_complete)

### 背景

共用GPUサーバ (Worker 0: RTX 5000, Worker 2: RTX 4000) では、Worker完了後すぐにvLLMを停止して
GPUメモリを解放する必要がある。個人GPU (Worker 1: RTX 3080) は停止不要。

### 実装

| ファイル | 変更内容 |
|----------|----------|
| `scripts/parallel/config.py` | `WorkerConfig` に `stop_on_complete: bool = True` 追加 |
| `scripts/parallel/vllm_manager.py` | `VLLMCluster.stop_by_port()` メソッド追加 |
| `scripts/parallel/orchestrator.py` | `_wait_for_workers()` で完了時に `stop_by_port()` 呼び出し |
| `scripts/parallel_config.yaml` | Worker 1 に `stop_on_complete: false` 設定 |

### 動作

```
Worker 完了検出
  ↓
worker_config.stop_on_complete == True?
  ↓ Yes
vllm_cluster.stop_by_port(worker.port)
  ↓
GPU メモリ解放
```

---

## 13. Stage3評価ガイド

`docs/stage3_evaluation_guide.md` を作成。次回の評価実行時に参照するドキュメント。

### 内容

- vLLM起動手順 (Worker 0, 1, 2)
- 並列評価の実行コマンド
- 進捗モニタリング方法
- 結果確認・分析手順
- トラブルシューティング

---

## 本日の成果まとめ

### データクリーニング

- VT調査に基づき **87ドメイン** (69 FN + 18 FP) のラベルエラーを削除
- クリーニング効果: F1 +1.6~1.9pp

### 再評価結果 (3000件, 3 Worker)

| 指標 | Stage1 | Stage3 |
|------|--------|--------|
| Precision | 89.52% | **92.13%** |
| Recall | **63.96%** | 62.09% |
| F1 | **74.61%** | 74.18% |

- Stage3はPrecision優位 (+2.61pp) だが、F1ではStage1に及ばず (-0.43pp)
- AI Agentの定量的優位性は依然として示せていない

### vLLM最適化

- 全Worker を max_model_len=4096 に統一
- Worker 0 のメモリ使用を 50%→25% に削減
- 推論結果に影響なし

### 運用改善

- `stop_on_complete` 機能で共用GPUのWorker完了時自動停止
- Stage3評価ガイドのドキュメント化

---

## 次のステップ

### 短期 (Stage3性能改善)
1. [ ] 新しいvLLM設定 (max_model_len=4096) での全件再評価
2. [ ] Worker速度別のドメイン割当数調整 (RTX5000 > RTX4000 > RTX3080)
3. [ ] Stage3 FP/FN分析: 12件のTPフリップ (phishing→benign) の原因調査

### 中期 (知識ベース拡充)
4. [ ] Tranco Top 100K によるFP削減
5. [ ] brand_keywords 拡張 (214→500+)
6. [ ] 多言語ソーシャルエンジニアリングキーワード
7. [ ] ランダム文字列検出強化

### 中長期 (論文方針決定)
8. [ ] **論文の方向性を決定する** ← 最重要
   - 現状: Stage3 AI Agentの貢献がF1 +0.03pp → -0.43pp (データクリーニング後も不明確)
   - 選択肢A: リアルタイムデータセット構築 + オンラインシグナル
   - 選択肢B: データ収集設計から変更 (WHOIS/DNS同時取得)
   - 選択肢C: 説明可能性・SOC支援の論点に切替
   - 選択肢D: ゲーティング研究 (ML→LLM委譲の最適化)
9. [ ] 方針決定後の実装計画策定
