# 研究日誌 2026-01-18

## 本日の作業

### AI Agent Phase6 アーキテクチャ調査とFP根本原因分析

Stage3 AI Agent の性能問題（F1 -3.51%）の根本原因を調査した。

---

## Phase6 決定フローの詳細分析

### アーキテクチャ全体像

`llm_final_decision.py` を詳細に分析し、Phase6の完全な決定フローを特定した。

```
LLM判定 (is_phishing)
    ↓
_apply_policy_adjustments()
    ├── brand × cert rules（ブランド×証明書）
    ├── contextual threshold (HARD_CTX >= 0.65, SOFT_CTX >= 0.50)
    ├── R1-R6 policy rules（ポリシールール）
    ├── Over-mitigation guard (ml >= 0.50)
    ├── POST_LLM_FLIP_GATE  ← FP削減ゲート
    └── POST_RANDOM_PATTERN_ONLY_GATE
    ↓
_apply_benign_cert_gate()  ← PHISH→BENIGNの可能性（B1-B4）
    ↓
_apply_low_signal_phishing_gate()  ← BENIGN→PHISHの可能性（P1-P3）★問題箇所
```

### POST_LLM_FLIP_GATE の仕様

TLD危険度に応じた閾値でLLMのPHISH判定をブロック:

| TLD危険度 | 閾値 | 動作 |
|-----------|------|------|
| 高危険 (tk, ml, ga等) | 0.0 | ゲート無効化 |
| 中危険 (top, shop, xyz等) | 0.04 | ほぼ無効 |
| 非危険 (.com, .org等) | 0.30 | ML<0.30でブロック |

### P1ゲート（low_signal_phishing_gate）の仕様

```python
# Gate P1: ブランド検出 + 短期証明書（90日以下） + 低ML（<0.30）
if (
    brand_detected           # ブランドが検出された
    and valid_days <= 90     # 短期証明書（Let's Encrypt等）
    and ml < 0.30            # MLスコアが低い
    and not has_strong_benign  # OV/EV/CRL証明書でない
):
    is_phishing = True  # PHISHに強制！
```

---

## 3000件評価データセット分析

### 基本統計

| 項目 | 値 |
|------|-----|
| 総サンプル数 | 3,000 |
| 実際のフィッシング (y_true=1) | 809 |
| 実際の正規 (y_true=0) | 2,191 |

### Stage1 vs AI Agent 比較

| 指標 | Stage1 | AI Agent | 差分 |
|------|--------|----------|------|
| TP | 569 | 670 | +101 |
| FP | 47 | 276 | +229 |
| TN | 2,144 | 1,915 | -229 |
| FN | 240 | 139 | -101 |
| Precision | 92.4% | 70.8% | -21.6% |
| Recall | 70.3% | 82.8% | +12.5% |
| **F1** | **79.9%** | **76.4%** | **-3.51%** |

**結論:** AI Agent は Recall を改善するが、Precision の大幅な低下により総合性能（F1）が悪化。

---

## FP根本原因の特定

### FPのTLD分布

| TLD分類 | 件数 | 割合 |
|---------|------|------|
| 非危険TLD | 233 | 84% |
| 中危険TLD | 37 | 13% |
| 高危険TLD | 6 | 2% |

### POST_LLM_FLIP_GATE シミュレーション

```
非危険TLD + ML<0.30 (ブロックされるべき): 142件
→ 実際にはブロックされていない！
→ P1ゲート等で再度PHISHに上書きされている
```

### 短期証明書との相関

| 項目 | 件数 | 割合 |
|------|------|------|
| FP全体で短期証明書（≤90日） | 257 | 93.1% |
| ブロックされるべき＋短期証明書 | 134 | - |

**発見:** FPの93%が短期証明書を持つ。Let's Encrypt（90日証明書）が一般的になり、正規サイトも多数該当している。

### P1ゲート条件への該当

| 条件 | 件数 |
|------|------|
| 短期証明書 + ML<0.30 | 165 |
| 短期証明書 + ML<0.30 + 低SAN | 147 |

---

## 問題の構造

```
決定フロー:

1. LLM → "PHISH"
2. POST_LLM_FLIP_GATE (ML<0.30, 非危険TLD) → "BENIGN" に変更
3. P1ゲート (brand + 短期証明書 + ML<0.30) → "PHISH" に再上書き ★問題

結果: POST_LLM_FLIP_GATE の効果がP1ゲートで打ち消される
```

### 具体例: chicagobears.com（NFLシカゴ・ベアーズ公式サイト）

| 項目 | 値 |
|------|-----|
| ML | 0.171 |
| y_true | 0 (BENIGN) |
| agent_pred | True (PHISH) ★誤検知 |
| cert_validity_days | 89 |
| cert_san_count | 80 |

公式サイトがLet's Encrypt（89日証明書）を使用しているため、P1ゲートが誤発火。

---

## FPサンプル（ML < 0.30の非危険TLD）

150件が該当:

| ドメイン | ML | 証明書日数 | SAN数 |
|----------|-----|-----------|-------|
| nxflcp.com | 0.225 | 90 | 2 |
| 8degreethemes.com | 0.215 | 89 | 2 |
| mindsdb.com | 0.200 | 90 | 1 |
| chicagobears.com | 0.171 | 89 | 80 |
| wenshushu.cn | 0.072 | 90 | 2 |
| commercialappeal.com | 0.264 | 89 | 7 |
| retail-insider.com | 0.242 | 89 | 2 |
| lapcatsoftware.com | 0.265 | 89 | 77 |

---

## 改善策シミュレーション

### コスト分析 (FN=3.0, FP=1.0)

| シナリオ | FP | FN | コスト | 差分 |
|----------|-----|-----|--------|------|
| 現状 | 276 | 139 | 693 | - |
| P1を非危険TLDで無効化 | 134 | 139 | 551 | -142 |

### 改善オプション

| オプション | 内容 | FP削減見込み |
|------------|------|--------------|
| A | P1ゲートを非危険TLDで無効化 | -142件 |
| B | P1のML閾値を0.15に引き下げ | -7件 |
| C | P1を POST_LLM_FLIP_GATE の後に適用しない | -142件 |

---

## vLLM トークン制限問題

### 発生したエラー

```
LengthFinishReasonError: Could not parse response content as the length limit was reached
completion_tokens=6881, prompt_tokens=1311, total_tokens=8192
```

### 原因

- vLLM設定: `max-model-len=8192`
- Qwen3のthinkingモード（`<think>...</think>`）が長い推論を生成
- 総トークン数が上限に到達

### 対処

`scripts/vllm.sh` を修正:

```bash
# 変更履歴:
#   - 2026-01-18: max-model-len を 8192 → 16384 に変更（Qwen3 thinking mode対応）
nohup vllm serve "$MODEL" \
    --dtype auto \
    --max-model-len 16384 \  # 8192 → 16384
    ...
```

---

## ゲート構成シミュレーション結果

`05_pipeline_analysis.ipynb` でゲート構成の比較シミュレーションを実行。

| 構成 | TP | FP | TN | FN | Precision | Recall | F1 | Cost |
|------|-----|-----|------|-----|-----------|--------|------|------|
| Stage1 Only | 569 | 47 | 2,144 | 240 | 0.924 | 0.703 | 0.799 | 767 |
| AI Agent (current) | 670 | 276 | 1,915 | 139 | 0.708 | 0.828 | 0.764 | 693 |
| **P1 disabled (nd+ML<0.30)** | **644** | **134** | **2,057** | **165** | **0.828** | **0.796** | **0.812** | **629** |
| P1 disabled (nd+ML<0.30+short) | 647 | 142 | 2,049 | 162 | 0.820 | 0.800 | 0.810 | 628 |

**最適構成**: P1 disabled (non-danger TLD + ML<0.30)
- F1: 0.812（+4.8%改善）
- Cost: 629（-64削減）

### TP損失分析

P1無効化により損失するTP（26件）:

| ドメイン | ML | 証明書日数 | 備考 |
|----------|-----|-----------|------|
| coinbase-mywallet.com | 0.277 | 90 | Coinbase偽装 |
| crnetfilx-info.com | 0.160 | 90 | Netflix偽装 |
| cryptoindex-x.com | 0.235 | 90 | 暗号通貨偽装 |
| apple-device-confirm.com | 0.180 | 89 | Apple偽装 |

これらは明確な偽装ドメインだが、MLスコアが低く非危険TLDのためP1でのみ検出されていた。

---

## P1ゲートの修正実施

### 修正内容

`llm_final_decision.py` を以下のように修正:

```python
# 2026-01-18 修正: 非危険TLD + ML<0.30 の場合はP1をスキップ
# - 理由: POST_LLM_FLIP_GATEと整合性を確保し、FPを142件削減
# - Let's Encrypt（90日証明書）は正規サイトでも広く使用されている
p1_skip_for_non_danger_tld = is_non_danger_tld and ml < 0.30

if p1_skip_for_non_danger_tld:
    tr.append({
        "rule": "LOW_SIGNAL_PHISHING_GATE_P1_SKIPPED",
        "reason": "non_danger_tld_low_ml",
        ...
    })
elif (
    brand_detected
    and valid_days <= 90
    and ml < 0.30
    and not has_strong_benign
):
    gate_fired = "P1_BRAND_SHORT_CERT"
    ...
```

### バージョン更新

`PHASE6_POLICY_VERSION = "v1.6.2-p1-tld-gate"`

---

## 次のステップ

1. **修正後の評価実行**
   - 3000件データセットで再評価
   - F1: 0.764 → 0.812（+4.8%）を確認

2. **TP損失の対策検討**
   - 損失する26件のTPに対する代替検出手段
   - ドメイン類似度検出の強化（例: coinbase-mywallet → coinbase）

3. **ブランド検出の精度向上**
   - P1が「brand_detected」に依存しているため、ブランド検出の誤発火も調査が必要

---

## 本日の成果まとめ

### 発見

1. **FPの根本原因はP1ゲート（low_signal_phishing_gate）**
   - POST_LLM_FLIP_GATE でブロックしても、P1が再上書き
   - 142件のFPがこのパターン

2. **Let's Encrypt（90日証明書）の普及が問題を悪化**
   - FPの93%が短期証明書
   - 正規サイトも広くLet's Encryptを使用

3. **Phase6の決定フロー順序が問題**
   - POST_LLM_FLIP_GATE → P1 の順序で、ゲートの効果が打ち消される

### 実施した修正

**P1ゲートを非危険TLD + ML<0.30 で無効化** (`v1.6.2-p1-tld-gate`)

- 期待効果: FP 134件削減、F1 +6.05%改善
- トレードオフ: TP 23件損失（偽装ドメイン検出の一部を見逃す）

### 評価結果（シミュレーション）

| 指標 | 修正前 | 修正後 | 差分 |
|------|--------|--------|------|
| F1 | 0.7635 | 0.8098 | **+6.05%** |
| Precision | 0.708 | 0.820 | +11.2% |
| Recall | 0.828 | 0.800 | -2.8% |
| FP | 276 | 142 | **-134** |
| TP | 670 | 647 | -23 |

### 評価進行中確認（実際のLLM実行）

修正後の評価で以下の動作変更を確認:
- `7starsdata.com`: PHISH → BENIGN（TP損失、想定通り）
- `nxflcp.com`: PHISH → BENIGN（FP削減成功）
- `8degreethemes.com`: PHISH → BENIGN（FP削減成功）

---

## Extra FP 深掘り分析

### Extra FP の定義

「Extra FP」= Stage1が正しくBENIGNと判定したにもかかわらず、AI AgentがPHISHと誤判定したケース

### 分析結果

| 項目 | 件数 |
|------|------|
| Stage1 FP | 47 |
| AI Agent 総FP | 276 |
| **Extra FP（AI Agentが追加）** | **231** |

AI Agent は Stage1 の判断を覆して **231件の誤検知** を発生させていた。

### Extra FP の TLD 分布

| TLD分類 | 件数 | 割合 |
|---------|------|------|
| 非危険TLD | 194 | 84.0% |
| 中危険TLD | 31 | 13.4% |
| 高危険TLD | 6 | 2.6% |

### 複合ゲート戦略の検証

| 戦略 | 内容 | FP削減 | TP損失 | F1 | F1変化 |
|------|------|--------|--------|------|--------|
| S1 | 非危険TLD + ML<0.30 | 142 | 26 | 0.8116 | +0.0481 |
| S2 | 非危険TLD + ML<0.35 | 158 | 38 | 0.8108 | +0.0472 |
| **S7** | **S1 + 危険TLD + ML<0.15** | **169** | **42** | **0.8135** | **+0.0500** |

### S7 戦略の詳細

**S7 = 2段階ゲート**:
1. 非危険TLD かつ ML < 0.30 → PHISH判定をブロック
2. 中/高危険TLD かつ ML < 0.15 → PHISH判定をブロック

**S7 の追加ゲートがブロックするFP（27件）**:
- `100bahis.icu` (ML=0.028) - ギャンブルサイト
- `wtf55.icu` (ML=0.024) - ギャンブルサイト
- `vardenafil.click` (ML=0.041) - 医薬品スパム
- `pussy888.pw` (ML=0.061) - ギャンブル/アダルト

これらはフィッシングではないが悪質なサイト。MLスコアが非常に低いにもかかわらず、LLMが過剰に危険と判断していた。

### 最終性能比較

| システム | TP | FP | FN | F1 | Cost |
|----------|-----|-----|-----|------|------|
| Stage1のみ | 569 | 47 | 240 | 0.7986 | 767 |
| AI Agent（現状） | 670 | 276 | 139 | 0.7635 | 693 |
| **AI Agent + S7** | **628** | **107** | **181** | **0.8135** | **650** |

**S7 の効果**:
- F1: +5.0%（0.7635 → 0.8135）
- Cost: -117（Stage1比較）
- Stage1を超える性能を達成

---

## FP/FN 許容性評価

### 数値（S7適用後）

| 指標 | 件数 | 母数 | 割合 |
|------|------|------|------|
| FP（誤検知） | 107 | 2,191（正規サイト） | 4.9% |
| FN（見逃し） | 181 | 809（フィッシング） | 22.4% |

### 評価

**FP 4.9%: 許容範囲内**
- ユーザー体験への影響はあるが運用可能
- 業界標準では5%以下が一般的な目標

**FN 22.4%: 許容できない**
- 5件中1件以上のフィッシングを見逃している
- セキュリティシステムとして致命的
- 業界標準では10%以下、理想的には5%以下

### 課題

現在のアプローチは **FP削減に偏りすぎている**。

- FPを107まで減らすために、FNを181まで増やしている
- コスト関数（FN=3.0, FP=1.0）では「許容」されるが、実運用では危険

### 次のアクション

**FN率を10%以下（約80件以下）に抑える必要がある。**

→ FN分析を実施し、見逃しパターンを特定する。

---

## FN（見逃し）深掘り分析

### FNのカテゴリ分類

| カテゴリ | 件数 | 説明 |
|----------|------|------|
| Category A | 132 | Stage1もAgentも検出不可（根本的に困難） |
| Category B | 7 | Stage1は検出、Agentが見逃し（Agent退行） |
| Category C | 108 | Stage1は見逃し、Agentが検出（Agent改善） |

**現状のFN = 139件 = Category A (132) + Category B (7)**

### Category A の詳細分析（132件）

Stage1もAI Agentも検出できない「根本的に困難なケース」。

#### TLD分布

| TLD分類 | 件数 | 割合 |
|---------|------|------|
| 非危険TLD (.com等) | 120 | 90.9% |
| 中危険TLD | 11 | 8.3% |
| 高危険TLD | 1 | 0.8% |

#### ML確率分布

| ML範囲 | 件数 | 割合 |
|--------|------|------|
| 0.00-0.05 | 54 | 40.9% |
| 0.05-0.10 | 50 | 37.9% |
| 0.10-0.15 | 20 | 15.2% |
| 0.15-0.20 | 1 | 0.8% |
| 0.20-0.30 | 3 | 2.3% |
| 0.30-0.50 | 4 | 3.0% |

**78.8%がML < 0.10** — XGBoostが強く「安全」と判定している。

#### サンプルドメイン

| ドメイン | ML | 備考 |
|----------|-----|------|
| `amaznoeom.com` | 0.136 | Amazon typosquat |
| `jibunbank.pro` | 0.126 | 日本の銀行偽装 |
| `web-telegram.cc` | 0.012 | Telegram偽装 |
| `verifypage.my.id` | 0.345 | フィッシング汎用 |
| `fifelaw.co.uk` | 0.408 | 高MLだが見逃し |

#### Category A 全132件リスト

| ドメイン | ML確率 | TLD分類 | 証明書日数 |
|----------|--------|---------|------------|
| aifulbizd.sbs | 0.458 | medium_danger | 89 |
| fifelaw.co.uk | 0.408 | non_danger | 365 |
| ucc.leroymerlin.kz | 0.395 | non_danger | 89 |
| verifypage.my.id | 0.345 | non_danger | 89 |
| redirectpost-auz.vip | 0.269 | non_danger | 365 |
| kvuronekocyavmaito.me | 0.207 | non_danger | 89 |
| almiras.kz | 0.202 | non_danger | 89 |
| lfa388.co | 0.176 | non_danger | 89 |
| e-eisin.com | 0.138 | non_danger | 89 |
| renouv-imp.com | 0.136 | non_danger | 89 |
| amaznoeom.com | 0.136 | non_danger | 365 |
| pandrataxes.com | 0.128 | non_danger | 89 |
| pb-logis.com | 0.128 | non_danger | 89 |
| lckgw.com | 0.128 | non_danger | 89 |
| jibunbank.pro | 0.126 | non_danger | 89 |
| ashleytevatia.com | 0.126 | non_danger | 90 |
| zihi-seikotsuin.com | 0.123 | non_danger | 89 |
| taranz.com | 0.122 | non_danger | 89 |
| tclle.com | 0.122 | non_danger | 89 |
| huohuodai.com | 0.120 | non_danger | 89 |
| pointrelais-locker.com | 0.116 | non_danger | 89 |
| camarasciervo.com.mx | 0.116 | non_danger | 89 |
| nextworlder.com | 0.116 | non_danger | 89 |
| gzdelicnc.com | 0.106 | non_danger | 89 |
| spacedoing.com | 0.106 | non_danger | 90 |
| mybulldozer.com | 0.103 | non_danger | 89 |
| tlpdirect.com | 0.102 | non_danger | 89 |
| oklvld.pl.ua | 0.101 | non_danger | 89 |
| seppo-coffee.com | 0.099 | non_danger | 89 |
| cropsmall.com | 0.095 | non_danger | 90 |
| leaders-cleaning.com | 0.095 | non_danger | 89 |
| oladapoogunjobi.com | 0.094 | non_danger | 89 |
| aceder-particular.com | 0.094 | non_danger | 89 |
| autoservis-sindrak.com | 0.094 | non_danger | 89 |
| mecano-normand.com | 0.093 | non_danger | 89 |
| tsskpk.com | 0.091 | non_danger | 89 |
| jtqfk.com | 0.091 | non_danger | 90 |
| airdogsdrop.one | 0.090 | non_danger | 89 |
| montaznekuce-banjaluka.com | 0.089 | non_danger | 89 |
| ski-bbt.com | 0.089 | non_danger | 89 |
| itsssl.com | 0.088 | non_danger | 89 |
| americaexpre.com | 0.087 | non_danger | 365 |
| quniu365.com | 0.084 | non_danger | 89 |
| funky-music.com | 0.083 | non_danger | 89 |
| zoom-howto.com | 0.082 | non_danger | 89 |
| mito-sogyoyushi.com | 0.082 | non_danger | 89 |
| formaeconforto.com.br | 0.080 | non_danger | 89 |
| cardscc.com | 0.078 | non_danger | 89 |
| huidongxin.com | 0.077 | non_danger | 89 |
| mon-creneau.com | 0.077 | non_danger | 89 |
| nagata-k.net | 0.076 | non_danger | 89 |
| mi-ll.com | 0.075 | non_danger | 89 |
| banghexep.com | 0.074 | non_danger | 89 |
| industriasclaudette.com | 0.072 | non_danger | 89 |
| chauffeurz.com | 0.071 | non_danger | 90 |
| jazmin-services.com | 0.070 | non_danger | 89 |
| dsp2-checkpoint.com | 0.069 | non_danger | 89 |
| valemota.com.br | 0.069 | non_danger | 89 |
| sulejidian.com | 0.068 | non_danger | 89 |
| calendariodediversidad.com | 0.067 | non_danger | 89 |
| sonapta.sn | 0.067 | non_danger | 90 |
| fitnat.com.br | 0.067 | non_danger | 89 |
| connectweebly.com | 0.064 | non_danger | 90 |
| climary.cl | 0.063 | non_danger | 89 |
| hengrungongju.com | 0.063 | non_danger | 89 |
| blogclaudiooliveira.com | 0.063 | non_danger | 89 |
| ourgreenpalace.com | 0.063 | non_danger | 89 |
| juliamoss.com.br | 0.063 | non_danger | 89 |
| bin.st | 0.062 | non_danger | 89 |
| my.visme.co | 0.060 | non_danger | 89 |
| vivido-office.ro | 0.060 | non_danger | 89 |
| maurosantos.adv.br | 0.059 | non_danger | 89 |
| pejuangbaik.com | 0.057 | non_danger | 89 |
| gujuantong.com | 0.055 | non_danger | 89 |
| doudouxizi.com | 0.055 | non_danger | 89 |
| junkunoo.com | 0.053 | non_danger | 365 |
| previnenet.com.br | 0.051 | non_danger | 89 |
| kotaroproduction.com | 0.051 | non_danger | 89 |
| senatgold.space | 0.050 | non_danger | 89 |
| headwaytek.com | 0.050 | non_danger | 89 |
| shinzou.love | 0.050 | non_danger | 89 |
| riouruguaysrl.com | 0.049 | non_danger | 89 |
| furohoon.com | 0.048 | non_danger | 89 |
| yagimama.com | 0.048 | non_danger | 89 |
| serveaucards.com | 0.046 | non_danger | 89 |
| goutezlaqualite.com | 0.045 | non_danger | 89 |
| abogadoscelaya.com | 0.045 | non_danger | 89 |
| ujimasters.com | 0.044 | non_danger | 365 |
| postdeatheducation.com | 0.043 | non_danger | 89 |
| jrailpas.com | 0.043 | non_danger | 89 |
| gjilan.al | 0.041 | non_danger | 89 |
| ferncrest.com | 0.041 | non_danger | 89 |
| tagomori.biz | 0.041 | non_danger | 89 |
| exgeomin.com | 0.041 | non_danger | 89 |
| tolocha.com | 0.040 | non_danger | 89 |
| kemoproretail.com | 0.040 | non_danger | 89 |
| rabikikaku.com | 0.040 | non_danger | 89 |
| carhebty.com | 0.040 | non_danger | 89 |
| nanomeda.com | 0.040 | non_danger | 89 |
| che-post.club | 0.038 | non_danger | 90 |
| empcme.com | 0.038 | non_danger | 89 |
| g-jp.top | 0.038 | medium_danger | 89 |
| cenkaskalli.com.tr | 0.036 | non_danger | 89 |
| metrr.ru | 0.035 | non_danger | 89 |
| short.bid | 0.035 | non_danger | 89 |
| safhenegar.com | 0.035 | non_danger | 89 |
| huangjiagj.com | 0.034 | non_danger | 89 |
| wangtuixj.com | 0.034 | non_danger | 89 |
| orderofthewarrior.com | 0.033 | non_danger | 89 |
| sumup.ricas.eu | 0.033 | non_danger | 89 |
| ramdays.com | 0.033 | non_danger | 89 |
| shinningweb.com | 0.033 | non_danger | 89 |
| finedropmultilub.com | 0.033 | non_danger | 89 |
| corporatevideographychicago.net | 0.033 | non_danger | 365 |
| lookatmynewphotos.com | 0.033 | non_danger | 89 |
| zfragancias.com | 0.032 | non_danger | 89 |
| zerolimitart.com | 0.032 | non_danger | 89 |
| 1doi.com | 0.032 | non_danger | 89 |
| ciarafitzgerald.com | 0.032 | non_danger | 89 |
| buscat.cat | 0.032 | non_danger | 89 |
| whiteningled.com | 0.031 | non_danger | 89 |
| sascogulf.com | 0.031 | non_danger | 89 |
| food4medxb.com | 0.031 | non_danger | 89 |
| desarq.net | 0.031 | non_danger | 89 |
| samssportshop.com | 0.031 | non_danger | 89 |
| multichainapp.network | 0.031 | non_danger | 89 |
| visaprocessings.com | 0.031 | non_danger | 89 |
| aouxy.cn | 0.024 | non_danger | 90 |
| inbook.cc | 0.023 | non_danger | 89 |
| yamzaklink.xyz | 0.016 | medium_danger | 90 |
| web-telegram.cc | 0.012 | non_danger | 90 |
| jwaveyj.top | 0.010 | medium_danger | 90 |

**特徴**:
- 90.9%（120/132件）が非危険TLD
- 78.8%（104/132件）がML < 0.10
- 多くが正規サイトのように見える短いドメイン名

### S7ゲートが新たにブロックするフィッシング（42件）

S7適用によりFNが139件→181件に増加（+42件）。

#### ブランド偽装検出による救済分析

| 分類 | 件数 | 対応 |
|------|------|------|
| ブランド偽装あり | 5 | S7バイパスで救済可能 |
| ブランド偽装なし | 37 | S7ブロックを許容 |

**ブランド偽装で救済すべきドメイン**:
- `crnetfilx-info.com` (ML=0.199) - Netflix偽装
- `coinbase-mywallet.com` (ML=0.218) - Coinbase偽装
- `uhaul-pos.net` (ML=0.223) - U-Haul偽装
- `lixunfb.com` (ML=0.292) - Facebook偽装
- `onlinetolling-nzta.com` (ML=0.296) - NZTA偽装

### 改良版戦略: S7 + Brand Bypass

| システム | TP | FP | FN | F1 | FN率 |
|----------|-----|-----|-----|------|------|
| Current Agent | 670 | 276 | 139 | 0.7635 | 17.2% |
| S7 | 628 | 107 | 181 | 0.8135 | 22.4% |
| **S7 + Brand Bypass** | **633** | **108** | **176** | **0.8168** | **21.8%** |
| Stage1 Only | 569 | 47 | 240 | 0.7986 | 29.7% |

**S7 + Brand Bypass**: ブランド偽装検出時はS7ゲートをバイパス

---

## 10%目標達成の限界分析

### 目標

- 総フィッシング: 809件
- 目標FN率: 10%以下
- 目標FN: **80件以下**

### 現状

- 最良戦略（S7 + Brand Bypass）: FN = 176件（21.8%）
- 目標達成に必要な追加検出: **96件**

### FN内訳

| タイプ | 件数 | 救済可能性 |
|--------|------|-----------|
| Type 1: Stage1もAgentも検出不可 | 132 | ゲート調整では不可能 |
| Type 2: S7ゲートでブロック | 37 | ゲート緩和で一部可能 |

### 結論

**現在のアーキテクチャでは10%目標達成は不可能**

理由:
1. 132件のフィッシングはStage1 (XGBoost) が ML < 0.10 と判定
2. これらはAI Agentに渡される前にフィルタリングされる
3. ゲート調整だけでは救済不可能

### 必要な改善

1. **XGBoostモデルの再学習**
   - 現在見逃しているフィッシングパターンを学習データに追加
   - 特徴量エンジニアリングの見直し

2. **新しい特徴量の追加**
   - ドメイン類似度スコア（typosquatting検出）
   - ブランドキーワードマッチング強化
   - コンテンツベースの特徴量

3. **アーキテクチャの見直し**
   - ML < 0.10 でもAI Agentに渡すパスの検討
   - 多段階判定の導入

---

## 本日の最終まとめ

### 実施した分析

1. **Extra FP分析**: AI Agentが231件の不要なFPを追加していることを特定
2. **S7戦略の発見**: 2段階ゲートでF1を5%改善（0.7635→0.8135）
3. **FN分析**: 132件の検出困難ケースを特定、10%目標達成の限界を明確化

### 現状の性能（S7 + Brand Bypass）

| 指標 | 値 | 目標 | 評価 |
|------|-----|------|------|
| F1 | 0.8168 | 0.90+ | △ 改善必要 |
| FP率 | 4.9% | <5% | ◎ 達成 |
| FN率 | 21.8% | <10% | × 未達成 |

### 論文化に向けた課題

1. **FN率の改善が必須**（21.8% → 10%以下）
2. **XGBoostモデルの再学習が必要**
3. **ブランド偽装検出の強化**

---

## Stage3（AI Agent）FN分析

### Stage3設計書との照合

`docs/research/03_phishing_agent_overview.md` を現在の実装（`v1.6.2-p1-tld-gate`）に合わせて更新した。

**追加した内容**:
1. TLD危険度分類（HIGH_DANGER_TLDS, MEDIUM_DANGER_TLDS）
2. POST_LLM_FLIP_GATEのTLD依存閾値
3. Benign Certificate Gates (B1-B4)
4. Low Signal Phishing Gates (P1-P3)
5. FN分析結果とFN改善ロードマップ

### 132件FNの見逃しパターン分類

| カテゴリ | 件数 | 割合 | Stage3で救済可能か |
|----------|------|------|-------------------|
| A1: ブランド偽装 | 14 | 10.6% | **可能** |
| A2: 危険TLD見逃し | 8 | 6.1% | **可能** |
| A3: ML不可視 | 88 | 66.7% | 不可能（XGBoost再学習必要） |
| A4: 弱シグナル | 22 | 16.7% | 一部可能（コンテンツ分析） |

### A1: ブランド偽装の救済候補

Stage3のbrand_impersonation_check強化で検出可能:

| ドメイン | 検出すべきブランド | ML確率 |
|----------|-------------------|--------|
| amaznoeom.com | Amazon（タイポスクワット） | 0.136 |
| americaexpre.com | American Express（タイポ） | 0.087 |
| jibunbank.pro | じぶん銀行（サブストリング） | 0.126 |
| web-telegram.cc | Telegram（サブストリング） | 0.012 |
| zoom-howto.com | Zoom（サブストリング） | 0.082 |
| aifulbizd.sbs | アイフル（サブストリング） | 0.458 |

### A2: 危険TLD見逃しの原因

| ドメイン | TLD | ML確率 | 見逃し原因 |
|----------|-----|--------|-----------|
| g-jp.top | .top（中危険） | 0.038 | ML < 0.04（中危険閾値）でゲートブロック |
| jwaveyj.top | .top | 0.010 | 同上 |
| yamzaklink.xyz | .xyz（中危険） | 0.016 | 同上 |
| inbook.cc | .cc（中危険） | 0.023 | 同上 |

**改善案**: 中危険TLDで短期証明書+低SANの場合は閾値を緩和

### Stage3改善の優先順位

| 優先度 | 施策 | 救済見込み | 難易度 |
|--------|------|-----------|--------|
| **1** | ブランドサブストリング検出強化 | +14件 | 低 |
| **2** | 中危険TLD複合条件追加 | +8件 | 低 |
| 3 | XGBoost特徴量追加・再学習 | +88件（理論上） | 高 |
| 4 | コンテンツ分析ツール追加 | +22件（一部） | 中 |

**短期目標**: 優先度1+2で22件救済 → FN率 22.4% → 19.7%

### 次のアクション

1. `brand_impersonation_check.py` の改善
   - タイポスクワッティング検出の精度向上（編集距離2まで拡張）
   - 日本語ブランドDBの拡充（じぶん銀行、アイフル等）
   - サブストリングマッチングの追加（telegram, zoom等）

2. `llm_final_decision.py` の改善
   - 中危険TLD + 短期証明書 + 低SAN の複合条件追加
   - P1ゲートの条件見直し（ブランド偽装検出時はTLD関係なく発火）
