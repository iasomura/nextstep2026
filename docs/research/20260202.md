# 研究日誌 2026-02-02

## 本日の作業

### Stage2 FP/FN 特徴分析
- 1. Stage2フィルタの精度評価
- 2. Stage2 FN（フィッシング見逃し）の特徴分析
- 3. 改善可能性の判定
- 4. 新パイプライン実行・評価（RUN_ID: 2026-02-01_230749）

---

## 1. パイプライン実行結果

### RUN_ID: 2026-02-01_230749

| ステージ | 入力 | 出力 | 備考 |
|---------|------|------|------|
| Stage1 (XGBoost) | 127,548 | 127,548 | 全件分類 |
| Stage2 (Gate/Rules) | 127,548 | 14,859 | 37,176件フィルタ |
| Stage3 (AI Agent) | 14,859 | - | 評価中 |

### Stage2フィルタ精度

| 指標 | 値 |
|------|-----|
| フィルタ対象 | 37,176件 |
| True Negative | 36,752件 |
| False Negative | 424件 |
| **フィルタ精度** | **98.86%** |

---

## 2. Stage2 FN 分析（424件）

### 2.1 FNの内訳（フィルタ理由別）

| フィルタ理由 | 件数 | 割合 |
|------------|------|------|
| CRL + 低ML (< 0.15) | 361件 | 85.1% |
| CRL のみ | 20件 | 4.7% |
| 低ML (< 0.15) のみ | 11件 | 2.6% |
| その他 | 32件 | 7.5% |

### 2.2 ML確率別の分布

| ML確率範囲 | 件数 | 割合 | 判定 |
|-----------|------|------|------|
| < 0.05 | 377件 | 88.9% | **受容すべき**（MLモデル限界） |
| 0.05 - 0.15 | 18件 | 4.2% | 要検討 |
| >= 0.15 | 29件 | 6.8% | **改善可能** |

### 2.3 改善可能な29件の詳細分析

ML >= 0.15 のFN 29件について追加分析：

| 特徴 | 件数 | 改善方法 |
|-----|------|---------|
| 危険TLD (.cfd) + 高ML | 5件 | TLDフィルタルール追加 |
| ブランド偽装 + 高ML | 8件 | ブランド×ML複合ルール |
| 高ML (>= 0.30) + 他シグナル | 16件 | 閾値調整検討 |

### 2.4 危険TLD (.cfd) + 高MLの具体例

| ドメイン | ML | フィルタ理由 | 改善方法 |
|---------|-----|-------------|---------|
| *.cfd (5件) | 0.20-0.45 | CRL存在 | TLD例外ルール |

---

## 3. 結論と推奨事項

### 3.1 受容すべきFN（377件, 88.9%）

ML < 0.05 のドメインは**Stage1のXGBoostモデルの検出限界**であり、Stage2での救済は困難。

**理由**:
- MLモデルがフィッシングの特徴を検出できていない
- CRL存在などの「正当性指標」が高い
- Stage2でこれらを通過させると、大量のFPが発生するリスク

### 3.2 改善可能なFN（29件, 6.8%）

以下のルール追加で救済可能：

| ルール | 期待効果 | 優先度 |
|-------|---------|--------|
| 危険TLD (.cfd) + ML >= 0.15 → Stage3へ | FN -5件 | 中 |
| ブランド偽装 + ML >= 0.15 → Stage3へ | FN -8件 | 低 |

### 3.3 Stage2フィルタの評価

| 観点 | 評価 |
|-----|------|
| 精度 | **98.86%** - 非常に高い |
| FN率 | **1.14%** - 許容範囲 |
| 改善余地 | 限定的（最大29件救済可能） |

**結論**: Stage2フィルタは高精度で動作しており、大幅な改善の必要性は低い。

---

## 4. Stage3評価（進行中）

### 評価設定
- **サンプル数**: ALL（14,859件）
- **GPU**: 3台並列 (Port 8000, 8001, 8002)
- **開始時刻**: 2026-02-01 23:26

### 中間進捗（2026-02-02 07:14時点）

| Worker | 担当件数 | 完了 | 失敗 | 進捗率 |
|--------|---------|------|------|--------|
| Worker 0 | 5,419 | 1,932 | 0 | 35.7% |
| Worker 1 | 6,032 | 3,497 | 0 | 58.0% |
| Worker 2 | 3,408 | 1,760 | 24 | 51.6% |
| **合計** | 14,859 | 7,189 | 24 | **48.4%** |

### タイムアウトドメイン（Worker 2: 24件）

主にネットワーク遅延や複雑なHTML解析が原因と推測。
評価完了後にリトライ予定。

---

## 5. 今後のタスク

### 優先度高

| # | 項目 | 期待効果 | 状態 |
|---|------|---------|------|
| **14** | **LLM特徴量抽出 - FN候補2000件処理** | **FN救済500件以上** | **新規** |
| 19 | Stage2: 危険TLD (.cfd) + ML >= 0.15 ルール | FN -5件 | 新規 |
| 18 | fuzzy/fuzzy2 ブランドマッチ閾値調整 | FP -107件 | 継続 |

### 優先度低（検討中）

| # | 項目 | 期待効果 | 備考 |
|---|------|---------|------|
| 20 | Stage2: ブランド偽装 + ML >= 0.15 ルール | FN -8件 | 実装複雑 |
| 10 | ルールモジュールの単体テスト追加 | 保守性向上 | pending |
| 9 | インラインコードの完全削除検討 | コード整理 | pending |

### 完了済み（本日）

- ✅ 新パイプライン実行（RUN_ID: 2026-02-01_230749）
- ✅ Stage2 FN 特徴分析
- ✅ 改善可能性の判定
- ✅ LLM特徴量抽出スクリプト作成 (`scripts/llm_domain_features.py`)

---

## 6. Stage2 FN 深掘り分析 (DGA + 高ML問題)

### 6.1 仮説検証

**初期仮説**: Stage1 MLモデルはDGAを検出しているが、Stage2 CRLフィルタが誤判定

**検証結果**: **仮説は部分的に正しいが、主因は異なる**

### 6.2 発見: OV/EVルールの設計問題

| ルール | ML閾値 | 影響件数 | 問題 |
|-------|--------|---------|------|
| CRL Rule | < 0.30 | 0件 | **問題なし** (高MLには適用されない) |
| **OV/EV Rule** | **なし** | **15件** | **主因！MLに関係なくbenign判定** |
| Wildcard Rule | - | 1件 | 危険TLDでブロック済み |
| Long Validity | < 0.25 | 0件 | 問題なし |

### 6.3 高ML FN (>= 0.50) の証明書分析

| Domain | ML | Org | 発行者 | 問題 |
|--------|-----|-----|--------|------|
| tianhuashengrui.com | 0.974 | ✓ | Cloudflare | OV/EV誤判定 |
| avigufsjvufhvxvv.com | 0.968 | ✓ | Cloudflare | OV/EV誤判定 |
| aunanzon-co-jpsjf.com | 0.965 | ✓ | Cloudflare | Amazon偽装 |
| amazon-user-center.net | 0.921 | ✓ | Cloudflare | Amazon偽装 |
| asdfghjjhggsf.moe | 0.887 | ✓ | Cloudflare | キーボードパターン |

### 6.4 根本原因

```python
# 02_main.py line 1065-1077 (OV/EV Rule)
if cfg.get('stage2_cert_benign_ov_ev_enabled', False):
    has_org = X_defer[:, IDX_HAS_ORG] > 0.5
    ov_ev_mask = has_org.copy()  # ← ML閾値がない！
    ...
    safe_benign_cert |= ov_ev_mask
```

**問題**:
- Cloudflare CDN証明書は `has_organization=True` (Cloudflare, Inc.)
- 攻撃者がCloudflare経由でサイトを公開すると、OV/EV相当の証明書を自動取得
- ML >= 0.97 でも「OV/EV証明書だから正規」とフィルタされる

### 6.5 結論

| 観点 | 結論 |
|-----|------|
| DGA検出 | Stage1 MLモデルは正しく検出（ML 0.8-0.97） |
| フィルタ問題 | **OV/EVルールのML閾値欠如**が主因（CRLではない） |
| 影響件数 | 高ML FN 19件中 15件（79%） |

### 6.6 推奨修正

**#21 修正版**: Stage2 OV/EVルールにML閾値追加

```python
# 修正案
if cfg.get('stage2_cert_benign_ov_ev_enabled', False):
    ov_ev_p1_max = float(cfg.get('stage2_cert_benign_ov_ev_p1_max', 0.50))  # 新規閾値
    has_org = X_defer[:, IDX_HAS_ORG] > 0.5
    ov_ev_mask = has_org & (p1_defer < ov_ev_p1_max)  # ML閾値を追加
```

---

---

## 7. #21 実装完了

### 変更内容

**ファイル**: `02_main.py`

**変更1: 設定パラメータ追加 (line 133)**
```python
'stage2_cert_benign_ov_ev_p1_max': 0.50,  # OV/EVルールのp1閾値 (#21: 2026-02-02追加)
```

**変更2: OV/EVルールにML閾値追加 (line 1070-1074)**
```python
if cfg.get('stage2_cert_benign_ov_ev_enabled', False):
    ov_ev_p1_max = float(cfg.get('stage2_cert_benign_ov_ev_p1_max', 0.50))
    has_org = X_defer[:, IDX_HAS_ORG] > 0.5
    # ML閾値を適用: ML < ov_ev_p1_max の場合のみbenign判定
    ov_ev_mask = has_org & (p1_defer < ov_ev_p1_max)
```

### 期待効果

| 指標 | 変化 |
|-----|------|
| FN救済 | 16件 |
| FPリスク | 最大1件 |
| Net効果 | **FN -16, FP +0~1** |

### 次のステップ

- パイプライン再実行 (`python 02_main.py --run`) で効果確認
- Stage3評価で最終検証

---

---

## 8. LLM特徴量抽出機能の開発

### 8.1 背景と目的

Stage1 MLモデルには**検出限界**がある:
- FN候補（ML < 0.10 & phishing）の中には、数値特徴量では捉えられない「意味的な特徴」を持つドメインが存在
- 例: `amazones.xyz` (ML=0.01) → Amazon模倣だが、MLは検出できない

**解決策**: LLMを使って意味的特徴（ブランド模倣、不自然さ）を抽出

### 8.2 開発したスクリプト

**ファイル**: `scripts/llm_domain_features.py`

```python
# Pydanticスキーマ（Structured Output）
class DomainFeatures(BaseModel):
    domain: str
    typo_analysis: TypoAnalysis      # ブランド模倣検出
    legitimacy_analysis: LegitimacyAnalysis  # 正当性スコア
    dga_analysis: DGAAnalysis        # DGA検出
    impersonation_target: Optional[str]  # 模倣対象
    risk_score: float                # 総合リスク (0-1)
```

### 8.3 テスト結果

| ドメイン | ML確率 | LLM risk_score | ブランド検出 |
|---------|--------|----------------|-------------|
| amazones.xyz | 0.01 | 0.90 | ✓ Amazon |
| kucronetkoyamato.top | 0.02 | 0.95 | ✓ クロネコヤマト |
| talents-tokyo.jp | - | 0.30 | ✗ なし |

**成果**: MLが見落とすブランド模倣をLLMで検出可能

### 8.4 実装完了（2026-02-03）

#### Stage3インフラ共有方式の採用

初回実装（llm_domain_features.py）でvLLMが不安定だったため、Stage3の安定したインフラを共有する方式に変更。

**作成したファイル**:
- `scripts/llm_screening.py` - エントリポイント
- `scripts/parallel/screening_worker.py` - ScreeningWorker
- `scripts/parallel/screening_schema.py` - Pydanticスキーマ

#### 検出率比較分析

| アプローチ | 検出率 | 備考 |
|-----------|--------|------|
| Stage3直接送信 | 17% (16/94) | ツール＋LLM |
| LLMスクリーニング | 38% (5/13) | ドメイン名のみ |

**結論**: LLMスクリーニングで高リスク候補を事前フィルタリングし、Stage3に送信するハイブリッド方式を採用。

#### 実装状況

| ステップ | 内容 | 状態 |
|---------|------|------|
| 1 | FN候補抽出（ML < 0.10 & phishing）→ 757件 | ✅ 完了 |
| 2 | Stage3インフラ共有設計 | ✅ 完了 |
| 3 | ScreeningWorker実装 (with_structured_output) | ✅ 完了 |
| 4 | llm_screening.py実装 | ✅ 完了 |
| 5 | 全757件のスクリーニング実行 | 進行中 |
| 6 | Stage3救済リスト生成・効果検証 | 未着手 |

---

## 変更履歴

- 2026-02-03: **LLMスクリーニング実装完了** - Stage3インフラ共有方式採用、ScreeningWorker/screening_schema.py作成
- 2026-02-02: **LLM特徴量抽出機能開発** - scripts/llm_domain_features.py作成、Pydantic Structured Output使用
- 2026-02-02: **#21実装完了** - OV/EVルールにML閾値(0.50)追加、FN-16件の救済見込み
- 2026-02-02: Stage2 FN分析完了、改善タスク定義
- 2026-02-02: DGA/高ML問題の根本原因特定 (OV/EVルールのML閾値欠如)
