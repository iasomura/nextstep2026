# フィッシング検出AIエージェント（Stage3）仕様書

## 1. はじめに

本ドキュメントでは、3段階フィッシング検出パイプラインの第3段階（Stage3）を担う「phishing_agent」モジュールについて説明する。Stage3は、Stage1（XGBoost）とStage2（Logistic Regression）では判断が困難なケースに対して、LLM（大規模言語モデル）を活用した詳細分析を行うコンポーネントである。

### 1.1 Stage3の役割

Stage1とStage2は、SSL証明書情報とドメイン名の統計的特徴に基づいて高速に判定を行う。しかし、以下のようなケースでは判断が困難となる：

- ドメイン名が短く、ブランド名を含まないが、実際にはフィッシングサイトである
- 証明書情報は正常だが、TLDが危険度の高いものである
- 機械学習モデルは「安全」と判断したが、複数の弱いシグナルが重なっている

Stage3のAIエージェントは、これらの「グレーゾーン」のケースに対して、複数の専門ツールとLLMの推論能力を組み合わせることで、より精度の高い判定を実現する。

### 1.2 処理コストとトレードオフ

Stage3の処理には約8秒/件のコストがかかる。これは、Stage1の数ミリ秒と比較して大幅に長い。そのため、Stage2が「詳細調査が必要」と判断したケース（Handoff）のみがStage3に送られる。この設計により、精度と処理効率のバランスを取っている。

---

## 2. システムアーキテクチャ

### 2.1 モジュール構成

phishing_agentは、以下の6つの主要モジュールで構成される：

```
phishing_agent/
├── __init__.py              # 公開API（エントリーポイント）
├── agent_foundations.py     # Phase1: 基本型定義、例外処理
├── precheck_module.py       # Phase2: 事前チェック（Step0）
├── tools_module.py          # Phase3: ツールラッパー
├── langgraph_module.py      # Phase4: LangGraph状態機械
├── llm_final_decision.py    # Phase6: 最終判定ポリシー
└── tools/                   # 専門分析ツール群
    ├── brand_impersonation_check.py
    ├── certificate_analysis.py
    ├── short_domain_analysis.py
    ├── contextual_risk_assessment.py
    └── legitimate_domains.py
```

各フェーズは独立して開発・テストが可能であり、フォールバック機構により一部が失敗しても全体の処理は継続される。

### 2.2 処理フロー

エージェントの処理は、以下の7つのノードから成るLangGraphグラフとして実装されている：

```
┌─────────────────────────────────────────────────────────────────┐
│  1. precheck（事前チェック）                                    │
│     ・ドメイン、TLD、ブランド検出の簡易分析                     │
│     ・ML Paradox（後述）の検出                                  │
│     ・推奨ツールの決定                                          │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  2. tool_selection（ツール選択）                                │
│     ・LLMによる最適なツールの選択                               │
│     ・失敗時は全3ツールを使用（フォールバック）                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  3. fanout_dispatcher（実行フラグ設定）                         │
│     ・選択されたツールの実行フラグをセット                      │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  4. tool_execution（ツール実行）                                │
│     ・brand_impersonation_check: ブランド偽装検出               │
│     ・certificate_analysis: 証明書分析                          │
│     ・short_domain_analysis: ドメイン構造分析                   │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  5. aggregate（集約・ルーティング）                             │
│     ・2つ以上のツールが実行された場合 → contextual_checkへ      │
│     ・ML確率が低い場合は1ツールでも → contextual_checkへ        │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  6. contextual_check（統合リスク評価）                          │
│     ・全ツール結果の統合                                        │
│     ・ML Paradox検出と補正                                      │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  7. final_decision（最終判定）                                  │
│     ・Phase6ポリシールール（R1〜R6）の適用                      │
│     ・ゲート処理による誤検知防止                                │
│     ・最終的なis_phishing判定                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 専門分析ツール

### 3.1 ブランド偽装検出（brand_impersonation_check）

このツールは、ドメイン名が有名ブランドを偽装していないかを検出する。

**検出手法**：
1. **完全一致検出**: ドメイン名をハイフンで分割し、各トークンがブランドキーワードと完全一致するかを確認
2. **タイポスクワッティング検出**: 編集距離1以内の類似文字列を検出（例：「gooogle」「amaz0n」）
3. **正規表現マッチング**: 単語境界を考慮したパターンマッチング

**誤検知防止**：
- 「pineapple」に「apple」が含まれるような部分一致は検出しない（トークン分割による）
- 3文字以下の短いブランドキーワードは誤検知が多いため除外
- 公式ドメインのホワイトリストに含まれるサイトはスキップ

**リスクスコア計算**：
- ブランド検出 + 無料CA + 組織情報なし → 高リスク（0.7〜0.9）
- ブランド検出 + 危険TLD → 高リスク（0.6〜0.8）
- ブランド検出のみ → 中リスク（0.4〜0.6）

### 3.2 証明書分析（certificate_analysis）

SSL/TLS証明書の特徴を分析し、フィッシングサイトに典型的なパターンを検出する。

**分析項目**：
- **発行者（Issuer）**: Let's Encrypt、ZeroSSL、Cloudflareなどの無料CAかどうか
- **組織情報（Organization）**: DV証明書（ドメイン認証のみ）は組織情報を含まない
- **自己署名**: ブラウザで警告が出る自己署名証明書
- **ワイルドカード**: *.example.com形式の証明書
- **SAN数**: 多数のドメインを含む証明書

**重要な考え方**：
無料CA（Let's Encrypt等）を使用していること自体は、フィッシングの証拠にはならない。多くの正規サイトも無料CAを利用している。しかし、無料CA + 組織情報なし + 他のリスク要因（短いドメイン、危険TLD等）が重なった場合は、フィッシングの可能性が高まる。

**リスクスコア計算**：
- 自己署名 → 0.40（+ ブランド検出時ボーナス）
- 無料CA + 組織情報なし + 他の問題 → 0.30
- 無料CAのみ → 0.15（軽微）

### 3.3 ドメイン構造分析（short_domain_analysis）

ドメイン名の構造的特徴を分析する。

**分析項目**：
- **ドメイン長**: 3文字以下は「非常に短い」、6文字以下は「短い」
- **TLDカテゴリ**: 危険（.top, .icu, .cn等）、正規（.com, .org等）、中立
- **エントロピー**: 文字の無秩序さ（ランダム文字列の検出）
- **ランダムパターン**: 母音率0.2未満、数字率0.5以上など
- **サブドメイン深度**: 深いサブドメイン構造の検出

**エントロピーについて**：
シャノンエントロピーは、文字列の「ランダムさ」を測定する指標である。通常の英単語は3.0〜3.5程度だが、ランダム文字列（例：「xk7f9p2m」）は4.0以上になる。フィッシングサイトは自動生成されたランダムドメインを使用することが多いため、高エントロピーは警告シグナルとなる。

**リスクスコア計算**：
```
score = 0.0
if 非常に短い: score += 0.30
elif 短い: score += 0.10
if 危険TLD: score += 0.25
if 高エントロピー: score += 0.20
if 非常に高エントロピー: score += 0.05（追加）
score += TLD統計重み（0.0〜0.30）
score += サブドメイン深度ボーナス（0.0〜0.20）
```

### 3.4 統合リスク評価（contextual_risk_assessment）

全ツールの結果を統合し、ML Paradoxを検出する中核的なツールである。

**ML Paradoxとは**：
「ML Paradox（機械学習のパラドックス）」とは、以下の矛盾状態を指す：
- Stage1（XGBoost）: ml_probability < 0.3 →「安全」と判定
- 非MLシグナル: 危険TLD、ブランド偽装、異常な証明書 → 複数の警告

機械学習モデルは統計的特徴のみを見るため、「証明書もドメイン長も正常だが、.icuドメインでamazonを偽装している」ようなケースを見逃すことがある。統合リスク評価は、このような矛盾を検出し、適切に補正する。

**スコア集約**：
```python
baseline = 0.45 * ml_score + 0.35 * max(brand, cert, domain)

if ML_Paradox検出:
    baseline = max(baseline, PARADOX_BASE)  # 0.60〜0.80

if 複数リスク要因:
    baseline += 0.12

if 高リスクワード検出:
    baseline += min(0.28, 0.12 + 0.04 * count)

if 既知の正規ドメイン:
    baseline -= 軽減値（0.04〜0.08）
```

---

## 4. Phase6ポリシールール

### 4.1 ルールの目的

Phase6ポリシーは、LLMの判定結果に対して最終的な調整を行う。主な目的は以下の2つ：

1. **FN（偽陰性）の救済**: MLが「安全」と判断したが、複数のシグナルから見て危険なケースを検出
2. **FP（偽陽性）の防止**: LLMが過度に「フィッシング」と判断するケースを抑制

### 4.2 救済ルール（R1〜R6）

これらのルールは、MLが見逃したフィッシングを検出する。

| ルール | 条件 | 目的 |
|--------|------|------|
| **R1** | ml < 0.20 + 無料CA&組織なし + ctx ≥ 0.28〜0.34 + 強いエビデンス | 非常に低いML確率でも、複数シグナルがある場合を救済 |
| **R2** | ml < 0.30 + 組織なし + (無料CA or 短い) + ctx ≥ 0.34 + 強いエビデンス | 証明書とドメインの組み合わせによる救済 |
| **R3** | ml < 0.40 + 短い + 組織なし + ctx ≥ 0.36 + 強いエビデンス | 短いドメイン + DV証明書のパラドックス |
| **R4** | ml < 0.50 + 無料CA&組織なし + ctx ≥ 0.33〜0.35 + 強いエビデンス | 中程度のML確率（30〜50%）の救済 |
| **R5** | ml < 0.50 + 危険TLD + 組織なし + ctx ≥ 0.33 | 危険TLD + DV証明書のパラドックス |
| **R6** | ml < 0.30 + 危険TLD + 無料CA&組織なし + ctx ≥ 0.35 | ML Paradox + 危険TLD + DVの組み合わせ |

**「強いエビデンス」とは**：
以下のいずれかが検出されている場合を指す：
- 危険TLD（.top, .icu, .cn, .cc等）
- IDNホモグラフ（視覚的に紛らわしい文字）
- 高エントロピー + コンボフラグ
- 自己署名証明書
- ML Paradox検出
- ブランド検出

**「強いエビデンス」に含まれないもの**：
- 無料CA単独
- 組織情報なし単独
- ランダムパターン単独

これは、正規サイトでも無料CAを使用し、組織情報を含まないことが一般的であるため。これらは他のシグナルと組み合わせた場合にのみ意味を持つ。

### 4.3 ゲート（誤検知防止）

これらのゲートは、ルールの過剰発火を防ぐ。

| ゲート | 条件 | 動作 | 目的 |
|--------|------|------|------|
| **LOW_ML_GUARD** | ml < 0.25 + DV証明書のみ + 危険TLDなし + ブランドなし | R1/R2/R4をスキップ | 低ML + DVのみの正規サイトを保護 |
| **POST_LLM_FLIP_GATE** | LLMがフィッシング判定 + ml < 0.25 + 非危険TLD | is_phishing=False | LLMの過剰フリップを防止 |
| **POST_RANDOM_ONLY_GATE** | フィッシング判定 + domain_issues={random_pattern}のみ + ブランドなし | is_phishing=False | ランダムパターンのみによる誤検知を防止 |
| **legit_tld_guard** | 正規TLD + 通常/長いドメイン | R1/R4の閾値を上げる | .com/.orgサイトの過剰検出を防止 |

### 4.4 ルール発火の例

**例1: ML Paradox + 危険TLDのケース**
```
ドメイン: amazon-login.top
ml_probability: 0.18（Stage1は「安全」と判定）
検出シグナル:
  - 危険TLD（.top）
  - ブランド検出（amazon）
  - 無料CA + 組織なし

→ R5発火: is_phishing = True
理由: ml < 0.50 + 危険TLD + 組織なし + ctx ≥ 0.33
```

**例2: LOW_ML_GUARDによる保護**
```
ドメイン: myportfolio.com
ml_probability: 0.12
検出シグナル:
  - 無料CA（Let's Encrypt）
  - 組織なし

→ LOW_ML_GUARD発動: R1/R2/R4をスキップ
→ is_phishing = False
理由: ml < 0.25 + DV証明書のみ + 危険TLDなし + ブランドなし
```

---

## 5. 外部データ連携

### 5.1 Stage1/Stage2からの入力

Stage3は以下のデータをStage1/Stage2から受け取る：

| データ | 説明 | 用途 |
|--------|------|------|
| ml_probability | Stage1のXGBoost出力（0.0〜1.0） | ベースラインリスク、ML Paradox判定 |
| cert_full_info_map | 証明書の詳細情報（発行者、組織、有効期間等） | 証明書分析ツール |
| brand_keywords | ブランドキーワードリスト | ブランド偽装検出 |
| dangerous_tlds | 危険TLDリスト（.top, .icu, .cn等） | TLD分類、ルール発火条件 |
| legitimate_tlds | 正規TLDリスト（.com, .org等） | ゲート条件 |
| phishing_tld_stats | TLD別フィッシング頻度 | TLD統計重み計算 |
| high_risk_words | 高リスクワード（login, secure等） | 追加リスク加算 |

### 5.2 アーティファクトの読み込み

これらのデータは、Stage1/Stage2の学習時に生成されたアーティファクト（pklファイル、JSONファイル）から読み込まれる。run_idを指定することで、特定の学習結果に対応するアーティファクトが自動的に解決される。

```python
# 使用例
agent = make_phase4_agent_with_05(
    run_id="2026-01-10_140940",
    base_dir="/data/hdd/asomura/nextstep",
    strict_mode=False,
    config_path="config.json"
)
result = agent.evaluate("suspicious-domain.top", ml_probability=0.25)
```

---

## 6. 出力形式

### 6.1 基本出力

```python
{
    "domain": "example.top",
    "ml_probability": 0.25,
    "ai_is_phishing": True,
    "ai_confidence": 0.85,
    "ai_risk_level": "high",
    "detected_brands": ["example"],
    "risk_factors": [
        "dangerous_tld",
        "brand_detected",
        "free_ca",
        "no_org",
        "policy:R5"
    ],
    "tools_used": ["brand", "cert", "domain", "contextual_risk_assessment"],
    "success": True
}
```

### 6.2 トレース情報（デバッグ・分析用）

```python
{
    # Phase6ポリシートレース
    "phase6_policy_version": "v1.4.8-mlparadox-tld",
    "phase6_rules_fired": ["R5"],
    "phase6_gate_blocked": False,

    # ツール別スコア
    "trace_brand_risk_score": 0.65,
    "trace_cert_risk_score": 0.30,
    "trace_domain_risk_score": 0.45,
    "trace_ctx_risk_score": 0.72,
    "trace_ctx_is_ml_paradox": True,

    # 詳細情報
    "trace_cert_issuer": "Let's Encrypt",
    "trace_domain_entropy": 3.2,
    "trace_domain_tld_category": "dangerous"
}
```

これらのトレース情報は、CSV出力との互換性を考慮してフラットな構造になっている。詳細な分析やデバッグ時に、どのツールがどのような判断をしたかを追跡できる。

---

## 7. フォールバック戦略

### 7.1 エラー耐性設計

phishing_agentは、LLM呼び出しやツール実行の失敗に対して堅牢に設計されている。

| エラー発生箇所 | フォールバック動作 |
|---------------|-------------------|
| ツール実行エラー | 中立的な結果を返す（処理継続） |
| ツール選択（SO）エラー | 全3ツールを使用 |
| 最終判定（SO）エラー | ツールスコアの加重平均で判定 |
| Precheckエラー | 空のヒント、全ツール推奨 |
| グラフ全体エラー | 安全側の判定（is_phishing=False） |

### 7.2 strict_mode

テスト時には`strict_mode=True`を設定することで、エラー発生時に即座に例外を投げる動作に切り替えられる。本番運用時は`strict_mode=False`（デフォルト）で、フォールバックを有効にする。

---

## 8. 設計上の考慮事項

### 8.1 偽陽性（FP）削減の重視

本システムでは、特に偽陽性の削減に注力している。これは以下の理由による：

1. 正規サイトをフィッシングと誤判定すると、ユーザーの信頼を損なう
2. Let's Encrypt等の無料CAは正規サイトでも広く使われている
3. ランダムに見えるドメイン名でも正規サービス（例：cryptpad.org）は存在する

そのため、以下の設計方針を採用している：
- 無料CA単独ではフィッシング判定しない
- ランダムパターン単独ではフィッシング判定しない（ブランド検出が必要）
- 低ML確率（< 0.25）のサイトはLLMの過剰フリップから保護

### 8.2 監査可能性

全ての判定には詳細なトレース情報が付与される。これにより：
- どのルールが発火したか
- どのツールがどのようなスコアを出したか
- なぜその判定に至ったか

を事後的に検証できる。ポリシーバージョン（例：v1.4.8-mlparadox-tld）により、判定時のルールセットも特定可能である。

### 8.3 段階的な改善

Phase1からPhase6まで、段階的にモジュールが追加・改善されてきた。各フェーズは後方互換性を維持しており、既存のCSV出力形式やAPI契約を壊さずに機能拡張が可能である。

---

## 9. 検証結果

### 9.1 ML Paradox検出性能（2026-01-11時点）

Phase6ポリシーバイパスのバグ修正後、以下の性能を達成：

| メトリクス | 修正前 | 修正後 |
|------------|--------|--------|
| Recall | 0% | **90.8%** |
| Precision | N/A | 57.8% |
| F1 Score | 0 | **0.706** |

### 9.2 TLD別検出性能

| TLD | 修正前Recall | 修正後Recall |
|-----|--------------|--------------|
| .cc | 0% | 83.3% |
| .lat | 0% | 88.9% |
| .online | 0% | 83.3% |
| .click | 0% | 100.0% |
| .cn | 0% | 88.9% |
| .icu | 0% | 100.0% |
| .top | 0% | 100.0% |

これらの結果は、「MLでは検知困難だがAIエージェントなら検知できる」ケースに対する有効性を示している。

---

## 付録A: 危険TLDリスト

以下のTLDは「常に危険」として扱われる：

```
top, xyz, icu, click, buzz, gq, ml, ga, cf, tk,
work, rest, fit, cam, monster, cn, cc, lat, online,
shop, ws, pw, cfd, cyou, wang, bar, mw, live
```

## 付録B: 無料CAリスト

以下の発行者は「無料CA」として分類される：

```
Let's Encrypt, ZeroSSL, Cloudflare, Buypass,
SSL.com Free, cPanel (AutoSSL), Google Trust Services
```

## 付録C: ブランドキーワード（抜粋）

```
amazon, apple, google, microsoft, paypal, netflix,
facebook, instagram, whatsapp, line, rakuten,
mufg, smbc, mizuho, jcb, mastercard, visa...
```

完全なリストはStage1/Stage2の学習アーティファクトに含まれる。
