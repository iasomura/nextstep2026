# 研究日誌 2026-02-03

## 本日の作業

1. LLMスクリーニング実装・実行
2. FN候補分析の再検討
3. Stage2 FN分析と改善検討
4. Stage3評価の実行と中立的評価
5. 世界のフィッシング検知研究の調査と研究方向性の検討

---

## 1. LLMスクリーニングの実装と実行

### 1.1 目的

Stage1でML < 0.10と判定されたphishing（FN候補）をLLMで分析し、高リスクドメインをStage3に送信して救済する。

### 1.2 実装

**作成ファイル** (archived/llm_screening_v1/に退避済み):
- `llm_screening.py` - エントリポイント
- `screening_worker.py` - ScreeningWorker（Stage3インフラ共有）
- `screening_schema.py` - Pydanticスキーマ（Structured Output）

**技術的特徴**:
- LangChain `with_structured_output()` 使用
- Stage3の CheckpointManager, ResultWriter を共有
- チェックポイント・再開機能あり

### 1.3 実行結果

| 項目 | 結果 |
|------|------|
| 処理件数 | 757件 |
| 成功 | 709件 (93.7%) |
| Stage3候補 | 77件 (10.2%) |

### 1.4 問題点

**ドメイン名のみの分析では効果が薄い**

- 77件（10.2%）しかStage3候補として抽出できなかった
- LLMはドメイン名の「見た目」でしか判断できない
- 多くのphishingは正規ドメインに見える名前を使用

---

## 2. FN候補の定義ミス【重要な失敗】

### 2.1 当初の誤った定義

```python
# 誤り: y_true（正解ラベル）を使用
fn_candidates = df[(df['ml_probability'] < 0.10) & (df['y_true'] == 1)]
# → 757件
```

**問題**: 本番環境では `y_true` は分からない。

### 2.2 正しいパイプラインの理解

**Stage1の判定フロー**:

| Stage1判定 | 件数 | phishing | benign |
|------------|------|----------|--------|
| auto_phishing | 60,767 | 60,765 | 2 |
| auto_benign | 8,464 | **3** | 8,461 |
| handoff_to_agent | 57,991 | 2,843 | 55,148 |

**Stage1の本当のFNは3件のみ！**（auto_benign かつ y_true=1）

### 2.3 Stage2の判定フロー

| Stage2判定 | 件数 | phishing | benign |
|------------|------|----------|--------|
| not_candidate | 69,231 | 60,768 | 8,463 |
| drop_to_auto | 46,039 | **398** | 45,641 |
| handoff_to_agent | 11,952 | 2,445 | 9,507 |

**Stage2のFNは398件**（drop_to_auto かつ y_true=1）

### 2.4 教訓

- パイプラインの各段階の役割を正確に理解する必要がある
- ML確率の閾値（< 0.10）で単純にフィルタするのは不適切
- Stage1/Stage2の判定結果（decision）を使うべき

---

## 3. Stage2 FN（398件）の詳細分析

### 3.1 主因：CRL_DPゲート

| パターン | 件数 | 割合 |
|---------|------|------|
| CRL_DP あり & ML < 0.15 | 373 | 93.7% |
| その他 | 25 | 6.3% |

**373件がCRL_DPゲートでbenign判定された**

### 3.2 特徴分析

| 特徴 | phishing (373) | benign (43,600) |
|------|----------------|-----------------|
| Free CA | 65% | 41% |
| 組織名なし | 99% | 97% |
| 短期証明書 | 91% | 88% |
| TLD .com | 55% | 51% |

**phishingとbenignで特徴量がほぼ同じ** → 区別困難

### 3.3 改善案の検証

#### 案1: Free CA除外

```
条件: CRL_DP & ML<0.15 の場合、Free CAは除外してStage3へ
結果:
  - Stage3送信: +17,956件
  - TP: 244件 / FP: 17,712件
  - Precision: 1.4%
```

**却下**: 処理コストに対して効果が薄い（約150時間の追加処理）

#### 案2: 危険TLD追加条件

```
条件: Free CA AND 危険TLD
結果:
  - Stage3送信: 16件
  - TP: 1件 / FP: 15件
  - Recall: 0.3%
```

**却下**: ほとんど捕捉できない

#### 案3〜7: その他の条件

いずれも Precision < 10% または Recall < 5% で効果なし。

---

## 4. 結論

### 4.1 最終判断

**Stage2 FN 373件（全phishingの0.6%）は許容する**

理由:
1. CRL_DPゲート対象のphishingは特徴量上benignと区別困難
2. 改善には大きなコスト（Stage3 +43,973件処理）が必要
3. FN率0.6%は十分に低い

### 4.2 パイプライン精度

| ステージ | FN | FN率 |
|----------|-----|------|
| Stage1 | 3件 | 0.005% |
| Stage2 | 398件 | 0.6% |
| 累計 | 401件 | 0.6% |

### 4.3 LLMスクリーニングの評価

| 観点 | 評価 |
|------|------|
| 技術的実装 | 成功（Stage3インフラ共有、Structured Output） |
| 効果 | **不十分**（10.2%しか抽出できず） |
| 問題 | ドメイン名のみでは判断材料不足 |
| 今後 | 証明書情報等を含めても区別困難と判明 |

---

## 5. Stage3評価の実行と中立的評価

### 5.1 Stage3評価の完了

11,952件の灰色領域ドメインをAI Agentで評価した。

**評価環境**:
- 3GPU並列（Port 8000, 8001, 8002）
- 処理時間: 約5.5時間
- エラー率: 0.3%（32件）

**Stage3単体の性能**:

| 指標 | 値 |
|------|-----|
| Accuracy | 88.5% |
| Precision | 74.4% |
| Recall | 66.7% |
| F1 | 70.3% |
| TP | 1,624 |
| FP | 560 |
| FN | 810 |

### 5.2 システム全体の中立的評価【重要】

**ML単体 vs システム全体（Stage1+2+3）の比較**:

| 指標 | ML単体 | システム全体 | 差分 |
|------|--------|-------------|------|
| Precision | 99.48% | 99.11% | **-0.38pp** |
| Recall | 97.74% | 98.10% | **+0.36pp** |
| F1 | 98.60% | 98.60% | **±0.00pp** |

**Stage2+3の貢献**:
- 追加検出したフィッシング (TP): +227件
- 追加誤検出 (FP): +240件
- **トレードオフはほぼ1:1**

### 5.3 AI Agentの価値評価

**客観的事実**:
1. ML（XGBoost）単体で既にF1 98.6%を達成
2. Stage2+3を追加してもF1は変化なし（±0.00pp）
3. Recall +0.36pp の改善と引き換えに Precision -0.38pp の悪化

**結論**:

> **AI Agentの追加価値は統計的に有意ではない**
>
> ML単体で十分な性能が出ており、11,920件のLLM処理コストに見合う改善は得られていない。
> Stage3は「灰色領域」の約2/3を正しく判定するが、1/3を見逃している。
> システム全体への寄与は限定的。

---

### ⚠️ 【2026-02-04 訂正】この結論は比較方法が不適切だった

上記の「全データでの比較」は**Stage3の価値を過小評価している**。

**問題点**:
- ML単体の性能は全データ（約60,000件）で計算
- Stage3はハンドオフ候補（約12,000件）のみを処理
- Stage3の効果が全体に希釈され、見えなくなっていた

**正しい比較（ハンドオフ候補のみ）**:

| 指標 | Stage1+2のみ | Stage1+2+3 | 差分 |
|------|-------------|------------|------|
| F1 | 67.0% | 71.2% | **+4.2pp** |
| Recall | 57.1% | 69.2% | **+12.1pp** |
| TP | 848 | 1,027 | **+179** |

**訂正後の結論**: Stage3は処理対象において**F1 +4.2pp、Recall +12.1pp、追加検出+179件**の改善を達成しており、明確な価値がある。詳細は2026-02-04の研究日誌を参照。

---

### 5.4 考察

**なぜAI Agentの効果が限定的か**:

1. **MLが既に非常に優秀**: XGBoostが98.6%のF1を達成しており、改善余地が小さい
2. **灰色領域の難しさ**: Stage3に送られるのは「MLが判断できなかった」ケースであり、本質的に難しい
3. **Stage2ゲートの副作用**: 証明書ベースのゲートで45,641件をbenign判定（398件のFNを含む）

**今後の検討事項**:

1. ~~AI Agentを完全に廃止してML単体で運用するか~~ → **【訂正】Stage3は価値があるため廃止不要**
2. Stage3の処理対象を絞り込み、コスト効率を改善するか
3. Stage2ゲートの条件を緩和してStage3の処理対象を増やすか
4. **【追加】FP増加（+162件）の抑制** — `.xyz`, `.shop` TLDでの過剰検出対策

---

## 6. 世界のフィッシング検知研究の調査

### 6.1 調査の背景

AI Agentの追加価値がF1 ±0.00ppという結果を受け、研究として成立させるための方向性を検討するため、最新の研究動向を調査した。

### 6.2 主要な研究アプローチ（2025-2026）

| アプローチ | 代表研究 | 精度 | 特徴 |
|-----------|---------|------|------|
| **Multi-Agent Debate** | PhishDebate (arXiv 2506.15656) | F1 96.6% | 4専門エージェント + 討論による合意形成 |
| **ML + XAI + LLM** | EXPLICATE (arXiv 2503.20796) | 98.4% | SHAP/LIME + LLMで人間が読める説明を生成 |
| **CNN-LSTM + XAI** | IoT Phishing (Springer 2025) | 98.64% | XAIによりFP率41%削減 |
| **Zero-Day Detection** | ZdAD-UML (ScienceDirect 2025) | 100% | 教師なし学習で未知攻撃を検出 |

### 6.3 AI Agentが優位性を持つ領域

研究調査から明らかになった**AI Agentの強み**:

1. **Explainability（説明可能性）**
   - MLの"ブラックボックス"問題を解決
   - SOCアナリストが判断理由を理解可能
   - 規制対応（GDPR等）で必須化の傾向

2. **Zero-Day/Novel Attack Detection**
   - 既知パターンに依存しない検出
   - LLMの言語理解による意図分析
   - 署名ベース手法の限界を克服

3. **Contextual Reasoning（文脈理解）**
   - ブランド模倣の微妙なニュアンス検出
   - 緊急性を煽る文言の認識
   - 多言語での攻撃意図分析

4. **Multi-Lingual Support（多言語対応）**
   - 英語以外の言語でのML限界
   - 日本語フィッシングは研究が少ない
   - Cross-lingual転移でPrecision 66.7% → 14.8%に低下

### 6.4 重要な発見: PhishDebate

**Single-Agent vs Multi-Agent の比較**:

| 手法 | Precision | Recall | F1 |
|------|-----------|--------|-----|
| Single Agent Direct | 60.57% | 97.40% | 74.69% |
| Chain of Thought | 88.61% | 93.40% | 90.94% |
| **PhishDebate (Multi-Agent)** | **90.57%** | **98.00%** | **94.14%** |

**Multi-Agentの優位性**:
- ハルシネーション削減（相互検証）
- 透明性の高い判断根拠
- モジュール性（エージェントの追加・削除が容易）

### 6.5 研究方向性の選択肢

| 方向性 | コンセプト | 実現性 | 学術的インパクト |
|--------|-----------|--------|-----------------|
| **A: Explainability** | MLで検出、AIで「なぜ」を説明 | 高 | 中 |
| **B: Zero-Day** | 未知攻撃への対応力を評価 | 中 | 高 |
| **C: 日本語特化** | 英語中心研究のギャップを埋める | 高 | 中 |
| **D: Multi-Agent** | PhishDebate的な討論システム | 中 | 高 |
| **E: Cost-Aware** | いつML/AIを使うかの最適化 | 中 | 中 |

### 6.6 推奨する組み合わせ

**実現可能性重視**: A + C（日本語フィッシングの説明可能な検出）
- 既存システムの改修が少ない
- 日本語フィッシング研究のギャップを埋める
- 説明可能性は規制対応で需要あり

**学術的インパクト重視**: B + D（Zero-Day攻撃に対するMulti-Agent Defense）
- LLM生成フィッシングへの対応は最先端
- Multi-Agent系は2025-2026で注目
- 敵対的環境での評価は新規性あり

### 6.7 参考文献

**Multi-Agent / LLM-Based Detection**:
- PhishDebate: https://arxiv.org/html/2506.15656v1
- MultiPhishGuard: https://arxiv.org/html/2505.23803v1

**Explainable AI**:
- EXPLICATE: https://arxiv.org/html/2503.20796v1
- IoT Phishing XAI: https://link.springer.com/article/10.1007/s43926-025-00202-9

**Zero-Day Detection**:
- ZdAD-UML: https://www.sciencedirect.com/science/article/abs/pii/S0950705125008792

**Multilingual / Cross-lingual**:
- X-Phishing-Writer: https://dl.acm.org/doi/10.1145/3670402
- Multilingual OSINT: https://arxiv.org/html/2501.08723v1

**Survey Papers**:
- ML/NN Systematic Review 2017-2024: https://www.mdpi.com/2079-9292/14/18/3744
- LLMs meet Cybersecurity: https://link.springer.com/article/10.1186/s42400-025-00361-w

詳細な分析は `docs/analysis/research_direction_analysis.md` を参照。

---

## 7. 退避したファイル

```
scripts/archived/llm_screening_v1/
├── llm_screening.py        # エントリポイント
├── screening_worker.py     # ScreeningWorker
└── screening_schema.py     # Pydanticスキーマ
```

将来的に証明書情報を含めたLLM分析を再検討する場合に参照可能。

---

## 変更履歴

- 2026-02-03 10:00: 世界のフィッシング検知研究の調査結果を追加、研究方向性の選択肢を整理
- 2026-02-03 08:40: Stage3評価完了、システム全体の中立的評価を追加（AI Agentの追加価値がF1 ±0.00ppと判明）
- 2026-02-03: LLMスクリーニング実装・実行・評価、FN候補定義の修正、Stage2 FN分析と許容判断
