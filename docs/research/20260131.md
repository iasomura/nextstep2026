# 研究日誌 2026-01-31

## 本日の作業

### ml_paradox 詳細分析と改善案策定
- 1. 全件評価完了（13,890件）の確認
- 2. ml_paradox発火パスの詳細分析
- 3. 低精度シグナルの特定
- 4. 改善案の策定とF1影響シミュレーション
- 5. ドキュメント更新（02_improvement_analysis.md）

---

## 1. 全件評価結果の確認

### 評価完了状況

| Worker | 担当件数 | 完了 | 失敗 | 状態 |
|--------|---------|------|------|------|
| Worker 0 | 1,094 | 1,094 | 0 | 完了 |
| Worker 1 | 1,218 | 1,218 | 0 | 完了 |
| Worker 2 | 688 | 678 | 10 | 完了（タイムアウト10件） |

### 最終メトリクス（13,890件）

| 指標 | 値 |
|------|-----|
| **F1 Score** | **68.02%** |
| Precision | 71.31% |
| Recall | 65.03% |
| TP | 1,586 |
| FP | 638 |
| FN | 853 |
| TN | 10,813 |

---

## 2. ml_paradox 発火パス分析

### 背景

ml_paradox が FP 320件（50.2%）に関与 → 最大のFP要因。
詳細な発火メカニズムを調査。

### 発見: 2つの発火パス

ml_paradox（強）には2つの発火パスが存在：

| パス | 条件 | FP | TP | Precision |
|-----|------|---:|---:|----------:|
| **通常パス** | risk_signal_count >= 2, ML <= 0.20 | 43 | 17 | 28.3% |
| **free_ca+no_org パス** | free_ca + no_org + _needs_extra のいずれか | **277** | 106 | 27.7% |

**→ FPの86.6%が「free_ca + no_org + _needs_extra」パスで発生**

### コード該当箇所

```python
# contextual_risk_assessment.py (lines 414-428)
if p <= PARADOX_STRONG_MAX_ML and {"free_ca", "no_org"}.issubset(issue_set):
    _needs_extra = {
        "dangerous_tld",
        "brand_detected",
        "random_pattern",
        "high_entropy",
        "short_random_combo",
        "random_with_high_tld_stat",
        "idn_homograph",
        "consonant_cluster_random",
        "rare_bigram_random",
    }
    if issue_set & _needs_extra:
        is_paradox_strong = True
```

---

## 3. _needs_extra シグナル別精度分析

free_ca + no_org パスで使用される「追加シグナル」の精度を分析：

| シグナル | FP | TP | Precision | 判定 |
|---------|---:|---:|----------:|------|
| short_random_combo | 4 | 11 | **73.3%** | ✓ 維持 |
| dangerous_tld | 153 | 95 | 38.3% | ✓ 維持 |
| rare_bigram_random | 59 | 26 | 30.6% | ✓ 維持 |
| **brand_detected** | **130** | **29** | **18.2%** | ⚠ 低精度 |
| **consonant_cluster_random** | **17** | **2** | **10.5%** | ⚠ 低精度 |

### 低精度シグナルの問題

- **brand_detected (18.2%)**: ブランドキーワードを含む正規サイト（citizen系、apple系など）が誤検出
- **consonant_cluster_random (10.5%)**: 略語や外国語ドメインが誤検出

---

## 4. 改善案とシミュレーション

### 改善案: `_needs_extra` から低精度シグナルを除外

```python
# 現在
_needs_extra = {
    "dangerous_tld", "brand_detected", "random_pattern", ...
    "consonant_cluster_random", "rare_bigram_random",
}

# 改善案
_needs_extra = {
    "dangerous_tld", "random_pattern", "high_entropy",
    "short_random_combo", "random_with_high_tld_stat",
    "idn_homograph", "rare_bigram_random",  # brand_detected, consonant_cluster_random を除外
}
```

### 期待効果

| 指標 | 現状 | 改善後 | 変化 |
|------|------|--------|------|
| FP | 638 | 516 | **-122件** |
| TP | 1,586 | 1,568 | -18件 |
| Precision | 71.31% | 75.24% | **+3.93pp** |
| Recall | 65.03% | 64.29% | -0.74pp |
| **F1** | **68.02%** | **69.33%** | **+1.31pp** |

### トレードオフ評価

- **FP削減**: 122件（19.1%減）
- **TP損失**: 18件（1.1%減）
- **Net効果**: Precision大幅改善によりF1向上

---

## 5. ドキュメント更新

`docs/analysis/02_improvement_analysis.md` を更新：

| セクション | 更新内容 |
|-----------|---------|
| 7.9 改善提案 | 「※旧版」注記追加、#3の期待効果更新 |
| 12.1 推奨事項1 | ⛔廃止マーク（TLDアプローチはロールバック済み） |
| 13. 改善優先順位 | #1を新提案（_needs_extra修正）に変更 |
| 14. やることリスト #3 | 詳細分析結果を全面更新 |
| 次のステップ | 優先順位更新 |
| 変更履歴 | 今回の分析結果を追記 |

---

## 6. 今後のタスク

### 優先度高

| # | 項目 | 期待効果 | 状態 |
|---|------|---------|------|
| 16 | ML >= 0.5 FN救済 | FN -60件 | **次に検討** |
| 17 | critical_brand_minimum 調整 | FP -171件 | 要詳細分析 |

### 完了済み（本日）

- **#3 ml_paradox: _needs_extra 修正** ✅ (11:00)
  - `brand_detected`, `consonant_cluster_random` を除外
  - テスト確認済み
- ml_paradox TLD修正のロールバック（#14）
- 全件評価（13,890件）完了確認
- ml_paradox詳細分析完了
- ドキュメント整合性更新

---

---

## 7. 3000件サンプル評価（01:49-07:17）

### 評価設定
- **サンプル数**: 3,000件（シャッフル、random_state=42）
- **GPU**: 3台並列 (Port 8000, 8001, 8002)
- **所要時間**: 約2.5時間

### 結果

| 指標 | 前回全件 (13,890件) | 今回3000件 | 変化 |
|------|---------------------|------------|------|
| **F1 Score** | 68.02% | **70.39%** | **+2.37pp** |
| Precision | 71.31% | 73.00% | +1.69pp |
| Recall | 65.03% | 67.96% | +2.93pp |
| TP | 1,586 | 384 | - |
| FP | 638 | 142 | - |
| FN | 853 | 181 | - |
| TN | 10,813 | 2,293 | - |

### 効果測定ログ確認

| 項目 | 件数 |
|------|------|
| 除外でブロック | **79件** |
| - consonant_cluster_random | 53件 |
| - brand_detected | 26件 |

| 結果 | 件数 | 説明 |
|------|------|------|
| TN (FP回避) | **53件** | 正規サイトを正しく判定 ✓ |
| FP (依然誤検出) | 20件 | 他のルールで誤検出 |
| TP | 6件 | フィッシングを正しく検出 |
| FN | **0件** | 見逃しなし ✓ |

### 整合性確認

- **FP削減数 = ログのTN数**: 53 == 53 ✓
- **FN増加なし**: 0件 ✓
- **結論**: 効果測定ログと全体結果は整合

### 失敗ドメイン（5件）

Worker 2 でタイムアウト:
- `uslaw.link`
- `gzqxpj.com`
- `detailspourinvites.com`
- `citizenmatters.in`
- `pushleads.com`

---

## 8. 今後のタスク

### 優先度高

| # | 項目 | 期待効果 | 状態 |
|---|------|---------|------|
| 16 | ML >= 0.5 FN救済 | FN -60件, F1 +0.74pp | **次に実装** |
| 17 | critical_brand_minimum 調整 | FP -171件 | #3評価後に再分析 |

### 完了済み（本日）

- ✅ **#3 ml_paradox: _needs_extra 修正** (11:00実装, 07:17評価完了)
  - `brand_detected`, `consonant_cluster_random` を除外
  - 効果: F1 +2.37pp（期待+1.31ppを上回る）
- ✅ ml_paradox詳細分析
- ✅ 効果測定ログの整合性確認
- ✅ ドキュメント更新

### リトライ機能実装完了 ✅

**問題**: タイムアウト5件（0.17%）がスキップされた

**タイムアウトドメイン**:
- `uslaw.link`
- `gzqxpj.com`
- `detailspourinvites.com`
- `citizenmatters.in`
- `pushleads.com`

**実装完了**:
- `--retry-failed` オプションを追加
- タイムアウト2倍（60秒→120秒）で再評価
- 5件全て成功

**リトライ結果**:

| ドメイン | 結果 | 処理時間 |
|---------|------|---------|
| uslaw.link | ✓ safe (confidence=0.75) | 12.4秒 |
| gzqxpj.com | ✓ safe (confidence=0.60) | 10.2秒 |
| detailspourinvites.com | ✓ safe (confidence=0.70) | 9.8秒 |
| citizenmatters.in | ✓ safe (confidence=0.75) | 11.5秒 |
| pushleads.com | ✓ safe (confidence=0.70) | 10.1秒 |

**修正箇所**:
- `scripts/evaluate_e2e_parallel.py`: `--retry-failed` オプション追加、パス解決修正
- `scripts/parallel/orchestrator.py`: `retry_failed_domains()` メソッド追加、`initialize()` 呼び出し追加
- `scripts/parallel/worker.py`: `retry_failed()` メソッド追加
- `scripts/parallel/checkpoint.py`: `get_all_failed_domains()`, `clear_failed_domain()` メソッド追加
