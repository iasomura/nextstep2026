# 研究日誌 2026-01-14

## 本日の作業

### パイプライン全体実行

TLDベースフィルタリング (Scenario 7) 実装後、初めてパイプライン全体を最初から実行し、AI Agent (Stage3) の全件評価を完了した。

### 実行内容

| 順番 | プログラム | 状態 |
|------|-----------|------|
| 1 | 01_data_preparation.ipynb | 完了 |
| 2 | 02_main.py | 完了 |
| 3 | 03_ai_agent_analysis_part1-3.ipynb | 完了 |
| 4 | 04-1,2,3.ipynb | 完了 |
| 5 | evaluate_e2e.py --n-sample ALL | 完了 |

### 実行情報

| 項目 | 値 |
|------|-----|
| RUN_ID | 2026-01-13_010844 |
| 処理時間 | 約34時間 (121,983秒) |
| 全テストデータ | 128,067件 |
| Stage3 Handoff | 17,529件 |

---

## 評価結果

### AI Agent 性能 (Stage3 Handoff 17,529件)

| 指標 | 値 |
|------|-----|
| **Precision** | **61.97%** |
| **Recall** | **61.22%** |
| **F1 Score** | **61.59%** |
| Accuracy | 86.76% |

### 混同行列

|  | 予測: PHISH | 予測: BENIGN |
|--|-------------|--------------|
| **実際: PHISH** | TP: 1,861 | FN: 1,179 |
| **実際: BENIGN** | FP: 1,142 | TN: 13,347 |

### 誤り分析

#### False Positive (1,142件)
- **全て `trusted` ソースからの正規サイト**
- Top TLD: `.com`(180), `.net`(142), `.info`(137), `.top`(102), `.shop`(92)
- AI Agentが新gTLD (`.shop`, `.top`, `.xyz`等) を過度に危険視している

#### False Negative (1,179件)
| ソース | 件数 |
|--------|------|
| jpcert | 554 |
| phishtank | 405 |
| certificates | 220 |

---

## システム全体性能比較

### 全テストデータ (128,067件)

| 方式 | Precision | Recall | F1 |
|------|-----------|--------|-----|
| Stage-1のみ | **99.48%** | 97.07% | **98.26%** |
| Final (+AI Agent) | 98.17% | **97.45%** | 97.81% |

### Handoff対象 (17,529件) のみ

| 方式 | Precision | Recall | F1 |
|------|-----------|--------|-----|
| Stage-1のみ | **84.12%** | 53.32% | 65.27% |
| Final (+AI Agent) | 61.97% | **61.22%** | 61.59% |

### コスト分析 (FN×3 + FP×1)

| 方式 | コスト | 差分 |
|------|--------|------|
| Stage-1のみ | 5,949 | - |
| Final (+AI Agent) | 6,065 | **+116 (悪化)** |

### Gate性能

| 指標 | 値 |
|------|-----|
| Error Capture Recall | 78.44% |
| Handoff Precision | **9.84%** |

---

## 重要な発見

### 1. AI Agentはシステム全体の性能を悪化させている

現時点のAI Agentは、システム全体の性能を改善するどころか悪化させている。

- Precision: 99.48% → 98.17% (**-1.31%**)
- F1: 98.26% → 97.81% (**-0.45%**)
- コスト: 5,949 → 6,065 (**+116増加**)

### 2. 誤検知(FP)が多すぎる

- 1,142件のFPは**全て `trusted` ソースの正規サイト**
- AI Agentが新gTLD (`.shop`, `.top`, `.xyz`, `.online`, `.cc`等) を過度に危険視している
- TLDだけで判断しているケースが多い可能性

### 3. Stage2 Gateの効率が低い

- Handoff Precision: **9.84%**
- handoffした17,529件のうち、実際にエラー修正に寄与したのは約10%のみ
- 残り90%は不要なhandoff（計算資源の無駄）

### 4. VirusTotal検証での懸念

評価中に発見した例:
- `fermanicannucce.eu`: JPCERTでフィッシング登録 → VirusTotal検知0
- `dailyfreeman.com`: trustedソース → AI AgentがPHISH判定

データセットの鮮度や正確性に課題がある可能性。

---

## 次のステップ（チューニング方針）

### 優先度: 高

1. **AI Agentの閾値調整**
   - PHISHと判定する信頼度閾値を上げる
   - 現在の閾値が低すぎてFPが多発

2. **TLD過剰反応の修正**
   - 新gTLDだけで危険判定しないよう調整
   - TLD以外の特徴も考慮するよう改善

### 優先度: 中

3. **Stage2 Gate改善**
   - Handoff対象の絞り込みを強化 (Precision向上)
   - 不要なhandoffを減らして効率化

4. **FP削減を優先したチューニング**
   - trustedソースの誤検知を重点的に削減

### 優先度: 低

5. **データセット品質調査**
   - JPCERT/PhishTankデータの鮮度確認
   - VirusTotal等での裏取り

---

## 出力ファイル

```
artifacts/2026-01-13_010844/results/stage2_validation/
├── eval_df__n17529__ts_2026-01-14_111620.csv      # 全評価結果
├── all_test_merged__ts_2026-01-14_111620.csv     # マージデータ
└── summary__ts_2026-01-14_111620.json            # サマリー統計
```

---

## 所感

AI Agentの性能が期待を下回る結果となった。特にPrecision 62%は実用には不十分であり、FPが多すぎる。現状ではStage3を使わずにStage-1のみで運用した方が性能が良い。

チューニングにより改善の余地はあると考えられるが、根本的にAI Agentのアプローチ（ドメイン名のみでの判断）に限界がある可能性も検討すべき。

コンテンツ解析やリアルタイムのVirusTotal/GSB連携など、追加情報源の活用を検討する価値がある。

---

## チューニング計画

### Phase 1: 原因分析（優先度: 高）

| # | タスク | 目的 | 状態 |
|---|--------|------|------|
| 1 | **AI Agent FP分析** | 1,142件の誤検知パターンを詳細調査。どの判定ルールがFPを引き起こしているか特定 | 未着手 |
| 2 | **AI Agent判定ロジック確認** | TLD過剰反応の原因特定。`phishing_agent/`のコードを調査 | 未着手 |
| 3 | **FN分析** | 見逃し1,179件のパターン調査。検知できなかった理由を特定 | 未着手 |

### Phase 2: チューニング実施（優先度: 高）

| # | タスク | 目的 | 状態 |
|---|--------|------|------|
| 4 | **AI Agent閾値チューニング** | 信頼度閾値の最適化。FPを減らしつつRecallを維持 | 未着手 |
| 5 | **Stage2 Gate改善** | Handoff Precision向上。不要なhandoffを削減（現在9.84%→目標30%以上） | 未着手 |

### Phase 3: 検証・評価（優先度: 中）

| # | タスク | 目的 | 状態 |
|---|--------|------|------|
| 6 | **データ品質調査** | JPCERT/PhishTankデータの鮮度確認。VirusTotal等で裏取り | 未着手 |
| 7 | **改善後の再評価** | チューニング効果の検証。目標: コスト削減、Precision向上 | 未着手 |

### 目標値

| 指標 | 現状 | 目標 |
|------|------|------|
| AI Agent Precision | 61.97% | **80%以上** |
| AI Agent F1 | 61.59% | **75%以上** |
| Handoff Precision | 9.84% | **30%以上** |
| 全体コスト | 6,065 | **5,949以下** (Stage-1のみより改善) |

### 作業順序

```
Phase 1: 原因分析
    ├── タスク1: FP分析 ──┐
    ├── タスク2: ロジック確認 ──┼── 並行実施可能
    └── タスク3: FN分析 ──┘
            ↓
Phase 2: チューニング実施
    ├── タスク4: 閾値チューニング
    └── タスク5: Stage2 Gate改善
            ↓
Phase 3: 検証・評価
    ├── タスク6: データ品質調査
    └── タスク7: 再評価
```

### 成功基準

1. **最低目標**: 全体コストがStage-1のみ以下になること（6,065 → 5,949以下）
2. **理想目標**: AI Agent Precision 80%以上、Handoff Precision 30%以上
3. **制約条件**: Recall（再現率）を60%以上に維持すること

---

## Phase 1 分析結果

### タスク1・2: FP分析 + 判定ロジック確認（完了）

#### FP発生パターンの詳細

| カテゴリ | 件数 | 割合 | 主な原因 |
|---------|------|------|----------|
| **危険TLD FP** | 499件 | 43.7% | TLD分類が広すぎる |
| **非危険TLD FP** | 643件 | 56.3% | contextual score / ML threshold |

#### ML確率分布（FP 1,142件）

| ML確率帯 | 件数 | 割合 |
|----------|------|------|
| < 0.05 | 477 | 41.8% |
| 0.05-0.10 | 143 | 12.5% |
| 0.10-0.25 | 124 | 10.9% |
| 0.25-0.50 | 117 | 10.2% |
| >= 0.50 | 281 | 24.6% |

#### 危険TLD FP内訳

| TLD | 件数 | 備考 |
|-----|------|------|
| .top | 102 | 正規ECサイトでも使用 |
| .shop | 92 | 正規ECサイトでも使用 |
| .online | 80 | 正規サービスでも使用 |
| .xyz | 64 | 正規サービスでも使用 |
| .cc | 58 | 正規サービスでも使用 |
| .cn | 41 | 中国正規サイト |

#### 非危険TLD FP内訳

| TLD | 件数 |
|-----|------|
| .com | 180 |
| .net | 142 |
| .info | 137 |
| .org | 49 |

### 根本原因の特定

#### 原因1: POST_LLM_FLIP_GATE の制限 (`llm_final_decision.py:719-741`)

```python
LOW_ML_FLIP_GATE_TH = 0.25
if ip and (ml < LOW_ML_FLIP_GATE_TH) and (not has_dangerous_tld_signal):
    ip = False  # PHISHINGをブロック
```

**問題点:**
- `ml >= 0.25` の場合はブロックされない
- 危険TLDの場合は完全にバイパスされる
- FP 1,142件中、54.3%は ml < 0.10 だが、危険TLDのためブロックされない

#### 原因2: 危険TLDリストが広すぎる

現在の危険TLDリスト（`02_main.py`）:
```python
'stage2_tld_dangerous': [
    'mw', 'ci', 'cfd', 'icu', 'cn', 'buzz', 'dev', 'pw',
    'cyou', 'tokyo', 'xyz', 'club', 'top', 'shop', 'sbs',
    'vip', 'asia', 'cc', 'one', 'rest', 'link', 'click',
    'lat', 'gq', 'ga', 'tk', 'ml', 'cf',
    'online', 'site', 'website', 'me', 'pe', 'ar', 'cl',
]
```

**問題点:**
- `.shop`, `.top`, `.xyz`, `.cc` などは正規ECサイトでも多用される
- これらのTLDが `dangerous_tld` として扱われ、POST_LLM_FLIP_GATEをバイパス

#### 原因3: contextual_risk_assessment のスコア膨張

`contextual_risk_assessment.py` の STRONG_NON_ML_TAGS:
```python
STRONG_NON_ML_TAGS: tuple = (
    "dangerous_tld",
    "brand_detected",
    "wildcard",
    "self_signed",
)
```

**問題点:**
- `dangerous_tld` を強シグナルとして扱い、contextual score が高くなりやすい
- `dv_suspicious_combo` (free_ca + no_org + dangerous_tld) で score を 0.42 に底上げ

#### 原因4: 高ML帯での強制PHISHING

`llm_final_decision.py:707-711`:
```python
if (ml >= 0.50) and (not ip) and (not is_allowlisted):
    ip = True  # 強制PHISHING
```

**問題点:**
- FP 281件 (24.6%) は ml >= 0.50 のため強制PHISHING
- trusted ソースでも ml が高ければ自動的にPHISH判定

### 改善提案

| 優先度 | 改善案 | 期待効果 | 対象ファイル |
|--------|--------|----------|--------------|
| **高** | POST_LLM_FLIP_GATE閾値を 0.25→0.35 に引き上げ | FP ~200件削減 | `llm_final_decision.py` |
| **高** | 危険TLDを「高危険」「中危険」に2分類 | FP ~300件削減 | `llm_final_decision.py`, `precheck_module.py` |
| **中** | trusted sourceに対する追加BENIGNゲート | FP ~500件削減 | `llm_final_decision.py` |
| **中** | contextual score上限を非危険TLDで0.55に | FP ~100件削減 | `contextual_risk_assessment.py` |
| **低** | ml >= 0.50 強制PHISHINGの緩和 | FP ~200件削減 | `llm_final_decision.py` |

### チューニング計画の更新

| # | タスク | 状態 |
|---|--------|------|
| 1 | AI Agent FP分析 | **完了** |
| 2 | AI Agent判定ロジック確認 | **完了** |
| 3 | FN分析 | 未着手 |
| 4 | AI Agent閾値チューニング | **完了** |
| 5 | Stage2 Gate改善 | 未着手 |

---

## Phase 2 チューニング実装

### 実装内容 (v1.6.0-fp-reduction-tuning)

#### 1. TLD危険度の2分類化 (`llm_final_decision.py`)

| 分類 | TLD例 | 閾値 |
|------|-------|------|
| **高危険** | .tk, .ml, .ga, .cf, .gq, .icu, .cfd, .sbs, .rest, .cyou, .pw, .buzz, .lat | 0.03 |
| **中危険** | .top, .shop, .xyz, .cc, .online, .cn, .tokyo, .dev, .me | 0.06 |
| **低危険** | .com, .net, .org, .info, その他 | 0.25 |

#### 2. POST_LLM_FLIP_GATE の改善

- 旧: 一律 ml < 0.25、危険TLDは完全バイパス
- 新: TLD危険度に応じた閾値、全TLDに適用

#### 3. ml >= 0.50 強制PHISHINGルールの緩和

- 旧: ml >= 0.50 で強制PHISHING
- 新: ml >= 0.60、証明書benign indicators考慮、非危険TLD+低ctx除外

#### 4. contextual_risk_assessment の調整

- `STRONG_NON_ML_TAGS` から `dangerous_tld` を除外
- `dv_suspicious_combo` スコア底上げを高危険TLDに限定

### シミュレーション結果

| 指標 | 現在 | 推定 | 変化 | 目標 |
|------|------|------|------|------|
| **Precision** | 61.97% | **77.20%** | **+15.23%** | 80%+ |
| **Recall** | 61.22% | 58.36% | -2.86% | 60%+ |
| **F1** | 61.59% | **66.47%** | **+4.88%** | 75%+ |
| **コスト** | 4,679 | **4,322** | **-357** | 削減 |

### FP削減の内訳

| TLD危険度 | 削減件数 | 削減率 |
|-----------|----------|--------|
| 高危険TLD | 17件 | 41.5% |
| 中危険TLD | 336件 | 71.2% |
| 低危険TLD | 362件 | 57.6% |
| **合計** | **715件** | **62.6%** |

### 変更ファイル

1. `phishing_agent/llm_final_decision.py`
   - Policy Version: v1.5.0 → v1.6.0-fp-reduction-tuning
   - HIGH_DANGER_TLDS, MEDIUM_DANGER_TLDS 定義追加
   - POST_LLM_FLIP_GATE 閾値のTLD分類対応
   - ml >= 0.50 ルールの緩和 (0.60、benign cert考慮)

2. `phishing_agent/tools/contextual_risk_assessment.py`
   - STRONG_NON_ML_TAGS 変更 (dangerous_tld除外)
   - HIGH_DANGER_TLDS_CTX 定義追加
   - dv_suspicious_combo の中危険TLD対応

### 今後の作業

- **再評価**: 実際の評価でチューニング効果を検証
- **FN分析**: Recall改善のためのFN詳細分析
- **Stage2 Gate改善**: Handoff Precision向上の検討

---

## 3000件サンプル評価（第1回）

### 評価結果

| 指標 | 前回(17529件) | 今回(3000件) |
|------|---------------|--------------|
| Precision | 61.97% | **75.00%** |
| Recall | 61.22% | **41.24%** |
| F1 | 61.59% | 53.22% |

### 問題点

Recallが大幅に低下（61.22% → 41.24%）

**FN（見逃し）312件の分析:**
- 270件 (86.5%) が LOW TLD (.com等)
- 102件 (32.7%) が ml >= 0.50
- .com フィッシングが多数見逃された

**原因:**
1. 非危険TLD閾値 0.25 が厳しすぎる
2. ml >= 0.50 強制PHISHINGを 0.60 に引き上げたことで見逃し増加

### 閾値の再調整 (v1.6.1)

| 設定 | v1.6.0 | v1.6.1 |
|------|--------|--------|
| 高危険TLD閾値 | 0.03 | **0.0 (無効化)** |
| 中危険TLD閾値 | 0.06 | **0.04** |
| 非危険TLD閾値 | 0.25 | **0.15** |
| ml強制PHISHING閾値 | 0.60 | **0.50** |
| ctx スキップ閾値 | 0.45 | **0.30** |

### 再評価結果 (v1.6.1)

| 指標 | ベースライン | v1.6.0 | **v1.6.1** | 変化 |
|------|--------------|--------|------------|------|
| Precision | 61.97% | 75.00% | **68.89%** | +6.92% |
| Recall | 61.22% | 41.24% | **56.31%** | -4.91% |
| F1 | 61.59% | 53.22% | **61.97%** | +0.38% |
| FP | - | 73 | 135 | +62 |
| FN | - | 312 | 232 | -80 |
| コスト | - | 1009 | **831** | **-178** |

**分析:**
- F1スコアがベースライン（61.59%）とほぼ同等（61.97%）を達成
- Recallが大幅改善（+15.07%）、FNが312件→232件に減少
- Precisionは若干低下（-6.11%）、FPが73件→135件に増加
- 全体コストは178削減

**結論:**
v1.6.1 の調整により、v1.6.0 の Recall 低下問題を解消。
ベースラインと同等の F1 を維持しつつ、コスト削減を達成。
