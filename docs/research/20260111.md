# 研究日誌 2026-01-11

## 概要

AI Agent（Phase6）のML Paradox検出機能における重大なバグを発見・修正し、検出性能を大幅に改善した。

## 背景・課題

森先生の提案に基づき、以下の「ML Paradox」ケースに対するAI Agentの検出能力を検証していた：
- Stage1（XGBoost）: 「安全」と判定（ml_probability < 0.3）
- Stage2（LR Defer）: 「怪しい」と判定（defer_score >= 0.8）
- 追加シグナル: 危険TLD（.cn, .top, .cc, .icu 等）

このような「MLでは検知できないがAI Agentなら検知できるべき」ケースに対して、初期テストでは**Recall 0%**という致命的な結果が出ていた。

## 実施事項

### 1. 根本原因の特定

デバッグの結果、以下の2つの問題を発見：

#### 問題1: Phase6ポリシーのバイパス
`langgraph_module.py`の`_final_decision_node`が`SO.final_assessment()`を直接呼び出しており、`llm_final_decision.py`の`_apply_policy_adjustments()`（R1-R6ルール）が**完全にスキップ**されていた。

```python
# 修正前（バグ）
asmt = self.so.final_assessment(state["domain"], ml, state.get("tool_results", {}))

# 修正後
asmt = phase6_final_decision(
    llm=llm,
    domain=state["domain"],
    ml_probability=ml,
    tool_results=state.get("tool_results", {}),
    graph_state=state,  # precheck_hints を含む
    strict_mode=self.strict_mode,
)
```

#### 問題2: dangerous_tldリストの不整合
`short_domain_analysis.py`のデフォルトdangerous TLDリストに`.cc`, `.lat`, `.online`, `.shop`, `.cn`等が含まれておらず、これらのTLDが危険として検出されていなかった。

### 2. 修正内容

| ファイル | 修正内容 |
|----------|----------|
| `langgraph_module.py` | `phase6_final_decision`を経由するよう変更 |
| `llm_final_decision.py` | v1.4.8-mlparadox-tld: ctx_issuesのdangerous_tld統一チェック |
| `short_domain_analysis.py` | always-dangerous TLDリストに13種追加 |

### 3. 追加されたdangerous TLD

```
cc, lat, online, shop, cn, ws, pw, cfd, cyou, wang, bar, mw, live
```

## 評価結果

### テストデータ
- 対象: ML Paradox + 高リスクTLDケース 210件
- 内訳: Phishing 119件, Benign 91件

### 性能改善

| メトリクス | 修正前 | ポリシー修正後 | TLD修正後（最終） |
|------------|--------|----------------|-------------------|
| Recall     | 0%     | 68.9%          | **90.8%**         |
| Precision  | N/A    | 58.6%          | 57.8%             |
| F1 Score   | 0      | 0.633          | **0.706**         |
| TP         | 0      | 82             | 108               |
| FN         | 119    | 37             | 11                |

### TLD別Recall改善

| TLD | 修正前 | 修正後 |
|-----|--------|--------|
| .cc | 0% | 83.3% |
| .lat | 0% | 88.9% |
| .online | 0% | 83.3% |
| .click | 0% | 100.0% |
| .cn | 0% | 88.9% |
| .icu | 0% | 100.0% |
| .top | 0% | 100.0% |

## 発火したポリシールール

修正後、以下のルールが正常に発火するようになった：

- **R1**: ml < 0.20 + free_ca & no_org + ctx >= threshold + strong_evidence
- **R2**: ml < 0.30 + no_org + (free_ca or short) + ctx >= 0.34 + strong_evidence
- **R5**: ml < 0.50 + dangerous_tld + no_org + ctx >= 0.33
- **R6**: ml < 0.30 + dangerous_tld + free_ca & no_org + ctx >= 0.35（新規）

## コミット

```
6d1cb1e Fix Phase6 policy bypass and expand dangerous TLD coverage
```

## 考察

1. **アーキテクチャ上の教訓**: SO（Structured Output）クラスとポリシー調整ロジックが分離していたことで、重要なポリシーがバイパスされるバグが発生した。今後は統合テストで両方のパスを検証する必要がある。

2. **TLDリストの管理**: 複数のモジュール（precheck, short_domain_analysis, contextual_risk_assessment）で異なるTLDリストを参照しており、不整合が発生しやすい構造だった。always-dangerousリストをマージする方式で対応したが、将来的には一元管理が望ましい。

3. **Precision vs Recall のトレードオフ**: Recallを90.8%まで向上させた代わりに、FPが58→79件に増加した。フィッシング検出においてはFN（見逃し）の方がFP（誤検知）より深刻なため、この方向性は妥当と考える。

## 次のステップ

- [ ] 統合テストの追加（ポリシーバイパス再発防止）
- [ ] TLDリストの一元管理検討
- [ ] FP削減のためのルール微調整（特に.shop, .xyzの精度改善）
- [ ] Stage2 handoff全体での再評価

## 作成したテストスクリプト

- `scripts/test_ai_agent_high_risk_tld.py` - 210件の高リスクTLDテスト
- `scripts/test_ai_agent_sample.py` - 50件サンプルテスト
- `scripts/debug_policy_trace.py` - ポリシーロジックのデバッグ用
- `scripts/quick_test_policy.py` - クイック検証用
