# 研究日誌 2026-01-11

## 概要

AI Agent（Phase6）のML Paradox検出機能における重大なバグを発見・修正し、検出性能を大幅に改善した。

## 用語・システム構成

本システムの3段階パイプライン（Stage1/Stage2/Stage3）およびHandoff等の用語定義については [2026-01-10の研究日誌](20260110.md) を参照。

## 背景・課題

### ML Paradoxとは

「ML Paradox（機械学習のパラドックス）」とは、本研究で定義した以下の状況を指す用語：

```
Stage1 (XGBoost):     ml_probability < 0.3  →「安全」と判定
Stage2 (LR Defer):    defer_score >= 0.8    →「要詳細調査」と判定
```

Stage1の機械学習モデルは「安全」と判断しているが、Stage2の再評価モデルは「確信が持てない、Stage3で詳細調査すべき」と判断している矛盾状態。このようなケースは、証明書/ドメイン特徴量だけでは判別困難だが、追加のコンテキスト情報（危険TLD、ブランド偽装など）を考慮すれば検出可能な場合が多い。

本研究ではこのようなケースを「ML Paradox」と呼び、Stage3（AI Agent）による検出能力の検証対象としている。

### 検証対象

森先生の提案に基づき、以下の条件を満たすケースに対するAI Agentの検出能力を検証：
- Stage1（XGBoost）: 「安全」と判定（ml_probability < 0.3）
- Stage2（LR Defer）: 「怪しい」と判定（defer_score >= 0.8）
- 追加シグナル: 危険TLD（.cn, .top, .cc, .icu 等）

このような「MLでは検知できないがAI Agentなら検知できるべき」ケースに対して、初期テストでは**Recall 0%**という致命的な結果が出ていた。

## 実施事項

### 1. 根本原因の特定

デバッグの結果、以下の2つの問題を発見：

#### 問題1: Phase6ポリシーのバイパス
`langgraph_module.py`の`_final_decision_node`が`SO.final_assessment()`を直接呼び出しており、`llm_final_decision.py`の`_apply_policy_adjustments()`（R1-R6ルール）が**完全にスキップ**されていた。

```python
# 修正前（バグ）
asmt = self.so.final_assessment(state["domain"], ml, state.get("tool_results", {}))

# 修正後
asmt = phase6_final_decision(
    llm=llm,
    domain=state["domain"],
    ml_probability=ml,
    tool_results=state.get("tool_results", {}),
    graph_state=state,  # precheck_hints を含む
    strict_mode=self.strict_mode,
)
```

#### 問題2: dangerous_tldリストの不整合
`short_domain_analysis.py`のデフォルトdangerous TLDリストに`.cc`, `.lat`, `.online`, `.shop`, `.cn`等が含まれておらず、これらのTLDが危険として検出されていなかった。

### 2. 修正内容

| ファイル | 修正内容 |
|----------|----------|
| `langgraph_module.py` | `phase6_final_decision`を経由するよう変更 |
| `llm_final_decision.py` | v1.4.8-mlparadox-tld: ctx_issuesのdangerous_tld統一チェック |
| `short_domain_analysis.py` | always-dangerous TLDリストに13種追加 |

### 3. 追加されたdangerous TLD

```
cc, lat, online, shop, cn, ws, pw, cfd, cyou, wang, bar, mw, live
```

## 評価結果

### テストデータ
- 対象: ML Paradox + 高リスクTLDケース 210件
- 内訳: Phishing 119件, Benign 91件

### 性能改善

| メトリクス | 修正前 | ポリシー修正後 | TLD修正後（最終） |
|------------|--------|----------------|-------------------|
| Recall     | 0%     | 68.9%          | **90.8%**         |
| Precision  | N/A    | 58.6%          | 57.8%             |
| F1 Score   | 0      | 0.633          | **0.706**         |
| TP         | 0      | 82             | 108               |
| FN         | 119    | 37             | 11                |

### TLD別Recall改善

| TLD | 修正前 | 修正後 |
|-----|--------|--------|
| .cc | 0% | 83.3% |
| .lat | 0% | 88.9% |
| .online | 0% | 83.3% |
| .click | 0% | 100.0% |
| .cn | 0% | 88.9% |
| .icu | 0% | 100.0% |
| .top | 0% | 100.0% |

## 発火したポリシールール

修正後、以下のルールが正常に発火するようになった：

- **R1**: ml < 0.20 + free_ca & no_org + ctx >= threshold + strong_evidence
- **R2**: ml < 0.30 + no_org + (free_ca or short) + ctx >= 0.34 + strong_evidence
- **R5**: ml < 0.50 + dangerous_tld + no_org + ctx >= 0.33
- **R6**: ml < 0.30 + dangerous_tld + free_ca & no_org + ctx >= 0.35（新規）

## コミット

```
6d1cb1e Fix Phase6 policy bypass and expand dangerous TLD coverage
```

## 考察

1. **アーキテクチャ上の教訓**: SO（Structured Output）クラスとポリシー調整ロジックが分離していたことで、重要なポリシーがバイパスされるバグが発生した。今後は統合テストで両方のパスを検証する必要がある。

2. **TLDリストの管理**: 複数のモジュール（precheck, short_domain_analysis, contextual_risk_assessment）で異なるTLDリストを参照しており、不整合が発生しやすい構造だった。always-dangerousリストをマージする方式で対応したが、将来的には一元管理が望ましい。

3. **Precision vs Recall のトレードオフ**: Recallを90.8%まで向上させた代わりに、FPが58→79件に増加した。フィッシング検出においてはFN（見逃し）の方がFP（誤検知）より深刻なため、この方向性は妥当と考える。

---

## Stage1 FN（False Negative）の外部検証

### 背景

Stage1のFN（見逃し）について、「観測可能な特徴がないため検知できなかった」のか、「そもそもラベルが誤っていた」のかを切り分けるため、Google Safe Browsing（GSB）による外部検証を実施した。

### 「特徴なしFN」の定義

以下の全条件を満たすFNを「特徴なしFN」と定義：

| 条件 | 閾値 |
|------|------|
| TLD | 正規TLD（.com, .org, .net等） |
| ドメイン長 | >= 8文字 |
| エントロピー | < 4.0（ランダム文字列でない） |
| ブランド検出 | なし |
| 証明書 | 自己署名でない |
| サブドメイン | 深度 <= 2 |

### 抽出結果

- 全テストデータ: 128,067件
- Stage1 FN: 1,928件（FN率 3.01%）
- **特徴なしFN: 1,311件（FNの68.0%）**

### GSB検証

#### 方法

1. 特徴なしFN 1,311件からML確率で層化抽出（160件）
2. Playwright（Chromium headless）でGoogle Transparency Reportを自動チェック
3. スクリプト: `scripts/check_gsb_playwright.py`

#### 結果

| GSB判定 | 件数 | 割合 | 解釈 |
|---------|------|------|------|
| **safe** | 118 | 73.8% | ラベルエラーまたは復旧済み |
| **unknown** | 39 | 24.4% | GSBに未登録 |
| **unsafe** | 3 | **1.9%** | 真のフィッシング |

#### Unsafeと判定されたドメイン

| ドメイン | ML確率 | ソース |
|----------|--------|--------|
| tianxiqianhe.com | 0.0086 | jpcert |
| saltekomakine.com | 0.1601 | phishtank |
| generalgaming.ca | 0.2667 | phishtank |

#### ソース別分析

| ソース | N | safe率 | unsafe |
|--------|---|--------|--------|
| jpcert | 82 | 81.7% | 1 |
| phishtank | 56 | 60.7% | 2 |
| certificates | 22 | 77.3% | 0 |

### 発見事例：ラベルエラーの可能性

`keishitanaka.com`（ml=0.0027, jpcert）を実際にアクセスしたところ、日本人アーティスト（田中慧士）の公式サイトであり、フィッシングの兆候は確認されなかった。これはラベルエラーまたは一時的侵害後の復旧と考えられる。

### 論文への示唆

> 「Stage1のFN 1,928件のうち、観測可能な特徴を持たない1,311件（68%）から160件をサンプリングしてGoogle Safe Browsingで検証した結果、現在もunsafeと判定されるのはわずか1.9%であった。これは(1)ラベルエラー、(2)時間的変化（サイトの無害化）、(3)一時的侵害後の復旧のいずれかを示唆している。」

### WHOIS検証（ドメイン登録日）

GSB検証に加え、WHOISによるドメイン登録日の確認を実施。新しいドメインはフィッシング目的で取得された可能性が高く、古いドメインはラベルエラーまたは一時的侵害の可能性が高い。

#### 結果

| ドメイン経過期間 | 件数 | 割合 | 解釈 |
|------------------|------|------|------|
| < 6ヶ月 | 9 | 7.9% | フィッシング疑い高 |
| 6-12ヶ月 | 42 | 36.8% | 中程度 |
| 1-5年 | 32 | 28.0% | 低リスク |
| **5年以上** | 31 | **27.2%** | **ラベルエラーの可能性高** |
| 削除済み | 42 | 26.3% | サイト消滅 |

#### GSBとの相関

| GSB判定 | 新規(<1年) | 長期運営(>=1年) |
|---------|------------|-----------------|
| safe | 40 | 45 |
| unsafe | 1 | 0 |
| unknown | 10 | 18 |

- GSBで「unsafe」の`tianxiqianhe.com`は**113日前**に登録（典型的なフィッシングパターン）
- 5年以上運営のドメイン例：`nkgw.net`(25年), `foxwilmar.com`(23年), `keishitanaka.com`(14年)

### 総合分析

| 検証手段 | 結果 | 示唆 |
|----------|------|------|
| GSB | 1.9%のみunsafe | 大半はラベルエラーまたは復旧済み |
| WHOIS | 27.2%が5年以上 | 長期運営サイトの一時侵害またはラベルエラー |
| DNS | 76.7%が解決可能 | 多くのドメインがまだ存在 |
| HTTP | 大半が接続不可 | ホスティングは停止済み |

### 分析データの保存先

`docs/analysis/fn_gsb_verification/`
- `featureless_fn_gsb_full.csv` - GSB検証結果
- `featureless_fn_whois.csv` - WHOIS検証結果
- `README.md` - 分析概要

---

## 「特徴ありFN」のGSB検証

### 背景

ユーザーの質問「XGBoostでFNになったデータ全部チェックしなくて大丈夫ですか？」を受け、「特徴なしFN」（160件サンプル）に加えて「特徴ありFN」（617件全数）のGSB検証を追加実施した。

### 「特徴ありFN」の定義

以下のいずれかの特徴を持つFN：
- 危険TLD（.cn, .top, .icu, .cc, .lat 等）
- ブランドキーワード検出
- 高エントロピー（ランダム文字列）
- 短いドメイン（< 8文字）

### GSB検証結果（特徴ありFN 617件）

| GSB判定 | 件数 | 割合 |
|---------|------|------|
| safe | 400 | 64.8% |
| unknown | 192 | 31.1% |
| **unsafe** | **25** | **4.1%** |

### 特徴なしFNとの比較

| 検証対象 | N | unsafe | unsafe率 |
|----------|---|--------|----------|
| 特徴なしFN（サンプル） | 160 | 3 | 1.9% |
| **特徴ありFN（全数）** | **617** | **25** | **4.1%** |

**重要な発見**: 特徴ありFNのunsafe率（4.1%）は、特徴なしFN（1.9%）の**約2.2倍**。

### unsafe 25件の分析

#### 特徴分布

| 特徴 | 件数 | 割合 |
|------|------|------|
| dangerous_tld | 8 | 32.0% |
| short_domain | 7 | 28.0% |
| has_brand | 1 | 4.0% |
| high_entropy | 0 | 0.0% |

#### ソース別unsafe率

| ソース | unsafe | 全体 | unsafe率 |
|--------|--------|------|----------|
| phishtank | 15 | 305 | 4.9% |
| certificates | 3 | 83 | 3.6% |
| jpcert | 7 | 229 | 3.1% |

### 解釈

1. **観測可能な特徴 = より信頼性の高いラベル**: 危険TLD、短いドメイン等の特徴を持つFNは「真のフィッシング」である可能性が高い
2. **特徴なしFN = ラベルエラー率が高い**: 観測可能な特徴がないFNの多くは、ラベルエラーまたは一時侵害後の復旧
3. **PhishTankの精度が最も高い**: ソース別ではPhishTankのunsafe率（4.9%）が最も高く、crowdsourcedな検証の有効性を示唆

### 論文での使用（更新版）

> 「Stage1のFN 1,928件を「観測可能な特徴を持たない」1,311件（68%）と「何らかの特徴を持つ」617件（32%）に分類し、Google Safe Browsingで検証した。
>
> 特徴なしFNからサンプリングした160件のうち、現在もunsafeと判定されるのはわずか1.9%（3件）であった。一方、特徴ありFN 617件全数を検証したところ、4.1%（25件）がunsafeと判定された。
>
> この差異（1.9% vs 4.1%）は、観測可能な特徴（危険TLD、ブランド偽装等）を持つFNは「真のフィッシング」である可能性が高く、特徴を持たないFNの多くは(1)ラベルエラー、(2)時間的変化（サイトの無害化）、(3)一時的侵害後の復旧のいずれかであることを示唆している。」

### 追加ファイル

- `docs/analysis/fn_gsb_verification/featured_fn_for_check.csv` - 特徴ありFNデータ（617件）
- `docs/analysis/fn_gsb_verification/featured_fn_gsb_results.csv` - GSB検証結果（617件）

---

## 複数ソースによるFN外部検証

### 背景

GSB単独での検証では不十分と判断し、URLScan.ioおよびPhishing.Databaseを追加して3ソースでのクロス検証を実施した。

### 検証ソース

1. **Google Safe Browsing (GSB)**: Playwright経由でGoogle Transparency Reportを自動チェック
2. **URLScan.io**: API経由でスキャン結果を検索（API Key取得済み）
3. **Phishing.Database**: GitHubから最新のアクティブフィッシングリスト（436,842ドメイン）をダウンロードして照合
4. **PhishTank API**: checkurl API経由でデータベース照合
5. **OpenPhish**: フィードダウンロード照合（300件、リアルタイム）

### 結果

| 検証ソース | 検出 | 対象 | 検出率 |
|------------|------|------|--------|
| GSB | 28 | 777 | 3.6% |
| URLScan.io | 0 | 28 | 0% |
| **Phishing.Database** | **131** | **1,927** | **6.8%** |
| PhishTank API | 0 | 28 | 0% |
| OpenPhish | 0 | 1,927 | 0% |

### 興味深い発見

1. **GSBとPhishing.Databaseの両方で検出されたドメインはわずか2件**
   - `jsft.dk`
   - `segurobradescodental.com.br`

2. **URLScan.ioはGSB unsafeを1件も検出せず**
   - 検出基準・検査タイミングの違いが大きい

3. **Phishing.Databaseで最も高い検出率（6.8%）**
   - PhishTank由来のデータで11.2%の一致率
   - コミュニティ運営のリストがより広範なカバレッジ

### ソース別のPhishing.Database一致率

| ソース | 一致/全体 | 一致率 |
|--------|-----------|--------|
| phishtank | 87/780 | 11.2% |
| jpcert | 37/844 | 4.4% |
| certificates | 7/304 | 2.3% |

### 結論

- **FN全体の7-10%が「真のフィッシング」の可能性**
- **残り90%以上はラベルエラーまたは時間的変化**
- **検証ソースによって判定基準が大きく異なる**ことが判明
- 複数ソースでの確認は2件のみ = 高い信頼性で「真のフィッシング」と言えるのはごくわずか

### 作成したスクリプト

- `scripts/check_urlscan.py` - URLScan.io API検証ツール
- `scripts/check_phishtank.py` - PhishTank API検証ツール

---

## 次のステップ

- [ ] 統合テストの追加（ポリシーバイパス再発防止）
- [ ] TLDリストの一元管理検討
- [ ] FP削減のためのルール微調整（特に.shop, .xyzの精度改善）
- [ ] Stage2 handoff全体での再評価
- [ ] GSB検証の拡大（unsafe 3件の詳細調査）
- [ ] ラベル品質の定量評価

## 作成したテストスクリプト

- `scripts/test_ai_agent_high_risk_tld.py` - 210件の高リスクTLDテスト
- `scripts/test_ai_agent_sample.py` - 50件サンプルテスト
- `scripts/debug_policy_trace.py` - ポリシーロジックのデバッグ用
- `scripts/quick_test_policy.py` - クイック検証用
- `scripts/check_gsb_playwright.py` - Google Safe Browsing自動チェック（Playwright使用）
