# 研究日誌 2026-02-01

## 本日の作業

1. 全件評価（15,630件）完了確認
2. 進捗報告書の作成・更新
3. FN/FP詳細分析（トレードオフ評価）

---

## 1. 全件評価完了

### 評価結果

| Worker | 担当件数 | 完了 | 失敗 | 処理時間 |
|--------|---------|------|------|---------|
| Worker 0 | 5,715 | 5,715 | 0 | 12.9h |
| Worker 1 | 6,361 | 6,361 | 0 | 12.5h |
| Worker 2 | 3,594 | 3,554 | 40 | 11.7h |

**合計**: 15,630件（タイムアウト40件）

### Stage3評価結果（handoff候補 15,670件）

| 指標 | 値 |
|------|-----|
| **F1 Score** | **68.70%** |
| Precision | 72.81% |
| Recall | 65.02% |
| TP | 1,781 |
| FP | 665 |
| FN | 958 |
| TN | 12,266 |

### システム全体性能（127,754件）

**システム全体の混同行列**:
```
                      Predicted
                   Benign    Phishing
Actual  Benign     63,210       667 (FP)
       Phishing     1,484    62,393 (TP)
```

**システム全体の主要指標**:

| 指標 | 値 |
|------|-----|
| **Accuracy** | **98.32%** |
| **Precision** | **98.94%** |
| **Recall** | **97.68%** |
| **F1 Score** | **98.31%** |
| FNR (見逃し率) | 2.32% |
| FPR (誤検出率) | 1.04% |

**Stage1単体との比較**:

| 指標 | Stage1単体 | 3段階システム | 変化 |
|------|-----------|-------------|------|
| Recall | 97.30% | 97.68% | **+0.37pp** |
| FNR | 2.70% | 2.32% | **-0.37pp** |
| FN件数 | 1,723 | 1,484 | **-239件** |
| Precision | 99.49% | 98.94% | -0.55pp |
| FP件数 | 317 | 667 | +350件 |

**TP/FP/TN/FN内訳**:

| 項目 | 件数 | 内訳 |
|------|------|------|
| TP | 62,393 | Stage1: 60,612 + Stage3: 1,781 |
| FP | 667 | Stage1: 2 + Stage3: 665 |
| TN | 63,210 | Stage1: 6,158 + Stage2: 44,786 + Stage3: 12,266 |
| FN | 1,484 | Stage1: 8 + Stage2: 518 + Stage3: 958 |

**トレードオフ**: FNを239件削減、FPが350件増加

---

## 2. 進捗報告書作成

`docs/reports/202602_progress_report_draft.md` を作成・更新。

### 追加セクション

- **セクション2: 主要な成果**
  - FNR 14%削減（2.70% → 2.32%）
  - 効率的な3段階設計（Stage3負荷74%削減）
  - 「自信を持って間違える」問題への対応
  - マルチGPU並列処理（2.9倍高速化）

### コミット

- `60006c3` Add key achievements section and multi-GPU processing details

---

## 3. FN/FP詳細分析

### 3.1 分析目的

- FP削減がFN増加につながるかの検証
- チューニング可能な領域の特定
- 許容すべき限界の明確化

### 3.2 カテゴリ別特性（Stage3評価分）

| Category | Count | ML Mean | CTX Mean | 特徴 |
|----------|-------|---------|----------|------|
| **TP** | 1,781 | 0.719 | 0.512 | 高ML + 高CTX |
| **FP** | 665 | 0.314 | 0.435 | 低ML + 中CTX |
| **TN** | 12,266 | 0.085 | 0.131 | 低ML + 低CTX |
| **FN** | 958 | 0.191 | 0.256 | 低ML + 低CTX |

### 3.3 ルール別 TP/FP 比

| Rule | TP | FP | TP/FP比 | 評価 |
|------|-----|-----|---------|------|
| very_high_ml_override | 804 | 37 | **21.7** | 優良 |
| ml_no_mitigation_gate | 1,384 | 199 | **7.0** | 優良 |
| soft_ctx_trigger | 292 | 106 | 2.8 | 良好 |
| brand_cert_high | 228 | 218 | **1.0** | 要注意 |
| policy_r4 | 304 | 432 | **0.7** | 問題 |

### 3.4 ブランドマッチタイプ別

| Type | TP | FP | TP/FP比 | 評価 |
|------|-----|-----|---------|------|
| substring | 90 | 50 | 1.80 | 許容 |
| compound | 68 | 60 | 1.13 | 許容 |
| **fuzzy** | 72 | 107 | **0.67** | 問題 |
| **fuzzy2** | 42 | 92 | **0.46** | 問題 |

**発見**: fuzzy/fuzzy2 マッチは FP > TP であり、削減対象として適切

### 3.5 POST_LLM_FLIP_GATE の役割

| Category | GATE発火 | 割合 |
|----------|---------|------|
| TP | 0 | 0.0% |
| FP | 0 | 0.0% |
| **TN** | **1,003** | **8.2%** |
| FN | 111 | 11.7% |

**重要**: GATEはTN 1,003件を保護している。緩和すると大幅FP増加のリスク。

---

## 4. トレードオフシミュレーション

### シナリオ1: fuzzy/fuzzy2 無効化（推奨）

| 指標 | 現状 | 変更後 | 差分 |
|------|------|--------|------|
| TP | 1,781 | 1,746 | -35 |
| FP | 665 | 558 | **-107** |
| Precision | 72.81% | 75.78% | **+2.97pp** |
| Recall | 65.33% | 64.05% | -1.28pp |
| F1 | 68.87% | 69.42% | **+0.55pp** |

**評価**: Precision向上、F1微増。推奨。

### シナリオ2: POST_LLM_FLIP_GATE 緩和（非推奨）

| リスク | 値 |
|--------|-----|
| FN救済 | +111 |
| FP増加 | **+1,003** |

**評価**: FP増加リスクが大きすぎる。非推奨。

### シナリオ3: policy_r4 無効化（非推奨）

| リスク | 値 |
|--------|-----|
| FP削減 | -432 |
| TP損失 | **-304** |

**評価**: TP損失が大きすぎる。非推奨。

---

## 5. 結論

### 許容すべき限界

| 領域 | 件数 | 理由 |
|------|------|------|
| 極低シグナルFN | 361 (38%) | 外部脅威インテリジェンスなしでは検出不可能 |
| GATE保護TN | 1,003 | 緩和するとFP急増 |

### チューニング可能な領域

| 対策 | FP削減 | TP損失 | 純効果 |
|------|--------|--------|--------|
| fuzzy/fuzzy2 無効化 | -107 | -35 | **F1 +0.55pp** |

### 現状精度の妥当性

**F1 68.87% は以下の理由で妥当**:

1. FNの38%（361件）は原理的に検出困難
2. GATEがTN 1,003件を保護（緩和禁止）
3. fuzzy/fuzzy2調整で+0.55pp改善可能

---

## 6. 作成・更新ドキュメント

| ファイル | 内容 |
|---------|------|
| `docs/reports/202602_progress_report_draft.md` | 進捗報告書（システム全体性能追加） |
| `docs/analysis/fnfp_analysis_20260201.md` | FN/FP詳細分析レポート |
| `docs/reference/data_pipeline_guide.md` | **データパイプラインガイド (NEW)** |
| `docs/research/20260201.md` | 本研究日誌 |

---

## 7. 今後のタスク

### 優先度高

| # | タスク | 期待効果 | 状態 |
|---|--------|---------|------|
| 18 | fuzzy/fuzzy2 ブランドマッチ閾値調整 | F1 +0.55pp | **次に検討** |

### 継続タスク

| # | タスク | 状態 |
|---|--------|------|
| 9 | インラインコードの完全削除検討 | pending |
| 10 | ルールモジュールの単体テスト追加 | pending |

### 完了済み

- ✅ 全件評価（15,670件）完了
- ✅ 進捗報告書作成・更新
- ✅ FN/FP詳細分析
- ✅ トレードオフシミュレーション
- ✅ システム全体性能の算出・検証
- ✅ データパイプラインガイド作成
